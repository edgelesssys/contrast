"use strict";(self.webpackChunkcontrast_docs=self.webpackChunkcontrast_docs||[]).push([[5405],{28453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>a});var r=t(96540);const s={},o=r.createContext(s);function i(e){const n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(o.Provider,{value:n},e.children)}},32900:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"howto/workload-deployment/generate-annotations","title":"Generate policy annotations and manifest","description":"This step updates your deployment files with policy annotations and automatically generates the deployment manifest.","source":"@site/docs/howto/workload-deployment/generate-annotations.md","sourceDirName":"howto/workload-deployment","slug":"/howto/workload-deployment/generate-annotations","permalink":"/contrast/pr-preview/pr-1621/next/howto/workload-deployment/generate-annotations","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/contrast/edit/main/docs/docs/howto/workload-deployment/generate-annotations.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Enable GPU support","permalink":"/contrast/pr-preview/pr-1621/next/howto/workload-deployment/GPU-configuration"},"next":{"title":"Deploy application","permalink":"/contrast/pr-preview/pr-1621/next/howto/workload-deployment/deploy-application"}}');var s=t(74848),o=t(28453);const i={},a="Generate policy annotations and manifest",l={},c=[{value:"Applicability",id:"applicability",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"How-to",id:"how-to",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components},{TabItem:t,Tabs:r}=n;return t||p("TabItem",!0),r||p("Tabs",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"generate-policy-annotations-and-manifest",children:"Generate policy annotations and manifest"})}),"\n",(0,s.jsx)(n.p,{children:"This step updates your deployment files with policy annotations and automatically generates the deployment manifest."}),"\n",(0,s.jsx)(n.h2,{id:"applicability",children:"Applicability"}),"\n",(0,s.jsx)(n.p,{children:"This step is required for all Contrast deployments."}),"\n",(0,s.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/contrast/pr-preview/pr-1621/next/howto/cluster-setup/aks",children:"Set up cluster"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/contrast/pr-preview/pr-1621/next/howto/install-cli",children:"Install CLI"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/contrast/pr-preview/pr-1621/next/howto/workload-deployment/runtime-deployment",children:"Deploy the Contrast runtime"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/contrast/pr-preview/pr-1621/next/howto/workload-deployment/add-coordinator",children:"Add Coordinator to resources"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/contrast/pr-preview/pr-1621/next/howto/workload-deployment/deployment-file-preparation",children:"Prepare deployment files"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/contrast/pr-preview/pr-1621/next/howto/workload-deployment/TLS-configuration",children:"Configure TLS (optional)"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/contrast/pr-preview/pr-1621/next/howto/workload-deployment/GPU-configuration",children:"Enable GPU support (optional)"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"how-to",children:"How-to"}),"\n",(0,s.jsxs)(n.p,{children:["Run the ",(0,s.jsx)(n.code,{children:"generate"})," command to add the necessary components to your deployment files.\nThis will add the Contrast Initializer to every workload with the specified ",(0,s.jsx)(n.code,{children:"contrast-cc"})," runtime class\nand the Contrast Service Mesh to all workloads that have a specified configuration.\nAfter that, it will generate the ",(0,s.jsx)(n.a,{href:"/contrast/pr-preview/pr-1621/next/architecture/components/policies",children:"execution policies"})," and add them as annotations to your deployment files.\nA ",(0,s.jsx)(n.code,{children:"manifest.json"})," with the reference values of your deployment will be created."]}),"\n",(0,s.jsxs)(r,{queryString:"platform",children:[(0,s.jsx)(t,{value:"aks-clh-snp",label:"AKS",default:!0,children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values aks-clh-snp resources/\n"})})}),(0,s.jsxs)(t,{value:"k3s-qemu-snp",label:"Bare metal (SEV-SNP)",children:[(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values k3s-qemu-snp resources/\n"})}),(0,s.jsx)(n.admonition,{title:"Missing TCB values",type:"note",children:(0,s.jsxs)(n.p,{children:["On bare-metal SEV-SNP, ",(0,s.jsx)(n.code,{children:"contrast generate"})," is unable to fill in the ",(0,s.jsx)(n.code,{children:"MinimumTCB"})," values as they can vary between platforms.\nThey will have to be filled in manually.\nIf you don't know the correct values use ",(0,s.jsx)(n.code,{children:'{"BootloaderVersion":255,"TEEVersion":255,"SNPVersion":255,"MicrocodeVersion":255}'})," and observe the real values in the error messages in the following steps. This should only be done in a secure environment. Note that the values will differ between CPU models."]})})]}),(0,s.jsxs)(t,{value:"k3s-qemu-snp-gpu",label:"Bare metal (SEV-SNP, with GPU support)",children:[(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values k3s-qemu-snp-gpu resources/\n"})}),(0,s.jsx)(n.admonition,{title:"Missing TCB values",type:"note",children:(0,s.jsxs)(n.p,{children:["On bare-metal SEV-SNP, ",(0,s.jsx)(n.code,{children:"contrast generate"})," is unable to fill in the ",(0,s.jsx)(n.code,{children:"MinimumTCB"})," values as they can vary between platforms.\nThey will have to be filled in manually.\nIf you don't know the correct values use ",(0,s.jsx)(n.code,{children:'{"BootloaderVersion":255,"TEEVersion":255,"SNPVersion":255,"MicrocodeVersion":255}'})," and observe the real values in the error messages in the following steps. This should only be done in a secure environment. Note that the values will differ between CPU models."]})})]}),(0,s.jsxs)(t,{value:"k3s-qemu-tdx",label:"Bare metal (TDX)",children:[(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values k3s-qemu-tdx resources/\n"})}),(0,s.jsx)(n.admonition,{title:"Missing TCB values",type:"note",children:(0,s.jsxs)(n.p,{children:["On bare-metal TDX, ",(0,s.jsx)(n.code,{children:"contrast generate"})," is unable to fill in the ",(0,s.jsx)(n.code,{children:"MinimumTeeTcbSvn"})," and ",(0,s.jsx)(n.code,{children:"MrSeam"})," TCB values as they can vary between platforms.\nThey will have to be filled in manually.\nIf you don't know the correct values use ",(0,s.jsx)(n.code,{children:"ffffffffffffffffffffffffffffffff"})," and ",(0,s.jsx)(n.code,{children:"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"})," respectively and observe the real values in the error messages in the following steps. This should only be done in a secure environment."]})})]})]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"generate"})," command needs to pull the container images to derive policies.\nRunning ",(0,s.jsx)(n.code,{children:"generate"})," for the first time can take a while, especially if the images are large.\nIf your container registry requires authentication, you can create the necessary credentials with ",(0,s.jsx)(n.code,{children:"docker login"})," or ",(0,s.jsx)(n.code,{children:"podman login"}),".\nBe aware of the ",(0,s.jsx)(n.a,{href:"/contrast/pr-preview/pr-1621/next/architecture/features-limitations#kubernetes-features",children:"registry authentication limitation"})," on bare metal."]}),"\n",(0,s.jsx)(n.admonition,{type:"warning",children:(0,s.jsxs)(n.p,{children:["Please be aware that runtime policies currently have some blind spots. For example, they can't guarantee the starting order of containers. See the ",(0,s.jsx)(n.a,{href:"/contrast/pr-preview/pr-1621/next/architecture/features-limitations#runtime-policies",children:"current limitations"})," for more details."]})}),"\n",(0,s.jsxs)(n.p,{children:["Running ",(0,s.jsx)(n.code,{children:"contrast generate"})," for the first time creates some additional files in the working directory:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"seedshare-owner.pem"})," is required for handling the secret seed and recovering the Coordinator (see ",(0,s.jsx)(n.a,{href:"/contrast/pr-preview/pr-1621/next/architecture/secrets",children:"Secrets & recovery"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"workload-owner.pem"})," is required for manifest updates after the initial ",(0,s.jsx)(n.code,{children:"contrast set"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"rules.rego"})," and ",(0,s.jsx)(n.code,{children:"settings.json"})," are the basis for ",(0,s.jsx)(n.a,{href:"/contrast/pr-preview/pr-1621/next/architecture/components/policies",children:"runtime policies"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"layers-cache.json"})," caches container image layer information for your deployments to speed up subsequent runs of ",(0,s.jsx)(n.code,{children:"contrast generate"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"If you don't want the Contrast Initializer to automatically be added to your\nworkloads, there are two ways you can skip the Initializer injection step,\ndepending on how you want to customize your deployment."}),"\n",(0,s.jsxs)(r,{groupId:"injection",children:[(0,s.jsxs)(t,{value:"flag",label:"Command-line flag",children:[(0,s.jsxs)(n.p,{children:["You can disable the Initializer injection completely by specifying the\n",(0,s.jsx)(n.code,{children:"--skip-initializer"})," flag in the ",(0,s.jsx)(n.code,{children:"generate"})," command."]}),(0,s.jsxs)(r,{queryString:"platform",children:[(0,s.jsx)(t,{value:"aks-clh-snp",label:"AKS",default:!0,children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values aks-clh-snp --skip-initializer resources/\n"})})}),(0,s.jsx)(t,{value:"k3s-qemu-snp",label:"Bare metal (SEV-SNP)",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values k3s-qemu-snp --skip-initializer resources/\n"})})}),(0,s.jsx)(t,{value:"k3s-qemu-snp-gpu",label:"Bare metal (SEV-SNP, with GPU support)",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values k3s-qemu-snp-gpu --skip-initializer resources/\n"})})}),(0,s.jsx)(t,{value:"k3s-qemu-tdx",label:"Bare metal (TDX)",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values k3s-qemu-tdx --skip-initializer resources/\n"})})})]})]}),(0,s.jsxs)(t,{value:"annotation",label:"Per-workload annotation",children:[(0,s.jsxs)(n.p,{children:["If you want to disable the Initializer injection for a specific workload with\nthe ",(0,s.jsx)(n.code,{children:"contrast-cc"})," runtime class, you can do so by adding an annotation to the workload."]}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'metadata: # apps/v1.Deployment, apps/v1.DaemonSet, ...\n  annotations:\n    contrast.edgeless.systems/skip-initializer: "true"\n'})})]})]}),"\n",(0,s.jsxs)(n.p,{children:["When disabling the automatic Initializer injection, you can manually add the\nInitializer as a sidecar container to your workload before generating the\npolicies. Configure the workload to use the certificates written to the\n",(0,s.jsx)(n.code,{children:"contrast-secrets"})," ",(0,s.jsx)(n.code,{children:"volumeMount"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'# v1.PodSpec\nspec:\n  initContainers:\n    - env:\n        - name: COORDINATOR_HOST\n          value: coordinator-ready\n      image: "ghcr.io/edgelesssys/contrast/initializer:latest"\n      name: contrast-initializer\n      volumeMounts:\n        - mountPath: /contrast\n          name: contrast-secrets\n  volumes:\n    - emptyDir: {}\n      name: contrast-secrets\n'})})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}function p(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}}}]);