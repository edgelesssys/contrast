"use strict";(self.webpackChunkcontrast_docs=self.webpackChunkcontrast_docs||[]).push([[7656],{28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>r});var s=n(96540);const i={},a=s.createContext(i);function o(e){const t=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(a.Provider,{value:t},e.children)}},85994:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"examples/vault","title":"Vault","description":"This tutorial guides you through deploying a Vault as a confidential deployment by using Contrast\'s built-in Vault support.","source":"@site/versioned_docs/version-1.10/examples/vault.md","sourceDirName":"examples","slug":"/examples/vault","permalink":"/contrast/pr-preview/pr-1587/examples/vault","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/contrast/edit/main/docs/versioned_docs/version-1.10/examples/vault.md","tags":[],"version":"1.10","frontMatter":{},"sidebar":"docs","previous":{"title":"Encrypted volume mount","permalink":"/contrast/pr-preview/pr-1587/examples/mysql"},"next":{"title":"Workload deployment","permalink":"/contrast/pr-preview/pr-1587/deployment"}}');var i=n(74848),a=n(28453);const o={},r="Vault",l={},c=[{value:"Sealing and Unsealing of Vaults",id:"sealing-and-unsealing-of-vaults",level:2},{value:"Transit secrets engine API of Contrast Coordinator",id:"transit-secrets-engine-api-of-contrast-coordinator",level:2},{value:"Secure endpoints with mutual TLS",id:"secure-endpoints-with-mutual-tls",level:3},{value:"Role of <code>workloadSecretID</code>",id:"role-of-workloadsecretid",level:3},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Steps to deploy Vault with Contrast",id:"steps-to-deploy-vault-with-contrast",level:2},{value:"Download the deployment files",id:"download-the-deployment-files",level:3},{value:"Deploy the Contrast runtime",id:"deploy-the-contrast-runtime",level:3},{value:"Download the Contrast Coordinator resource",id:"download-the-contrast-coordinator-resource",level:3},{value:"Generate policy annotations and manifest",id:"generate-policy-annotations-and-manifest",level:3},{value:"Deploy the Coordinator",id:"deploy-the-coordinator",level:3},{value:"Set the manifest",id:"set-the-manifest",level:3},{value:"Deploy Vault",id:"deploy-vault",level:3},{value:"Connecting to the application",id:"connecting-to-the-application",level:3},{value:"Restarting the Vault deployment with auto-unsealing",id:"restarting-the-vault-deployment-with-auto-unsealing",level:3}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components},{TabItem:n,Tabs:s}=t;return n||u("TabItem",!0),s||u("Tabs",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"vault",children:"Vault"})}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"This tutorial guides you through deploying a Vault as a confidential deployment by using Contrast's built-in Vault support."})}),"\n",(0,i.jsx)(t.p,{children:"Vaults are an identity-based secrets and encryption management systems, which provide encryption services that are gated by authentication and authorization methods to ensure secure, auditable and restricted access to secrets, such as API keys, passwords, encryption keys or certificates."}),"\n",(0,i.jsxs)(t.p,{children:["There are several implementations of Vault systems, the most prominent being ",(0,i.jsx)(t.a,{href:"https://www.hashicorp.com/en/products/vault",children:"HashiCorp Vault"})," and its open-source derivative, ",(0,i.jsx)(t.a,{href:"https://openbao.org/",children:"OpenBao"}),". This example utilizes the Vault image provided by OpenBao.\nThe associated APIs exposed by the Contrast coordinator are fully compatible with both HashiCorp Vault and OpenBao, ensuring interoperability across implementations."]}),"\n",(0,i.jsx)(t.p,{children:"Contrast can lift a Vault deployment into a confidential computing environment, further shielding the secrets from the workload operator."}),"\n",(0,i.jsx)(t.h2,{id:"sealing-and-unsealing-of-vaults",children:"Sealing and Unsealing of Vaults"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://openbao.org/docs/concepts/seal/",children:"Sealing"})," ensures that all sensitive data within the Vault remains inaccessible and protected when the system isn't in active use.\nIt provides a security boundary that prevents unauthorized access during restarts or shutdowns."]}),"\n",(0,i.jsxs)(t.p,{children:["Unsealing is a manual process required to transition Vault into an operational state, allowing authorized access to stored secrets.\nVault implementations by default use a set of unseal keys derived from a master key, building up on ",(0,i.jsx)(t.code,{children:"Shamir's Secret Sharing"})," scheme.\nFurther to auto-unseal Vaults, the process can be delegated to another already initialized Vault by using an exposed ",(0,i.jsx)(t.a,{href:"https://openbao.org/api-docs/secret/transit/",children:"transit secrets engine API"})," as the unsealing mechanism."]}),"\n",(0,i.jsx)(t.h2,{id:"transit-secrets-engine-api-of-contrast-coordinator",children:"Transit secrets engine API of Contrast Coordinator"}),"\n",(0,i.jsx)(t.p,{children:"To automate the unsealing process in confidential deployments of Vault instances, the coordinator exposes a compatible transit secrets engine API on port 8200.\nVault deployments can be configured to integrate this transit engine to enable auto-unsealing, ensuring immediate operational readiness and seamless integration within the secure Contrast environment."}),"\n",(0,i.jsx)(t.h3,{id:"secure-endpoints-with-mutual-tls",children:"Secure endpoints with mutual TLS"}),"\n",(0,i.jsxs)(t.p,{children:["All communication between the transit secrets engine API and Vault is secured through mutual TLS (mTLS).\nOnly entities presenting a ",(0,i.jsx)(t.a,{href:"/contrast/pr-preview/pr-1587/architecture/certificates#usage-of-the-different-certificates",children:"mesh certificate"})," signed by the current mesh CA key are trusted.\nThe Coordinator issues itself a valid certificate at the time of the transit secrets engine API call, while the Vault deployment obtains its certificate in the initialization phase, after attesting to the Coordinator."]}),"\n",(0,i.jsxs)(t.h3,{id:"role-of-workloadsecretid",children:["Role of ",(0,i.jsx)(t.code,{children:"workloadSecretID"})]}),"\n",(0,i.jsxs)(t.p,{children:["To support persistence in the auto-unsealing process, the ",(0,i.jsx)(t.code,{children:"workloadSecretID"})," is used to derive the encryption key utilized by the transit secrets engine.\nBeyond key derivation, the ",(0,i.jsx)(t.code,{children:"workloadSecretID"})," also plays a critical role in authorization."]}),"\n",(0,i.jsxs)(t.p,{children:["Access to a specific encryption key via the transit secrets engine API is permitted only if the requested key name matches the ",(0,i.jsx)(t.code,{children:"workloadSecretID"})," embedded in the corresponding certificate extension of the Contrast mesh certificate.\nThis ensures that each entity can only access their own set of encryption keys within the transit secrets engine."]}),"\n",(0,i.jsxs)(t.p,{children:["For more details on how the workload secret is used, see ",(0,i.jsx)(t.a,{href:"/contrast/pr-preview/pr-1587/architecture/secrets#workload-secrets",children:"Workload Secrets"}),"."]}),"\n",(0,i.jsx)(t.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Installed Contrast CLI"}),"\n",(0,i.jsxs)(t.li,{children:["A running Kubernetes cluster with support for confidential containers, either on ",(0,i.jsx)(t.a,{href:"/contrast/pr-preview/pr-1587/getting-started/cluster-setup",children:"AKS"})," or on ",(0,i.jsx)(t.a,{href:"/contrast/pr-preview/pr-1587/getting-started/bare-metal",children:"bare metal"})]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"steps-to-deploy-vault-with-contrast",children:"Steps to deploy Vault with Contrast"}),"\n",(0,i.jsx)(t.h3,{id:"download-the-deployment-files",children:"Download the deployment files"}),"\n",(0,i.jsx)(t.p,{children:"The Vault deployment files are part of the Contrast release. You can download them by running:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sh",children:"curl -fLO https://github.com/edgelesssys/contrast/releases/download/v1.10.0/vault-demo.yml --create-dirs --output-dir deployment\n"})}),"\n",(0,i.jsx)(t.h3,{id:"deploy-the-contrast-runtime",children:"Deploy the Contrast runtime"}),"\n",(0,i.jsxs)(t.p,{children:["Contrast depends on a ",(0,i.jsxs)(t.a,{href:"/contrast/pr-preview/pr-1587/components/runtime",children:["custom Kubernetes ",(0,i.jsx)(t.code,{children:"RuntimeClass"})]}),", which needs to be installed to the cluster initially.\nThis consists of a ",(0,i.jsx)(t.code,{children:"RuntimeClass"})," resource and a ",(0,i.jsx)(t.code,{children:"DaemonSet"})," that performs installation on worker nodes.\nThis step is only required once for each version of the runtime.\nIt can be shared between Contrast deployments."]}),"\n",(0,i.jsxs)(s,{queryString:"platform",children:[(0,i.jsx)(n,{value:"aks-clh-snp",label:"AKS",default:!0,children:(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sh",children:"kubectl apply -f https://github.com/edgelesssys/contrast/releases/download/v1.10.0/runtime-aks-clh-snp.yml\n"})})}),(0,i.jsx)(n,{value:"k3s-qemu-snp",label:"Bare metal (SEV-SNP)",children:(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sh",children:"kubectl apply -f https://github.com/edgelesssys/contrast/releases/download/v1.10.0/runtime-k3s-qemu-snp.yml\n"})})}),(0,i.jsx)(n,{value:"k3s-qemu-tdx",label:"Bare metal (TDX)",children:(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sh",children:"kubectl apply -f https://github.com/edgelesssys/contrast/releases/download/v1.10.0/runtime-k3s-qemu-tdx.yml\n"})})})]}),"\n",(0,i.jsx)(t.h3,{id:"download-the-contrast-coordinator-resource",children:"Download the Contrast Coordinator resource"}),"\n",(0,i.jsx)(t.p,{children:"Download the Kubernetes resource of the Contrast Coordinator, comprising a single replica deployment and a LoadBalancer service.\nPut it next to your resources:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sh",children:"curl -fLO https://github.com/edgelesssys/contrast/releases/download/v1.10.0/coordinator.yml --output-dir deployment\n"})}),"\n",(0,i.jsx)(t.h3,{id:"generate-policy-annotations-and-manifest",children:"Generate policy annotations and manifest"}),"\n",(0,i.jsxs)(t.p,{children:["Run the ",(0,i.jsx)(t.code,{children:"generate"})," command to generate the execution policies and add them as annotations to your deployment files.\nA ",(0,i.jsx)(t.code,{children:"manifest.json"})," file with the reference values of your deployment will be created:"]}),"\n",(0,i.jsxs)(s,{queryString:"platform",children:[(0,i.jsx)(n,{value:"aks-clh-snp",label:"AKS",default:!0,children:(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sh",children:"contrast generate --reference-values aks-clh-snp deployment/\n"})})}),(0,i.jsxs)(n,{value:"k3s-qemu-snp",label:"Bare metal (SEV-SNP)",children:[(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sh",children:"contrast generate --reference-values k3s-qemu-snp deployment/\n"})}),(0,i.jsx)(t.admonition,{title:"Missing TCB values",type:"note",children:(0,i.jsxs)(t.p,{children:["On bare-metal SEV-SNP, ",(0,i.jsx)(t.code,{children:"contrast generate"})," is unable to fill in the ",(0,i.jsx)(t.code,{children:"MinimumTCB"})," values as they can vary between platforms.\nThey will have to be filled in manually.\nIf you don't know the correct values use ",(0,i.jsx)(t.code,{children:'{"BootloaderVersion":255,"TEEVersion":255,"SNPVersion":255,"MicrocodeVersion":255}'})," and observe the real values in the error messages in the following steps.\nThis should only be done in a secure environment.\nNote that the values will differ between CPU models."]})})]}),(0,i.jsxs)(n,{value:"k3s-qemu-tdx",label:"Bare metal (TDX)",children:[(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sh",children:"contrast generate --reference-values k3s-qemu-tdx deployment/\n"})}),(0,i.jsx)(t.admonition,{title:"Missing TCB values",type:"note",children:(0,i.jsxs)(t.p,{children:["On bare-metal TDX, ",(0,i.jsx)(t.code,{children:"contrast generate"})," is unable to fill in the ",(0,i.jsx)(t.code,{children:"MinimumTeeTcbSvn"})," and ",(0,i.jsx)(t.code,{children:"MrSeam"})," TCB values as they can vary between platforms.\nThey will have to be filled in manually.\nIf you don't know the correct values use ",(0,i.jsx)(t.code,{children:"ffffffffffffffffffffffffffffffff"})," and ",(0,i.jsx)(t.code,{children:"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"})," respectively and observe the real values in the error messages in the following steps.\nThis should only be done in a secure environment."]})})]})]}),"\n",(0,i.jsx)(t.admonition,{title:"Runtime class and Initializer",type:"note",children:(0,i.jsxs)(t.p,{children:["The deployment YAML shipped for this demo is already configured to be used with Contrast.\nA ",(0,i.jsx)(t.a,{href:"../components/runtime",children:"runtime class"})," ",(0,i.jsx)(t.code,{children:"contrast-cc"})," was added to the pods to signal they should be run as Confidential Containers.\nDuring the generation process, the Contrast ",(0,i.jsx)(t.a,{href:"/contrast/pr-preview/pr-1587/components/overview#the-initializer",children:"Initializer"})," will be added as an init container to these workloads.\nIt will attest the pod to the Coordinator and fetch the workload certificates and the workload secret."]})}),"\n",(0,i.jsx)(t.h3,{id:"deploy-the-coordinator",children:"Deploy the Coordinator"}),"\n",(0,i.jsx)(t.p,{children:"Deploy the Coordinator resource first by applying its resource definition:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sh",children:"kubectl apply -f deployment/coordinator.yml\n"})}),"\n",(0,i.jsx)(t.h3,{id:"set-the-manifest",children:"Set the manifest"}),"\n",(0,i.jsx)(t.p,{children:"Configure the Coordinator with a manifest.\nIt might take up to a few minutes for the load balancer to be created and the Coordinator being available."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sh",children:'coordinator=$(kubectl get svc coordinator -o=jsonpath=\'{.status.loadBalancer.ingress[0].ip}\')\necho "The user API of your Contrast Coordinator is available at $coordinator:1313"\ncontrast set -c "${coordinator}:1313" deployment/\n'})}),"\n",(0,i.jsx)(t.p,{children:"The CLI will use the reference values from the manifest to attest the Coordinator deployment during the TLS handshake.\nIf the connection succeeds, it's ensured that the Coordinator deployment hasn't been tampered with."}),"\n",(0,i.jsx)(t.h3,{id:"deploy-vault",children:"Deploy Vault"}),"\n",(0,i.jsx)(t.p,{children:"Now that the Coordinator has a manifest set, which defines the Vault deployment as an allowed workload, we can deploy the application:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sh",children:"kubectl apply -f deployment/\n"})}),"\n",(0,i.jsxs)(t.p,{children:["The Vault deployment is defined as a StatefulSet using the OpenBao Vault image, with a mounted block device for persistent storage.\nA Contrast Initializer, running as an init container, uses the workload secret located at ",(0,i.jsx)(t.code,{children:"/contrast/secrets/workload-secret-seed"})," to generate an encryption key and initialize the block device as a LUKS-encrypted partition.\nBefore the Vault container starts, the Initializer opens the LUKS device using the generated key.\nThis unlocked device is then mounted by the Vault container and used as the backend storage volume.\nFor the Vault application, this process is entirely transparent, and the device behaves like a standard volume mount.\nIt\u2019s important to clarify that the LUKS encryption of the block device is primarily a convenience feature, enabling persistent storage at the filesystem level on confidential virtual machines.\nThe primary and security-relevant encryption mechanism remains Vault\u2019s own sealing process, which provides cryptographic protection of secrets even if the underlying storage is compromised."]}),"\n",(0,i.jsxs)(t.p,{children:["Because the ",(0,i.jsx)(t.code,{children:"workload-secret-seed"})," is derived from the associated ",(0,i.jsx)(t.code,{children:"workloadSecretID"}),", any change to the ",(0,i.jsx)(t.code,{children:"workloadSecretID"})," after the block device has been initialized will result in deriving an invalid encryption key, making the mounted block device undecryptable."]}),"\n",(0,i.jsx)(t.admonition,{title:"Inter-deployment communication",type:"note",children:(0,i.jsxs)(t.p,{children:["The Contrast Coordinator issues mesh certificates after successfully validating workloads.\nThese certificates can be used for secure inter-deployment communication.\nThe Initializer sends an attestation report to the Coordinator, retrieves a service mesh certificate bound to it's provided public key, containing the certificate chain, as well as the current mesh CA cert.\nThe Initializer then writes them to a ",(0,i.jsx)(t.code,{children:"volumeMount"}),", allowing to build up the secure mTLS connections based on the service mesh.\nThe received service mesh certificate also holds the certificate extension of the ",(0,i.jsx)(t.code,{children:"workloadSecretID"}),", which is used to allow the authorization to a certain encryption key on the transit engine API."]})}),"\n",(0,i.jsxs)(t.p,{children:["The Vault's TCP listener is configured to accept connections only from mesh certificates issued under the same CA state used to sign the Vault\u2019s own certificate, effectively restricting communication to attested Contrast deployments.\nBecause updating the ",(0,i.jsx)(t.code,{children:"workloadSecretID"})," after initializing the LUKS device will make it inaccessible, it's critical to ensure that the ",(0,i.jsx)(t.code,{children:"workloadSecretID"})," is correctly aligned with the intended endpoint specified in Vault\u2019s sealing configuration before the first ",(0,i.jsx)(t.code,{children:"contrast set"})," is executed.\nThis can be achieved by using the corresponding ",(0,i.jsx)(t.code,{children:"workload-secret-id"})," annotation to directly overwrite the manifest with the required ",(0,i.jsx)(t.code,{children:"workloadSecretID"}),"."]}),"\n",(0,i.jsx)(t.h3,{id:"connecting-to-the-application",children:"Connecting to the application"}),"\n",(0,i.jsxs)(t.p,{children:["Other confidential containers can securely connect to the Vault server via the ",(0,i.jsx)(t.a,{href:"/contrast/pr-preview/pr-1587/components/service-mesh",children:"Service Mesh"}),".\nAs previously noted, access to the Vault endpoint is restricted to peers that present a service mesh certificate valid under the currently set manifest.\nWhile such a certificate enables mTLS-based communication with the Vault server, it doesn't, on its own, grant authorization to perform Vault-related operations.\nPermissions for accessing secrets within Vault must be explicitly configured using the root token obtained during Vault initialization.\nThe configured ",(0,i.jsx)(t.code,{children:"openbao-client"})," deployment is responsible for executing Vault-related operations, including initialization, secret creation, and sealing instructions."]}),"\n",(0,i.jsxs)(t.p,{children:["For more information on the Vault management and administration, please follow the official ",(0,i.jsx)(t.a,{href:"https://openbao.org/docs/",children:"OpenBao documentation"}),"."]}),"\n",(0,i.jsx)(t.h3,{id:"restarting-the-vault-deployment-with-auto-unsealing",children:"Restarting the Vault deployment with auto-unsealing"}),"\n",(0,i.jsxs)(t.p,{children:["If you want to make changes to your resources, ensure that the ",(0,i.jsx)(t.code,{children:"workloadSecretID"})," of the Vault remains unchanged.\nYou can restart the Vault using:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sh",children:"kubectl rollout restart statefulset/vault\n"})}),"\n",(0,i.jsx)(t.p,{children:"When a new Vault pod starts, it runs the Contrast Initializer as part of its startup sequence.\nThe Initializer receives the same workload secret as before, allowing it to derive the correct encryption key and unlock the existing LUKS-encrypted block device.\nThis process ensures that the Vault backend can reattach the previously encrypted volume and access all stored data transparently.\nHowever, while this step enables access to the filesystem-level storage, it doesn't unlock access to the actual secrets.\nOnce Vault has been initialized, subsequent restarts rely on the auto-unsealing process, which is triggered via the transit secrets engine API provided by the Coordinator."}),"\n",(0,i.jsxs)(t.p,{children:["You can verify that the auto-unsealing process completed successful by inspecting the logs of the ",(0,i.jsx)(t.code,{children:"openbao-server"})," container of the Vault pod:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sh",children:"kubectl logs vault-0 -c openbao-server\n"})}),"\n",(0,i.jsx)(t.p,{children:"The log entries will indicate that the Vault has transitioned into unsealed state."})]})}function h(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}function u(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}}}]);