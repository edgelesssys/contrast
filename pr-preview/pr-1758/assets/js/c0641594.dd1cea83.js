"use strict";(self.webpackChunkcontrast_docs=self.webpackChunkcontrast_docs||[]).push([[2113],{28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>a});var r=n(96540);const o={},s=r.createContext(o);function i(e){const t=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),r.createElement(s.Provider,{value:t},e.children)}},58549:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>p,frontMatter:()=>i,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"howto/encrypted-storage","title":"Set up encrypted persistent storage","description":"This section guides you through the process of configuring encrypted persistent storage for your application.","source":"@site/docs/howto/encrypted-storage.md","sourceDirName":"howto","slug":"/howto/encrypted-storage","permalink":"/contrast/pr-preview/pr-1758/next/howto/encrypted-storage","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/contrast/edit/main/docs/docs/howto/encrypted-storage.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Recover Contrast coordinator","permalink":"/contrast/pr-preview/pr-1758/next/howto/workload-deployment/recover-coordinator"},"next":{"title":"Hardening","permalink":"/contrast/pr-preview/pr-1758/next/howto/hardening"}}');var o=n(74848),s=n(28453);const i={},a="Set up encrypted persistent storage",c={},l=[{value:"Applicability",id:"applicability",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"How-to",id:"how-to",level:2},{value:"Configuration",id:"configuration",level:3},{value:"Applying the configuration",id:"applying-the-configuration",level:3},{value:"Verifying the deployment",id:"verifying-the-deployment",level:2},{value:"Example application: MySQL",id:"example-application-mysql",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.header,{children:(0,o.jsx)(t.h1,{id:"set-up-encrypted-persistent-storage",children:"Set up encrypted persistent storage"})}),"\n",(0,o.jsx)(t.p,{children:"This section guides you through the process of configuring encrypted persistent storage for your application."}),"\n",(0,o.jsx)(t.h2,{id:"applicability",children:"Applicability"}),"\n",(0,o.jsx)(t.p,{children:"This step is recommended for any Contrast deployment that stores sensitive data persistently."}),"\n",(0,o.jsx)(t.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"/contrast/pr-preview/pr-1758/next/howto/cluster-setup/bare-metal",children:"Set up your cluster"})}),"\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"/contrast/pr-preview/pr-1758/next/howto/install-cli",children:"Install CLI"})}),"\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"/contrast/pr-preview/pr-1758/next/howto/workload-deployment/runtime-deployment",children:"Deploy the Contrast runtime"})}),"\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"/contrast/pr-preview/pr-1758/next/howto/workload-deployment/set-manifest",children:"Add Coordinator to resources"})}),"\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"/contrast/pr-preview/pr-1758/next/howto/workload-deployment/deployment-file-preparation",children:"Prepare deployment files"})}),"\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"/contrast/pr-preview/pr-1758/next/howto/workload-deployment/generate-annotations",children:"Generate annotations and manifest"})}),"\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"/contrast/pr-preview/pr-1758/next/howto/workload-deployment/deploy-application",children:"Deploy application"})}),"\n"]}),"\n",(0,o.jsx)(t.h2,{id:"how-to",children:"How-to"}),"\n",(0,o.jsxs)(t.p,{children:["The following demonstrates how to set up an encrypted LUKS mount for an arbitrary ",(0,o.jsx)(t.code,{children:"/mount/path"})," directory to easily deploy an application with encrypted persistent storage using Contrast."]}),"\n",(0,o.jsx)(t.h3,{id:"configuration",children:"Configuration"}),"\n",(0,o.jsxs)(t.p,{children:["Add a ",(0,o.jsx)(t.code,{children:"volume"})," to your pod or stateful set (called ",(0,o.jsx)(t.code,{children:"mount-name"})," in the example configuration below)\nwhich references your encrypted, persistent storage device either through one of the ",(0,o.jsx)(t.a,{href:"https://kubernetes.io/docs/concepts/storage/persistent-volumes/#raw-block-volume-support",children:"supported volume types"}),".\nTo your application container, add a ",(0,o.jsx)(t.code,{children:"volumeMount"})," with the ",(0,o.jsx)(t.code,{children:"mount-name"})," used for the ",(0,o.jsx)(t.code,{children:"volume"}),".\nThis ",(0,o.jsx)(t.code,{children:"volumeMount"})," ",(0,o.jsx)(t.strong,{children:"must"})," be of type ",(0,o.jsx)(t.code,{children:"emptyDir"}),"."]}),"\n",(0,o.jsxs)(t.p,{children:["Additionally, make your persistent volume claim or iSCSI device available to the deployment; the example below uses a PVC ",(0,o.jsx)(t.code,{children:"1Gi"})," in size.\nGive the device a name (the example uses ",(0,o.jsx)(t.code,{children:"device-name"}),")."]}),"\n",(0,o.jsxs)(t.p,{children:["Finally, add the ",(0,o.jsx)(t.a,{href:"/contrast/pr-preview/pr-1758/next/architecture/k8s-yaml-elements",children:"Contrast annotation"})," ",(0,o.jsx)(t.code,{children:"contrast.edgeless.systems/secure-pv"})," with value ",(0,o.jsx)(t.code,{children:"device-name:mount-name"}),"."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-yaml",children:"spec: # v1.StatefulSetSpec\n  template:\n    metadata:\n      annotations:\n        contrast.edgeless.systems/secure-pv: device-name:mount-name\n    spec:\n      containers:\n      - volumeMounts:\n        - mountPath: /mount/path\n          mountPropagation: HostToContainer\n          name: mount-name\n      volumes:\n      - emptyDir: {}\n        name: mount-name\n  volumeClaimTemplates:\n  - apiVersion: v1\n    kind: PersistentVolumeClaim\n    metadata:\n      name: device-name\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      resources:\n        requests:\n          storage: 1Gi\n      volumeMode: Block\n"})}),"\n",(0,o.jsxs)(t.p,{children:["The presence of this annotation instructs an init container running ",(0,o.jsx)(t.code,{children:"cryptsetup"}),"\nto use the workload secret at ",(0,o.jsx)(t.code,{children:"/contrast/secrets/workload-secret-seed"})," to generate\na key and setup the block device as a LUKS partition. Before starting the application container,\nthe init container uses the generated key to open the LUKS device, which is then mounted\nby the application container. For the application container, this process is completely\ntransparent and works like mounting any other volume. The ",(0,o.jsx)(t.code,{children:"cryptsetup"})," container\nwill remain running to provide the necessary decryption context for the workload\ncontainer."]}),"\n",(0,o.jsx)(t.admonition,{title:"Persistent workload secrets",type:"note",children:(0,o.jsxs)(t.p,{children:["During the initialization process of the workload pod, the Contrast Initializer\nsends an attestation report to the Coordinator and receives a ",(0,o.jsx)(t.a,{href:"/contrast/pr-preview/pr-1758/next/architecture/secrets#workload-secrets",children:"workload secret"}),"\nderived from the Coordinator's secret seed and the workload secret ID specified in the\nmanifest, and writes it to a secure in-memory ",(0,o.jsx)(t.code,{children:"volumeMount"}),"."]})}),"\n",(0,o.jsx)(t.h3,{id:"applying-the-configuration",children:"Applying the configuration"}),"\n",(0,o.jsx)(t.p,{children:"To make the changes take effect, reapply your deployment:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-sh",children:"contrast generate resources/\nkubectl apply -f resources/\ncontrast set resources/\n"})}),"\n",(0,o.jsx)(t.h2,{id:"verifying-the-deployment",children:"Verifying the deployment"}),"\n",(0,o.jsxs)(t.p,{children:["In many scenarios, users may require assurance of an application's security and integrity before interacting with it\u2014for example, prior to submitting sensitive data or casting a vote.\nUsers of an app may want to verify its security and identity before sharing data by writing it to the persistent volume.\nPlease see ",(0,o.jsx)(t.a,{href:"/contrast/pr-preview/pr-1758/next/getting-started/deployment#7-verify-deployment",children:"this section"})," of the documentation for more information on this topic."]}),"\n",(0,o.jsx)(t.h2,{id:"example-application-mysql",children:"Example application: MySQL"}),"\n",(0,o.jsxs)(t.p,{children:["The above guide can be tried out with a ",(0,o.jsx)(t.a,{href:"https://mysql.com",children:"MySQL"})," sample deployment which is part of the contrast release.\nYou can add the deployment file to your resources by running:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-sh",children:"curl -fLO https://github.com/edgelesssys/contrast/releases/latest/download/mysql-demo.yml --output-dir resources\n"})}),"\n",(0,o.jsxs)(t.p,{children:["MySQL is an open-source database used to organize data into\ntables and quickly retrieve information about its content. All of the data in a\nMySQL database is stored in the ",(0,o.jsx)(t.code,{children:"/var/lib/mysql"})," directory. In this example, we\nuse the workload secret to setup an encrypted LUKS mount for the\n",(0,o.jsx)(t.code,{children:"/var/lib/mysql"})," directory to easily deploy an application with encrypted\npersistent storage using Contrast."]}),"\n",(0,o.jsxs)(t.p,{children:["The resources provided in this demo are designed for educational purposes and\nshouldn't be used in a production environment without proper evaluation. When\nworking with persistent storage, regular backups are recommended in order to\nprevent data loss. For confidential applications, please also refer to the\n",(0,o.jsx)(t.a,{href:"/contrast/pr-preview/pr-1758/next/howto/hardening",children:"security considerations"}),". Also be\naware of the differences in security implications of the workload secrets for\nthe data owner and the workload owner. For more details, see the ",(0,o.jsx)(t.a,{href:"/contrast/pr-preview/pr-1758/next/architecture/secrets#workload-secrets",children:"Workload\nSecrets"})," documentation."]}),"\n",(0,o.jsxs)(t.p,{children:["The MySQL deployment is defined as a ",(0,o.jsx)(t.code,{children:"StatefulSet"}),", with a storage setup analogous to what has been described above."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-yaml",children:"apiVersion: apps/v1\nkind: StatefulSet\nspec:\n  template:\n    metadata:\n      annotations:\n        contrast.edgeless.systems/secure-pv: state:share\n    spec:\n      containers:\n      - volumeMounts:\n        - mountPath: /var/lib/mysql\n          mountPropagation: HostToContainer\n          name: share\n      volumes:\n      - emptyDir: {}\n        name: share\n  volumeClaimTemplates:\n  - apiVersion: v1\n    kind: PersistentVolumeClaim\n    metadata:\n      name: state\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      resources:\n        requests:\n          storage: 1Gi\n      volumeMode: Block\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Follow ",(0,o.jsx)(t.a,{href:"#applying-the-configuration",children:"the steps given above"})," to reapply your configuration."]}),"\n",(0,o.jsxs)(t.admonition,{title:"Runtime class and Initializer",type:"note",children:[(0,o.jsxs)(t.p,{children:["The deployment YAML shipped for this demo is already configured to be used with Contrast.\nA ",(0,o.jsx)(t.a,{href:"../architecture/components/runtime",children:"runtime class"})," ",(0,o.jsx)(t.code,{children:"contrast-cc"}),"\nwas added to the pods to signal they should be run as Confidential Containers. During the generation process,\nthe Contrast ",(0,o.jsx)(t.a,{href:"/contrast/pr-preview/pr-1758/next/architecture/components/initializer",children:"Initializer"})," will be added as an init container to these\nworkloads. It will attest the pod to the Coordinator and fetch the workload certificates and the workload secret."]}),(0,o.jsxs)(t.p,{children:["Further, the deployment YAML is also configured with the Contrast ",(0,o.jsx)(t.a,{href:"/contrast/pr-preview/pr-1758/next/architecture/components/service-mesh",children:"service mesh"}),".\nThe configured service mesh proxy provides transparent protection for the communication between\nthe MySQL server and client."]})]})]})}function p(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}}}]);