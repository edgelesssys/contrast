"use strict";(self.webpackChunkcontrast_docs=self.webpackChunkcontrast_docs||[]).push([[8071],{28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var s=t(96540);const i={},o=s.createContext(i);function r(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(o.Provider,{value:n},e.children)}},29014:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"getting-started/deployment","title":"Workload deployment","description":"Follow these steps to make your deployment confidential.","source":"@site/docs/getting-started/deployment.md","sourceDirName":"getting-started","slug":"/getting-started/deployment","permalink":"/contrast/pr-preview/pr-1791/next/getting-started/deployment","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/contrast/edit/main/docs/docs/getting-started/deployment.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Overview","permalink":"/contrast/pr-preview/pr-1791/next/getting-started/overview"},"next":{"title":"Bare metal","permalink":"/contrast/pr-preview/pr-1791/next/howto/cluster-setup/bare-metal"}}');var i=t(74848),o=t(28453);const r={},a="Workload deployment",c={},l=[{value:"1. Adjust deployment files",id:"1-adjust-deployment-files",level:2},{value:"Download the demo deployment configuration",id:"download-the-demo-deployment-configuration",level:3},{value:"Set the RuntimeClass",id:"set-the-runtimeclass",level:3},{value:"Define pod resources",id:"define-pod-resources",level:3},{value:"Add service mesh annotations",id:"add-service-mesh-annotations",level:3},{value:"Traffic flow in this setup:",id:"traffic-flow-in-this-setup",level:4},{value:"Enable egress mTLS from <code>web</code> to <code>emoji</code> and <code>voting</code>",id:"enable-egress-mtls-from-web-to-emoji-and-voting",level:4},{value:"Enable ingress mTLS at <code>emoji</code> and <code>voting</code>",id:"enable-ingress-mtls-at-emoji-and-voting",level:4},{value:"Enable ingress for external HTTPS traffic",id:"enable-ingress-for-external-https-traffic",level:4},{value:"2. Install the Contrast runtime",id:"2-install-the-contrast-runtime",level:2},{value:"3. Add the Contrast Coordinator to the deployment",id:"3-add-the-contrast-coordinator-to-the-deployment",level:2},{value:"4. Generate policy annotations and manifest",id:"4-generate-policy-annotations-and-manifest",level:2},{value:"5. Deploy application",id:"5-deploy-application",level:2},{value:"6. Connect to Coordinator and set manifest",id:"6-connect-to-coordinator-and-set-manifest",level:2},{value:"7. Verify deployment",id:"7-verify-deployment",level:2},{value:"Verifying the Coordinator",id:"verifying-the-coordinator",level:3},{value:"Auditing the manifest and policies",id:"auditing-the-manifest-and-policies",level:3},{value:"8. Connect securely to the frontend",id:"8-connect-securely-to-the-frontend",level:2},{value:"Optional: Updating the certificate SAN and the manifest",id:"optional-updating-the-certificate-san-and-the-manifest",level:2},{value:"Adding an IP SAN to the manifest",id:"adding-an-ip-san-to-the-manifest",level:3},{value:"Updating the manifest on the coordinator",id:"updating-the-manifest-on-the-coordinator",level:3},{value:"Restarting workloads",id:"restarting-workloads",level:3},{value:"Verifying the connection",id:"verifying-the-connection",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components},{TabItem:t,Tabs:s}=n;return t||m("TabItem",!0),s||m("Tabs",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"workload-deployment",children:"Workload deployment"})}),"\n",(0,i.jsx)(n.p,{children:"Follow these steps to make your deployment confidential."}),"\n",(0,i.jsx)(n.h2,{id:"1-adjust-deployment-files",children:"1. Adjust deployment files"}),"\n",(0,i.jsx)(n.h3,{id:"download-the-demo-deployment-configuration",children:"Download the demo deployment configuration"}),"\n",(0,i.jsx)(n.p,{children:"Download the Kubernetes resources for the emojivoto deployment with the following command:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"curl -fLO https://github.com/edgelesssys/contrast/releases/latest/download/emojivoto-demo.yml --create-dirs --output-dir resources\n"})}),"\n",(0,i.jsx)(n.p,{children:"This deployment has already been prepared for Contrast.\nIn the following sub-sections, we will explain the changes made to the original deployment file."}),"\n",(0,i.jsx)(n.h3,{id:"set-the-runtimeclass",children:"Set the RuntimeClass"}),"\n",(0,i.jsxs)(n.p,{children:["In each pod configuration, set the ",(0,i.jsx)(n.code,{children:"runtimeClassName"})," field under ",(0,i.jsx)(n.code,{children:"spec"})," to ",(0,i.jsx)(n.code,{children:"contrast-cc"}),".\nThis tells Kubernetes to run the pod inside a Confidential Virtual Machine (CVM) using the Contrast runtime."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-diff",metastring:'title="resources/emojivoto-demo.yaml"',children:"@@ -36,6 +36,7 @@\n             periodSeconds: 5\n             tcpSocket:\n               port: 8080\n+      runtimeClassName: contrast-cc\n       serviceAccountName: emoji\n ---\n apiVersion: v1\n@@ -86,6 +87,7 @@\n               value: web-svc:443\n           image: ghcr.io/edgelesssys/contrast/emojivoto-web:coco-1@sha256:0fd9bf6f7dcb99bdb076144546b663ba6c3eb457cbb48c1d3fceb591d207289c\n           name: vote-bot\n+      runtimeClassName: contrast-cc\n ---\n apiVersion: apps/v1\n kind: Deployment\n@@ -125,6 +127,7 @@\n             periodSeconds: 5\n             tcpSocket:\n               port: 8080\n+      runtimeClassName: contrast-cc\n       serviceAccountName: voting\n ---\n apiVersion: v1\n@@ -188,6 +191,7 @@\n               scheme: HTTPS\n             initialDelaySeconds: 1\n             periodSeconds: 5\n+      runtimeClassName: contrast-cc\n       serviceAccountName: web\n ---\n apiVersion: v1\n"})}),"\n",(0,i.jsxs)(n.p,{children:["For more details, see ",(0,i.jsx)(n.a,{href:"/contrast/pr-preview/pr-1791/next/howto/workload-deployment/deployment-file-preparation#runtimeclass",children:'RuntimeClass Section in the "Prepare deployment files" how-to'}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"define-pod-resources",children:"Define pod resources"}),"\n",(0,i.jsx)(n.p,{children:"Each Contrast workload runs inside its own CVM.\nTo ensure accurate memory allocation, Contrast requires strict resource definitions:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Always specify both memory ",(0,i.jsx)(n.code,{children:"requests"})," and ",(0,i.jsx)(n.code,{children:"limits"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["The values for ",(0,i.jsx)(n.code,{children:"requests"})," and ",(0,i.jsx)(n.code,{children:"limits"})," must be identical."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["On bare-metal platforms, the container images are pulled from within each pod-VM.\nBy default, images are stored on an encrypted ephemeral disk through the ",(0,i.jsx)(n.a,{href:"/contrast/pr-preview/pr-1791/next/howto/secure-image-store",children:"Contrast secure image store"})," feature.\nIf this feature is disabled, the images are stored in encrypted memory instead.\nIn this case, the uncompressed image size needs to be added to the memory limits of containers."]}),"\n",(0,i.jsxs)(n.p,{children:["Kubernetes schedules pods on nodes based on the memory ",(0,i.jsx)(n.code,{children:"requests"}),".\nTo prevent Kubernetes from over-commiting nodes, set both ",(0,i.jsx)(n.code,{children:"request"})," and ",(0,i.jsx)(n.code,{children:"limit"})," to the same value."]}),"\n",(0,i.jsx)(n.p,{children:"Set both to 400Mi for each pod in this example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-diff",metastring:'title="resources/emojivoto-demo.yaml"',children:"@@ -36,6 +36,11 @@\n             periodSeconds: 5\n             tcpSocket:\n               port: 8080\n+          resources:\n+            limits:\n+              memory: 400Mi\n+            requests:\n+              memory: 400Mi\n       runtimeClassName: contrast-cc\n       serviceAccountName: emoji\n ---\n@@ -87,6 +92,11 @@\n               value: web-svc:443\n           image: ghcr.io/edgelesssys/contrast/emojivoto-web:coco-1@sha256:0fd9bf6f7dcb99bdb076144546b663ba6c3eb457cbb48c1d3fceb591d207289c\n           name: vote-bot\n+          resources:\n+            limits:\n+              memory: 400Mi\n+            requests:\n+              memory: 400Mi\n       runtimeClassName: contrast-cc\n ---\n apiVersion: apps/v1\n@@ -127,6 +137,11 @@\n             periodSeconds: 5\n             tcpSocket:\n               port: 8080\n+          resources:\n+            limits:\n+              memory: 400Mi\n+            requests:\n+              memory: 400Mi\n       runtimeClassName: contrast-cc\n       serviceAccountName: voting\n ---\n@@ -191,6 +206,11 @@\n               scheme: HTTPS\n             initialDelaySeconds: 1\n             periodSeconds: 5\n+          resources:\n+            limits:\n+              memory: 400Mi\n+            requests:\n+              memory: 400Mi\n       runtimeClassName: contrast-cc\n       serviceAccountName: web\n ---\n"})}),"\n",(0,i.jsxs)(n.p,{children:["For details, see the ",(0,i.jsx)(n.a,{href:"/contrast/pr-preview/pr-1791/next/howto/workload-deployment/deployment-file-preparation#pod-resources",children:"pod resources how-to"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"add-service-mesh-annotations",children:"Add service mesh annotations"}),"\n",(0,i.jsxs)(n.p,{children:["Contrast provides its own PKI based on attestation.\nThe ",(0,i.jsx)(n.strong,{children:"Contrast Coordinator"}),", a service deployed alongside your workloads, acts as both:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The central remote attestation service."}),"\n",(0,i.jsx)(n.li,{children:"A certificate authority (CA) that issues certificates to verified pods."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"By adding specific annotations to your pod definitions, you enable an automatic service mesh for encrypted and authenticated pod-to-pod communication."}),"\n",(0,i.jsx)(n.h4,{id:"traffic-flow-in-this-setup",children:"Traffic flow in this setup:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsxs)(n.strong,{children:["From ",(0,i.jsx)(n.code,{children:"web"})," to ",(0,i.jsx)(n.code,{children:"emoji"})," and ",(0,i.jsx)(n.code,{children:"voting"}),":"]}),"\ngRPC calls are tunneled via mTLS using mesh certificates."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsxs)(n.strong,{children:["From external clients to ",(0,i.jsx)(n.code,{children:"web"}),":"]}),"\nHTTPS is used. Clients don't need to present a mesh certificate but can verify ",(0,i.jsx)(n.code,{children:"web"}),"\u2019s certificate."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsxs)(n.strong,{children:[(0,i.jsx)(n.code,{children:"vote-bot"})," as a simulated client:"]}),"\nSimulates external clients with HTTPS requests."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.h4,{id:"enable-egress-mtls-from-web-to-emoji-and-voting",children:["Enable egress mTLS from ",(0,i.jsx)(n.code,{children:"web"})," to ",(0,i.jsx)(n.code,{children:"emoji"})," and ",(0,i.jsx)(n.code,{children:"voting"})]}),"\n",(0,i.jsxs)(n.p,{children:["Add the following annotation to the ",(0,i.jsx)(n.code,{children:"web"})," pod to define egress rules:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"contrast.edgeless.systems/servicemesh-egress: emoji#127.137.0.1:8081#emoji-svc:8080##voting#127.137.0.2:8081#voting-svc:8080\n"})}),"\n",(0,i.jsx)(n.p,{children:"The format of this annotation is:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"<name>#<chosen IP>:<chosen port>#<original-hostname-or-ip>:<original-port>\n"})}),"\n",(0,i.jsx)(n.p,{children:"Where:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"<name>"})," is an internal label for the target service."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"<chosen IP>:<chosen port>"})," is a local address that your application uses."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"<original-hostname-or-ip>:<original-port>"})," is the actual destination the traffic should reach."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Multiple entries are separated by ",(0,i.jsx)(n.code,{children:"##"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Contrast\u2019s service mesh deploys a local Envoy proxy at ",(0,i.jsx)(n.code,{children:"<chosen IP>:<chosen port>"})," within each pod. To direct outbound traffic through the mesh, you must configure your application to connect to that proxy address instead of ",(0,i.jsx)(n.code,{children:"<original-hostname-or-ip>:<original-port>"}),"."]}),"\n",(0,i.jsxs)(n.h4,{id:"enable-ingress-mtls-at-emoji-and-voting",children:["Enable ingress mTLS at ",(0,i.jsx)(n.code,{children:"emoji"})," and ",(0,i.jsx)(n.code,{children:"voting"})]}),"\n",(0,i.jsx)(n.p,{children:"Add the following annotation to both pods:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'contrast.edgeless.systems/servicemesh-ingress: ""\n'})}),"\n",(0,i.jsx)(n.p,{children:"Setting this annotation to an empty string enables automatic verification of incoming mTLS connections.\nIf the annotation is omitted entirely, no ingress verification will take place."}),"\n",(0,i.jsx)(n.h4,{id:"enable-ingress-for-external-https-traffic",children:"Enable ingress for external HTTPS traffic"}),"\n",(0,i.jsx)(n.p,{children:"Add this annotation to allow HTTPS ingress without requiring client certificates:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"contrast.edgeless.systems/servicemesh-ingress: web#8080#false\n"})}),"\n",(0,i.jsx)(n.p,{children:"This configuration exempts port 8080 from mTLS verification: clients can connect to 8080 without presenting a client certificate, while all other ports still require full mTLS"}),"\n",(0,i.jsx)(n.p,{children:"Altogether, we can configure the service mesh by adding the following annotations:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-diff",metastring:'title="resources/emojivoto-demo.yaml"',children:'@@ -14,6 +14,8 @@ spec:\n       version: v11\n   template:\n     metadata:\n+      annotations:\n+        contrast.edgeless.systems/servicemesh-ingress: ""\n       labels:\n         app.kubernetes.io/name: emoji-svc\n         version: v11\n@@ -115,6 +117,8 @@ spec:\n       version: v11\n   template:\n     metadata:\n+      annotations:\n+        contrast.edgeless.systems/servicemesh-ingress: ""\n       labels:\n         app.kubernetes.io/name: voting-svc\n         version: v11\n@@ -181,6 +185,9 @@ spec:\n       version: v11\n   template:\n     metadata:\n+      annotations:\n+        contrast.edgeless.systems/servicemesh-egress: emoji#127.137.0.1:8081#emoji-svc:8080##voting#127.137.0.2:8081#voting-svc:8080\n+        contrast.edgeless.systems/servicemesh-ingress: web#8080#false\n       labels:\n         app.kubernetes.io/name: web-svc\n         version: v11\n'})}),"\n",(0,i.jsx)(n.p,{children:"These are all the changes you need to make to your deployment files."}),"\n",(0,i.jsx)(n.h2,{id:"2-install-the-contrast-runtime",children:"2. Install the Contrast runtime"}),"\n",(0,i.jsx)(n.p,{children:"Next, install the Contrast runtime in your cluster which will be used when setting up CVMs on nodes."}),"\n",(0,i.jsxs)(s,{queryString:"platform",children:[(0,i.jsx)(t,{value:"metal-qemu-snp",label:"Bare metal (SEV-SNP)",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"kubectl apply -f https://github.com/edgelesssys/contrast/releases/latest/download/runtime-metal-qemu-snp.yml\n"})})}),(0,i.jsx)(t,{value:"metal-qemu-tdx",label:"Bare metal (TDX)",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"kubectl apply -f https://github.com/edgelesssys/contrast/releases/latest/download/runtime-metal-qemu-tdx.yml\n"})})})]}),"\n",(0,i.jsx)(n.h2,{id:"3-add-the-contrast-coordinator-to-the-deployment",children:"3. Add the Contrast Coordinator to the deployment"}),"\n",(0,i.jsx)(n.p,{children:"The Contrast Coordinator is an additional service that runs alongside your application and ensures the deployment remains in a secure and trusted state by attesting all workload pods."}),"\n",(0,i.jsx)(n.p,{children:"Download the Kubernetes resource of the Contrast Coordinator, comprising a single replica deployment and a LoadBalancer service.\nPut it next to your resources:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"curl -fLO https://github.com/edgelesssys/contrast/releases/latest/download/coordinator.yml --output-dir resources\n"})}),"\n",(0,i.jsx)(n.h2,{id:"4-generate-policy-annotations-and-manifest",children:"4. Generate policy annotations and manifest"}),"\n",(0,i.jsxs)(n.p,{children:["Run the ",(0,i.jsx)(n.code,{children:"generate"})," command to create execution policies that strictly control communication between the host and CVMs on each worker node and define which workloads are allowed to run. These policies are automatically added as annotations to your deployment files."]}),"\n",(0,i.jsxs)(n.p,{children:["The command also generates a ",(0,i.jsx)(n.code,{children:"manifest.json"})," file, which contains the trusted reference values of your deployment."]}),"\n",(0,i.jsxs)(s,{queryString:"platform",children:[(0,i.jsxs)(t,{value:"metal-qemu-snp",label:"Bare metal (SEV-SNP)",children:[(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-snp resources/\n"})}),(0,i.jsxs)(n.p,{children:["On bare-metal SEV-SNP, ",(0,i.jsx)(n.code,{children:"contrast generate"})," is unable to fill in the ",(0,i.jsx)(n.code,{children:"MinimumTCB"})," values as they can vary between platforms and CPU models.\nThey will have to be filled in manually."]}),(0,i.jsxs)(n.p,{children:["If you don't know the values from the firmware you installed, you can use the ",(0,i.jsx)(n.a,{href:"https://github.com/virtee/snphost",children:(0,i.jsx)(n.code,{children:"snphost"})})," tool to retrieve the current TCB."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"snphost show tcb\n"})}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-console",children:"Reported TCB: TCB Version:\n  Microcode:   72\n  SNP:         23\n  TEE:         0\n  Boot Loader: 9\n  FMC:         None\nPlatform TCB: TCB Version:\n  Microcode:   72\n  SNP:         23\n  TEE:         0\n  Boot Loader: 9\n  FMC:         None\n"})}),(0,i.jsxs)(n.p,{children:["Use the values from ",(0,i.jsx)(n.code,{children:"Platform TCB"})," to fill in the ",(0,i.jsx)(n.code,{children:"MinimumTCB"})," values in the generated ",(0,i.jsx)(n.code,{children:"manifest.json"})," file."]}),(0,i.jsx)(n.admonition,{title:"Attention!",type:"note",children:(0,i.jsx)(n.p,{children:"This must be done on a trusted machine, with a secure and trusted connection to it."})})]}),(0,i.jsxs)(t,{value:"metal-qemu-snp-gpu",label:"Bare metal (SEV-SNP, with GPU support)",children:[(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-snp-gpu resources/\n"})}),(0,i.jsxs)(n.p,{children:["On bare-metal SEV-SNP, ",(0,i.jsx)(n.code,{children:"contrast generate"})," is unable to fill in the ",(0,i.jsx)(n.code,{children:"MinimumTCB"})," values as they can vary between platforms and CPU models.\nThey will have to be filled in manually."]}),(0,i.jsxs)(n.p,{children:["If you don't know the values from the firmware you installed, you can use the ",(0,i.jsx)(n.a,{href:"https://github.com/virtee/snphost",children:(0,i.jsx)(n.code,{children:"snphost"})})," tool to retrieve the current TCB."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"snphost show tcb\n"})}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-console",children:"Reported TCB: TCB Version:\n  Microcode:   72\n  SNP:         23\n  TEE:         0\n  Boot Loader: 9\n  FMC:         None\nPlatform TCB: TCB Version:\n  Microcode:   72\n  SNP:         23\n  TEE:         0\n  Boot Loader: 9\n  FMC:         None\n"})}),(0,i.jsxs)(n.p,{children:["Use the values from ",(0,i.jsx)(n.code,{children:"Platform TCB"})," to fill in the ",(0,i.jsx)(n.code,{children:"MinimumTCB"})," values in the generated ",(0,i.jsx)(n.code,{children:"manifest.json"})," file."]}),(0,i.jsx)(n.admonition,{title:"Attention!",type:"note",children:(0,i.jsx)(n.p,{children:"This must be done on a trusted machine, with a secure and trusted connection to it."})})]}),(0,i.jsxs)(t,{value:"metal-qemu-tdx",label:"Bare metal (TDX)",children:[(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-tdx resources/\n"})}),(0,i.jsxs)(n.p,{children:["On bare-metal TDX, ",(0,i.jsx)(n.code,{children:"contrast generate"})," is unable to fill in the ",(0,i.jsx)(n.code,{children:"MrSeam"})," value as it depends on your platform configuration.\nIt will have to be filled in manually."]}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"MrSeam"})," is the SHA384 hash of the TDX module. You can retrieve it by executing"]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"sha384sum /boot/efi/EFI/TDX/TDX-SEAM.so | cut -d' ' -f1\n"})}),(0,i.jsx)(n.admonition,{title:"Attention!",type:"note",children:(0,i.jsx)(n.p,{children:"This must be done on a trusted machine, with a secure and trusted connection to it."})})]})]}),"\n",(0,i.jsx)(n.h2,{id:"5-deploy-application",children:"5. Deploy application"}),"\n",(0,i.jsx)(n.p,{children:"Now deploy your application along with the Contrast coordinator:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"kubectl apply -f resources/\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The Coordinator should show a status ",(0,i.jsx)(n.code,{children:"Running"})," and will only transition to ",(0,i.jsx)(n.code,{children:"Ready"})," after a manifest has been set."]}),"\n",(0,i.jsx)(n.h2,{id:"6-connect-to-coordinator-and-set-manifest",children:"6. Connect to Coordinator and set manifest"}),"\n",(0,i.jsx)(n.p,{children:"Configure the Coordinator with the created manifest. It might take up to a few minutes\nfor the load balancer to be created and the Coordinator being available."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:'coordinator=$(kubectl get svc coordinator -o=jsonpath=\'{.status.loadBalancer.ingress[0].ip}\')\necho "The user API of your Contrast Coordinator is available at $coordinator:1313"\ncontrast set -c "${coordinator}:1313" resources/\n'})}),"\n",(0,i.jsx)(n.p,{children:"The CLI will use the reference values from the manifest to attest the Coordinator deployment\nduring the TLS handshake. If the connection succeeds, it's ensured that the Coordinator\ndeployment hasn't been tampered with."}),"\n",(0,i.jsx)(n.h2,{id:"7-verify-deployment",children:"7. Verify deployment"}),"\n",(0,i.jsx)(n.p,{children:"In many scenarios, users may require assurance of an application's security and integrity before interacting with it\u2014for example, prior to submitting sensitive data or casting a vote."}),"\n",(0,i.jsx)(n.p,{children:"Contrast enables this through a single remote attestation step, regardless of the size or complexity of the deployment.\nBy attesting the Coordinator, the user transitively attests all workloads that the Coordinator has verified or will verify according to the defined manifest."}),"\n",(0,i.jsxs)(n.p,{children:["A successful attestation of the Coordinator provides a strong guarantee that the deployment adheres to the reference values specified in the ",(0,i.jsx)(n.code,{children:"manifest.json"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"verifying-the-coordinator",children:"Verifying the Coordinator"}),"\n",(0,i.jsx)(n.p,{children:"A user can verify the Contrast deployment using the verify\ncommand:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:'contrast verify -c "${coordinator}:1313" -m manifest.json\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The CLI verifies the Coordinator via remote attestation using reference values from the provided manifest.\nThis manifest must be distributed out-of-band to all parties performing verification, as the ",(0,i.jsx)(n.code,{children:"verify"})," command checks whether the manifest currently active at the Coordinator matches the one supplied to the CLI."]}),"\n",(0,i.jsxs)(n.p,{children:["If verification succeeds, it confirms that the Coordinator is running in the expected Confidential Computing environment with the correct code version.\nThe Coordinator then returns its configuration over a secure TLS channel.\nThe CLI stores this information\u2014including the mesh root certificate (",(0,i.jsx)(n.code,{children:"mesh-ca.pem"}),"), the manifest history, and the associated policies\u2014in the ",(0,i.jsx)(n.code,{children:"verify/"})," directory."]}),"\n",(0,i.jsx)(n.h3,{id:"auditing-the-manifest-and-policies",children:"Auditing the manifest and policies"}),"\n",(0,i.jsx)(n.p,{children:"Next, the stored Coordinator configuration should be audited.\nA user\u2014or a trusted third party\u2014can review the manifest and the referenced policies to ensure they meet expectations."}),"\n",(0,i.jsx)(n.h2,{id:"8-connect-securely-to-the-frontend",children:"8. Connect securely to the frontend"}),"\n",(0,i.jsxs)(n.p,{children:["Once the Coordinator\u2019s configuration has been verified, users can securely connect to the application via HTTPS. The application uses the ",(0,i.jsx)(n.code,{children:"mesh-ca.pem"})," certificate as the root of trust. We can use this certificate to validate the frontend's certificate."]}),"\n",(0,i.jsx)(n.p,{children:"To access the web frontend, expose the service on a public IP address via a LoadBalancer service:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"frontendIP=$(kubectl get svc web-svc -o=jsonpath='{.status.loadBalancer.ingress[0].ip}')\necho \"Frontend is available at  https://$frontendIP, you can visit it in your browser.\"\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Using ",(0,i.jsx)(n.code,{children:"openssl"}),", the certificate of the service can be validated with the ",(0,i.jsx)(n.code,{children:"mesh-ca.pem"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"openssl s_client -CAfile verify/mesh-ca.pem -verify_return_error -connect ${frontendIP}:443 < /dev/null\n"})}),"\n",(0,i.jsx)(n.h2,{id:"optional-updating-the-certificate-san-and-the-manifest",children:"Optional: Updating the certificate SAN and the manifest"}),"\n",(0,i.jsxs)(n.p,{children:["By default, mesh certificates are issued with a wildcard DNS Subject Alternative Name (SAN).\nIn this demo, the web frontend is accessed via a LoadBalancer IP.\nTools like ",(0,i.jsx)(n.code,{children:"curl"})," validate certificates against SANs and will fail if the certificate doesn\u2019t include the IP address."]}),"\n",(0,i.jsxs)(n.p,{children:["For example, running ",(0,i.jsx)(n.code,{children:"curl"})," with the mesh CA certificate results in:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"$ curl --cacert ./verify/mesh-ca.pem \"https://${frontendIP}:443\"\ncurl: (60) SSL: no alternative certificate subject name matches target host name '203.0.113.34'\n"})}),"\n",(0,i.jsx)(n.h3,{id:"adding-an-ip-san-to-the-manifest",children:"Adding an IP SAN to the manifest"}),"\n",(0,i.jsxs)(n.p,{children:["To enable IP-based certificate verification, update the relevant policy in the manifest.\nAdd the ",(0,i.jsx)(n.code,{children:"frontendIP"})," to the list of SANs:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-diff",children:'   "Policies": {\n     ...\n     "99dd77cbd7fe2c4e1f29511014c14054a21a376f7d58a48d50e9e036f4522f6b": {\n       "SANs": [\n         "web",\n-        "*"\n+        "*",\n+        "203.0.113.34"\n       ],\n       "WorkloadSecretID": "web"\n     },\n'})}),"\n",(0,i.jsx)(n.h3,{id:"updating-the-manifest-on-the-coordinator",children:"Updating the manifest on the coordinator"}),"\n",(0,i.jsx)(n.p,{children:"Apply the updated manifest with:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:'contrast set -c "${coordinator}:1313" deployment/\n'})}),"\n",(0,i.jsx)(n.p,{children:"This triggers a rotation of the mesh CA certificate.\nNew certificates will be issued by the updated CA.\nPreviously issued certificates will no longer be trusted.\nThis ensures that updated workloads don\u2019t trust older, potentially vulnerable versions."}),"\n",(0,i.jsxs)(n.p,{children:["The updated ",(0,i.jsx)(n.code,{children:"mesh-ca.pem"})," will be written to reflect the new CA."]}),"\n",(0,i.jsx)(n.h3,{id:"restarting-workloads",children:"Restarting workloads"}),"\n",(0,i.jsx)(n.p,{children:"The Contrast Initializer doesn't automatically fetch new certificates after a manifest update.\nYou must manually restart the deployments to trigger certificate re-issuance:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"kubectl rollout restart deployment/emoji\nkubectl rollout restart deployment/vote-bot\nkubectl rollout restart deployment/voting\nkubectl rollout restart deployment/web\n"})}),"\n",(0,i.jsx)(n.h3,{id:"verifying-the-connection",children:"Verifying the connection"}),"\n",(0,i.jsx)(n.p,{children:"After restarting the deployments, connect securely using:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:'curl --cacert ./mesh-ca.pem "https://${frontendIP}:443"\n'})}),"\n",(0,i.jsx)(n.p,{children:"This should return the HTML content of the web frontend."})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}function m(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}}}]);