"use strict";(self.webpackChunkcontrast_docs=self.webpackChunkcontrast_docs||[]).push([[6584],{28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>a});var o=n(96540);const r={},s=o.createContext(r);function i(e){const t=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),o.createElement(s.Provider,{value:t},e.children)}},88649:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"howto/troubleshooting","title":"Troubleshooting","description":"This section provides guidance on diagnosing and resolving issues in your Contrast deployment.","source":"@site/docs/howto/troubleshooting.md","sourceDirName":"howto","slug":"/howto/troubleshooting","permalink":"/contrast/pr-preview/pr-1598/next/howto/troubleshooting","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/contrast/edit/main/docs/docs/howto/troubleshooting.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Vault","permalink":"/contrast/pr-preview/pr-1598/next/howto/vault"},"next":{"title":"Security","permalink":"/contrast/pr-preview/pr-1598/next/security"}}');var r=n(74848),s=n(28453);const i={},a="Troubleshooting",c={},d=[{value:"Related topics",id:"related-topics",level:2},{value:"<code>contrast generate</code> returns errors",id:"contrast-generate-returns-errors",level:2},{value:"Images with VOLUME declarations but without a Kubernetes mount",id:"images-with-volume-declarations-but-without-a-kubernetes-mount",level:3},{value:"Pod fails to start",id:"pod-fails-to-start",level:2},{value:"Regenerating the policies",id:"regenerating-the-policies",level:3},{value:"Pin container images",id:"pin-container-images",level:3},{value:"Validate Contrast components match",id:"validate-contrast-components-match",level:3},{value:"Contrast attempts to pull the wrong image reference",id:"contrast-attempts-to-pull-the-wrong-image-reference",level:3},{value:"VM runs out of memory",id:"vm-runs-out-of-memory",level:2},{value:"Connection to Coordinator fails",id:"connection-to-coordinator-fails",level:2}];function l(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"troubleshooting",children:"Troubleshooting"})}),"\n",(0,r.jsx)(t.p,{children:"This section provides guidance on diagnosing and resolving issues in your Contrast deployment."}),"\n",(0,r.jsx)(t.h2,{id:"related-topics",children:"Related topics"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-1598/next/howto/logging",children:"Logging"}),": How to capture useful logs from your Contrast deployment."]}),"\n"]}),"\n",(0,r.jsxs)(t.h2,{id:"contrast-generate-returns-errors",children:[(0,r.jsx)(t.code,{children:"contrast generate"})," returns errors"]}),"\n",(0,r.jsx)(t.p,{children:"Some workload configurations are known to be insecure or incompatible with Contrast.\nIf such a configuration is detected during policy generation, an error is logged and the command fails."}),"\n",(0,r.jsx)(t.h3,{id:"images-with-volume-declarations-but-without-a-kubernetes-mount",children:"Images with VOLUME declarations but without a Kubernetes mount"}),"\n",(0,r.jsxs)(t.p,{children:["During ",(0,r.jsx)(t.code,{children:"contrast generate"}),", an error like the following is printed and the process returns with a non-zero exit code:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'level=ERROR msg="The following volumes declared in image config don\'t have corresponding Kubernetes mounts: [\\"/data\\"]"\n'})}),"\n",(0,r.jsxs)(t.p,{children:["This error indicates that the container image declares a ",(0,r.jsx)(t.a,{href:"https://github.com/opencontainers/image-spec/blob/06e6b47e2ef69021d9f9bf2cfa5fe43a7e010c81/config.md?plain=1#L168-L170",children:(0,r.jsx)(t.code,{children:"VOLUME"})}),", but there is no Kubernetes volume mounted at that path (",(0,r.jsx)(t.code,{children:"/data"})," in the example).\nSince it's not clearly specified if or what a container runtime is supposed to mount in that case, all declared volumes need to have a corresponding explicit Kubernetes volume mount.\nDepending on the needs of the application, this could either be an ",(0,r.jsx)(t.a,{href:"https://kubernetes.io/docs/concepts/storage/volumes/#emptydir",children:(0,r.jsx)(t.code,{children:"emptyDir"})})," or a ",(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-1598/next/architecture/secrets#secure-persistence",children:"Contrast-managed persistent volume"}),"."]}),"\n",(0,r.jsx)(t.h2,{id:"pod-fails-to-start",children:"Pod fails to start"}),"\n",(0,r.jsxs)(t.p,{children:["If the Coordinator or a workload pod fails to even start, it can be helpful to\nlook at the events of the pod during the startup process using the ",(0,r.jsx)(t.code,{children:"describe"}),"\ncommand."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"kubectl -n <namespace> events --for pod/<coordinator-pod-name>\n"})}),"\n",(0,r.jsx)(t.p,{children:"Example output:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'LAST SEEN  TYPE     REASON  OBJECT             MESSAGE\n32m        Warning  Failed  Pod/coordinator-0  kubelet  Error: failed to create containerd task: failed to create shim task: "CreateContainerRequest is blocked by policy: ...\n'})}),"\n",(0,r.jsx)(t.p,{children:"A common error, as in this example, is that the container creation was blocked by the\npolicy. Potential reasons are a modification of the deployment YAML without updating\nthe policies afterward, or a version mismatch between Contrast components."}),"\n",(0,r.jsx)(t.h3,{id:"regenerating-the-policies",children:"Regenerating the policies"}),"\n",(0,r.jsx)(t.p,{children:"To ensure there isn't a mismatch between Kubernetes resource YAML and the annotated\npolicies, rerun"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"contrast generate\n"})}),"\n",(0,r.jsx)(t.p,{children:"on your deployment. If any of the policy annotations change, re-deploy with the updated policies."}),"\n",(0,r.jsx)(t.h3,{id:"pin-container-images",children:"Pin container images"}),"\n",(0,r.jsx)(t.p,{children:"When generating the policies, Contrast will download the images specified in your deployment\nYAML and include their cryptographic identity. If the image tag is moved to another\ncontainer image after the policy has been generated, the image downloaded at deploy time\nwill differ from the one at generation time, and the policy enforcement won't allow the\ncontainer to be started in the pod VM."}),"\n",(0,r.jsxs)(t.p,{children:["To ensure the correct image is always used, pin the container image to a fixed ",(0,r.jsx)(t.code,{children:"sha256"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"image: ubuntu:22.04@sha256:19478ce7fc2ffbce89df29fea5725a8d12e57de52eb9ea570890dc5852aac1ac\n"})}),"\n",(0,r.jsxs)(t.p,{children:["This way, the same image will still be pulled when the container tag (",(0,r.jsx)(t.code,{children:"22.04"}),") is moved\nto another image."]}),"\n",(0,r.jsx)(t.h3,{id:"validate-contrast-components-match",children:"Validate Contrast components match"}),"\n",(0,r.jsx)(t.p,{children:"A version mismatch between Contrast components can cause policy validation or attestation\nto fail. Each Contrast runtime is identifiable based on its (shortened) measurement value\nused to name the runtime class version."}),"\n",(0,r.jsx)(t.p,{children:"First, analyze which runtime class is currently installed in your cluster by running"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"kubectl get runtimeclasses\n"})}),"\n",(0,r.jsx)(t.p,{children:"This should give you output similar to the following one."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"NAME                                           HANDLER                                        AGE\ncontrast-cc-aks-clh-snp-7173acb5               contrast-cc-aks-clh-snp-7173acb5               23h\nkata-cc-isolation                              kata-cc                                        45d\n"})}),"\n",(0,r.jsx)(t.p,{children:"The output shows that there are four Contrast runtime classes installed (as well as the runtime class provided\nby the AKS CoCo preview, which isn't used by Contrast)."}),"\n",(0,r.jsx)(t.p,{children:"Next, check if the pod that won't start has the correct runtime class configured, and the\nCoordinator uses the exact same runtime:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"kubectl -n <namespace> get -o=jsonpath='{.spec.runtimeClassName}' pod/<pod-name>\nkubectl -n <namespace> get -o=jsonpath='{.spec.runtimeClassName}' pod/<coordinator-pod-name>\n"})}),"\n",(0,r.jsx)(t.p,{children:"The output should list the runtime class the pod is using:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"contrast-cc-aks-clh-snp-7173acb5\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Version information about the currently used CLI can be obtained via the ",(0,r.jsx)(t.code,{children:"version"})," flag:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"contrast --version\n"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"contrast version v1.XX.X\n\ncontainer image versions:\n    ghcr.io/edgelesssys/contrast/coordinator:v1.XX.X@sha256:...\n    ghcr.io/edgelesssys/contrast/initializer:v1.XX.X@sha256:...\n    ghcr.io/edgelesssys/contrast/service-mesh-proxy:v1.XX.X@sha256:...\n    ghcr.io/edgelesssys/contrast/node-installer-microsoft:v1.XX.X@sha256:...\n    ghcr.io/edgelesssys/contrast/node-installer-kata:v1.XX.X@sha256:...\n    ghcr.io/edgelesssys/contrast/node-installer-kata-gpu:v1.XX.X@sha256:...\n    ghcr.io/edgelesssys/contrast/tardev-snapshotter:3.2.0.azl5@sha256:...\n\nreference values for AKS-CLH-SNP platform:\n    runtime handler:      contrast-cc-aks-clh-snp-7173acb5\n    - launch digest:      6cf7f93545210549c25e4efde6878deabfb5357da1a50b0fc9126e1218d182402a5ba2400d708a3d054ba96d663a2918\n      default SNP TCB:\n          bootloader:     3\n          tee:            0\n          snp:            8\n          microcode:      115\n    genpolicy version:    3.2.0.azl5\n\nreference values for K3s-QEMU-TDX platform:\n...\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Check the output for the section with the platform you are using, for example ",(0,r.jsx)(t.code,{children:"AKS-CLH-SNP"})," or ",(0,r.jsx)(t.code,{children:"K3s-QEMU-TDX"}),".\nThe ",(0,r.jsx)(t.code,{children:"runtime handler"})," must match the runtime class name of the pod that won't start."]}),"\n",(0,r.jsx)(t.h3,{id:"contrast-attempts-to-pull-the-wrong-image-reference",children:"Contrast attempts to pull the wrong image reference"}),"\n",(0,r.jsxs)(t.p,{children:["Containerd versions before ",(0,r.jsx)(t.code,{children:"v2.0.0"})," have a bug that can lead to pulling image references that differ from the PodSpec.\nThe policy failure contains a line starting with ",(0,r.jsx)(t.code,{children:"allow_create_container_input"})," at the very top.\nThis is the request received from the runtime and subject to policy enforcement.\nThe JSON contains a list of annotations nested under ",(0,r.jsx)(t.code,{children:".OCI.Annotations"}),".\nVerify that the value for annotation key ",(0,r.jsx)(t.code,{children:"io.kubernetes.cri.image-name"})," corresponds to an image in your PodSpec.\nIf it doesn't, you need to remove that image entirely from the affected node, for example with ",(0,r.jsx)(t.code,{children:"crictl"}),"."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"crictl rmi $IMAGE\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Upstream backport that's fixing the bug is pending: ",(0,r.jsx)(t.a,{href:"https://github.com/containerd/containerd/pull/11644",children:"https://github.com/containerd/containerd/pull/11644"}),"."]}),"\n",(0,r.jsx)(t.h2,{id:"vm-runs-out-of-memory",children:"VM runs out of memory"}),"\n",(0,r.jsx)(t.p,{children:"Since pod VMs are statically sized, it's easier to run out of memory due to misconfigurations.\nSetting the right memory limits is even more important on bare metal, where the image layers need to be stored in the guest memory, too.\nIf you see an error message like this, the VM doesn't have enough space to pull images:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"LAST SEEN   TYPE      REASON      OBJECT                            MESSAGE\n2m31s       Warning   Failed      Pod/my-pod-76dc84fc75-6xn7s   Error: failed to create containerd task: failed to create shim task: failed to handle layer: hasher sha256: failed to unpack [...] No space left on device (os error 28)\n"})}),"\n",(0,r.jsxs)(t.p,{children:["This error can be resolved by increasing the memory limit of the containers, see the ",(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-1598/next/howto/workload-deployment/deployment-file-preparation#pod-resources",children:"Workload deployment"})," guide."]}),"\n",(0,r.jsx)(t.h2,{id:"connection-to-coordinator-fails",children:"Connection to Coordinator fails"}),"\n",(0,r.jsxs)(t.p,{children:["Connections from the CLI to the Coordinator may fail due to a variety of reasons.\nIf the error happens during the attested TLS handshake, it will usually be reported as an error message of the following form:\n",(0,r.jsx)(t.code,{children:'rpc error: code = <GRPC ERROR CODE> desc = connection error: desc = "<DESCRIPTION>"'}),".\nThe following table explains the reason for the error and suggests further debugging steps."]}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"Description"}),(0,r.jsx)(t.th,{children:"Cause"}),(0,r.jsx)(t.th,{children:"Next steps"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"transport: authentication handshake failed: EOF"})}),(0,r.jsx)(t.td,{children:"Connection was closed before the Coordinator could send a certificate."}),(0,r.jsx)(t.td,{children:"Check the load balancer."})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"received context error while waiting for new LB policy update: context deadline exceeded"})}),(0,r.jsx)(t.td,{children:"The Coordinator didn't send attestation documents before the deadline."}),(0,r.jsx)(t.td,{children:"Check the Coordinator logs for issuer problems."})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"transport: authentication handshake failed: remote error: tls: internal error"})}),(0,r.jsx)(t.td,{children:"Coordinator failed to issue attestation documents"}),(0,r.jsx)(t.td,{children:"Check the Coordinator logs for issuer problems."})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"transport: authentication handshake failed: no valid attestation document certificate extensions found"})}),(0,r.jsx)(t.td,{children:"Coordinator served an unexpected certificate."}),(0,r.jsx)(t.td,{children:"Check whether remote end is the Coordinator with port 1313; Compare versions of Coordinator and CLI."})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"transport: authentication handshake failed: tls: first record does not look like a TLS handshake"})}),(0,r.jsx)(t.td,{children:"Coordinator didn't serve TLS."}),(0,r.jsx)(t.td,{children:"Check whether remote end is the Coordinator with port 1313."})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"transport: Error while dialing: dial tcp <host:port>: connect: connection refused"})}),(0,r.jsx)(t.td,{children:"Coordinator port is closed."}),(0,r.jsx)(t.td,{children:"Check connectivity to the Coordinator; Check coordinator readiness; Check load balancer is pointing to the Coordinator port 1313."})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:'transport: authentication handshake failed: [...] validator tdx-0 failed: validating report data: quote field MR_CONFIG_ID is [...]. Expect [...]"'})}),(0,r.jsx)(t.td,{children:"Wrong Coordinator policy hash."}),(0,r.jsx)(t.td,{children:"Compare versions of Coordinator and CLI"})]})]})]})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}}}]);