"use strict";(self.webpackChunkcontrast_docs=self.webpackChunkcontrast_docs||[]).push([[3002],{28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>a});var o=n(96540);const r={},s=o.createContext(r);function i(e){const t=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),o.createElement(s.Provider,{value:t},e.children)}},85294:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"howto/workload-deployment/deployment-file-preparation","title":"Prepare deployment files","description":"To run your Kubernetes workloads as Confidential Containers, you\'ll need to make a few adjustments to your deployment files. This section walks you through the required changes and highlights important security considerations for your application.","source":"@site/docs/howto/workload-deployment/deployment-file-preparation.md","sourceDirName":"howto/workload-deployment","slug":"/howto/workload-deployment/deployment-file-preparation","permalink":"/contrast/pr-preview/pr-1773/next/howto/workload-deployment/deployment-file-preparation","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/contrast/edit/main/docs/docs/howto/workload-deployment/deployment-file-preparation.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Add Coordinator to resources","permalink":"/contrast/pr-preview/pr-1773/next/howto/workload-deployment/add-coordinator"},"next":{"title":"Configure TLS","permalink":"/contrast/pr-preview/pr-1773/next/howto/workload-deployment/TLS-configuration"}}');var r=n(74848),s=n(28453);const i={},a="Prepare deployment files",l={},c=[{value:"Applicability",id:"applicability",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"How-to",id:"how-to",level:2},{value:"Security review",id:"security-review",level:3},{value:"Resource backup",id:"resource-backup",level:3},{value:"RuntimeClass",id:"runtimeclass",level:3},{value:"Volumes",id:"volumes",level:3},{value:"Pod resources",id:"pod-resources",level:3}];function d(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components},{TabItem:n,Tabs:o}=t;return n||u("TabItem",!0),o||u("Tabs",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"prepare-deployment-files",children:"Prepare deployment files"})}),"\n",(0,r.jsx)(t.p,{children:"To run your Kubernetes workloads as Confidential Containers, you'll need to make a few adjustments to your deployment files. This section walks you through the required changes and highlights important security considerations for your application."}),"\n",(0,r.jsx)(t.h2,{id:"applicability",children:"Applicability"}),"\n",(0,r.jsx)(t.p,{children:"Required for all Contrast deployments."}),"\n",(0,r.jsx)(t.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-1773/next/howto/cluster-setup/bare-metal",children:"Set up cluster"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-1773/next/howto/install-cli",children:"Install CLI"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-1773/next/howto/workload-deployment/runtime-deployment",children:"Deploy the Contrast runtime"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-1773/next/howto/workload-deployment/add-coordinator",children:"Add Coordinator to resources"})}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"how-to",children:"How-to"}),"\n",(0,r.jsx)(t.p,{children:"This page explains how to update your deployment files for Contrast and outlines key security consideration for your application."}),"\n",(0,r.jsx)(t.h3,{id:"security-review",children:"Security review"}),"\n",(0,r.jsxs)(t.p,{children:["Contrast ensures integrity and confidentiality of the applications, but interactions with untrusted systems require the developers' attention.\nReview the ",(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-1773/next/howto/hardening",children:"security considerations"})," and the ",(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-1773/next/architecture/components/service-mesh#public-key-infrastructure",children:"certificates section"})," for deploying applications securely with Contrast."]}),"\n",(0,r.jsx)(t.h3,{id:"resource-backup",children:"Resource backup"}),"\n",(0,r.jsx)(t.p,{children:"Contrast will add annotations to your Kubernetes YAML files. If you want to keep the original files\nunchanged, you can copy the files into a separate local directory.\nYou can also generate files from a Helm chart or from a Kustomization."}),"\n",(0,r.jsxs)(o,{groupId:"yaml-source",children:[(0,r.jsx)(n,{value:"kustomize",label:"kustomize",children:(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"mkdir resources\nkustomize build $MY_RESOURCE_DIR > resources/all.yml\n"})})}),(0,r.jsx)(n,{value:"helm",label:"helm",children:(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"mkdir resources\nhelm template $RELEASE_NAME $CHART_NAME > resources/all.yml\n"})})}),(0,r.jsx)(n,{value:"copy",label:"copy",children:(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"cp -R $MY_RESOURCE_DIR resources/\n"})})})]}),"\n",(0,r.jsx)(t.h3,{id:"runtimeclass",children:"RuntimeClass"}),"\n",(0,r.jsxs)(t.p,{children:["To specify that a workload (pod, deployment, etc.) should be executed with Contrast,\nadd ",(0,r.jsx)(t.code,{children:"runtimeClassName: contrast-cc"})," to the pod spec (pod definition or template)."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"spec: # v1.PodSpec\n  runtimeClassName: contrast-cc\n"})}),"\n",(0,r.jsxs)(t.p,{children:["This is a placeholder name that will be replaced by a versioned ",(0,r.jsx)(t.code,{children:"runtimeClassName"})," when generating policies."]}),"\n",(0,r.jsx)(t.h3,{id:"volumes",children:"Volumes"}),"\n",(0,r.jsxs)(t.p,{children:["Contrast doesn't support sharing filesystems with the host.\nThis means that most ",(0,r.jsx)(t.a,{href:"https://kubernetes.io/docs/concepts/storage/volumes/",children:"Kubernetes volume"})," mounts aren't supported."]}),"\n",(0,r.jsxs)(t.p,{children:["The easiest and safest way to mount a persistent filesystem into a container is Contrast's ",(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-1773/next/howto/encrypted-storage",children:"secure persistent volume"})," support.\nAlternatively, you can add a persistent volume with ",(0,r.jsx)(t.a,{href:"https://kubernetes.io/docs/concepts/storage/persistent-volumes/#volume-mode",children:(0,r.jsx)(t.code,{children:"volumeMode: Block"})})," to your pod and mount it directly in your container."]}),"\n",(0,r.jsx)(t.p,{children:"The only supported filesystem volume types are:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"configMap"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"downwardAPI"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"emptyDir"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"projected"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"secret"})}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["However, the content of these volumes isn't integrity protected and must be assumed untrustworthy, except for ",(0,r.jsx)(t.code,{children:"emptyDir"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["All unsupported volume types will result in a temporary mount that's only available during the lifetime of the container.\nIf the volume mount on the host contains data (for example, mounts of type ",(0,r.jsx)(t.code,{children:"hostPath"})," or ",(0,r.jsx)(t.code,{children:"image"}),"), this data will be copied into the VM, but not written back.\nMounted UNIX domain sockets won't work in the guest container."]}),"\n",(0,r.jsx)(t.h3,{id:"pod-resources",children:"Pod resources"}),"\n",(0,r.jsxs)(t.p,{children:["Contrast workloads are deployed as one confidential virtual machine (CVM) per pod.\nThe resources provided to the CVM are static and can't be adjusted at runtime.\nIn order to configure the CVM resources correctly, Contrast workloads require a stricter specification of pod resources compared to standard ",(0,r.jsx)(t.a,{href:"https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/",children:"Kubernetes resource management"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["The total memory available to the CVM is calculated from the sum of the individual containers' memory ",(0,r.jsx)(t.code,{children:"limits"})," and a static ",(0,r.jsx)(t.code,{children:"RuntimeClass"})," overhead that accounts for services running inside the CVM.\nConsider the following abbreviated example resource definitions:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:'kind: RuntimeClass\nhandler: contrast-cc\noverhead:\n  podFixed:\n    memory: 256Mi\n---\nspec: # v1.PodSpec\n  containers:\n    - name: my-container\n      image: "my-image@sha256:..."\n      resources:\n        limits:\n          memory: 128Mi\n    - name: my-sidecar\n      image: "my-other-image@sha256:..."\n      resources:\n        limits:\n          memory: 64Mi\n'})}),"\n",(0,r.jsxs)(t.p,{children:["Contrast launches this pod as a VM with 448MiB of memory: 192MiB for the containers and 256MiB for the guest operating system.\nIn general, you don't need to care about the memory requirements of the guest system, as they're covered by the static ",(0,r.jsx)(t.code,{children:"RuntimeClass"})," overhead."]}),"\n",(0,r.jsx)(t.p,{children:"Since memory can't be shared dynamically with the host, each container should have a memory limit that covers its worst-case requirements."}),"\n",(0,r.jsxs)(t.p,{children:["Kubernetes packs a node until the sum of pod ",(0,r.jsx)(t.em,{children:"requests"})," reaches the node's total memory.\nSince a Contrast pod is always going to consume node memory according to the ",(0,r.jsx)(t.em,{children:"limits"}),", the accounting is only correct if the request is equal to the limit.\nThus, once you determined the memory requirements of your application, you should add a resource section to the pod specification with request and limit:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:'spec: # v1.PodSpec\n  containers:\n    - name: my-container\n      image: "my-image@sha256:..."\n      resources:\n        requests:\n          memory: 50Mi\n        limits:\n          memory: 50Mi\n'})}),"\n",(0,r.jsxs)(t.admonition,{type:"note",children:[(0,r.jsxs)(t.p,{children:["Container images are pulled from within the pod-VMs using the ",(0,r.jsx)(t.a,{href:"../../architecture/components/runtime#pod-vm-image",children:"Contrast image puller"}),".\nBy default, the images are pulled and uncompressed into an encrypted storage device using ",(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-1773/next/howto/secure-image-store",children:"Contrast secure image store"}),".\nIn this case, image sizes don't need to be taken into account when setting the container memory limits.\nHowever, if this feature is disabled, images will instead be pulled into encrypted memory, and the uncompressed image sizes need to be taken into account."]}),(0,r.jsxs)(t.p,{children:["Registry interfaces often show the compressed size of an image, the decompressed image is usually a factor of 2-4x larger if the content is mostly binary.\nFor example, the ",(0,r.jsx)(t.code,{children:"nginx:stable"})," image reports a compressed image size of 67MiB, but storing the uncompressed layers needs about 184MiB of memory.\nAlthough only the extracted layers are stored, and those layers are reused across containers within the same pod, the memory limit should account for both the compressed and the decompressed layer simultaneously.\nAltogether, setting the limit to 10x the compressed image size should be sufficient for small to medium images when not using the Contrast secure image store feature."]})]}),"\n",(0,r.jsx)(t.admonition,{type:"warning",children:(0,r.jsxs)(t.p,{children:["CPU limits are currently not supported and will cause measurement errors on bare metal. Be aware\nof things that might change container limits, like ",(0,r.jsx)(t.code,{children:"LimitRange"})," or pod admission controllers."]})})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}function u(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}}}]);