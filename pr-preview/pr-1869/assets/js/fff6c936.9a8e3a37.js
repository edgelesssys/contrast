"use strict";(globalThis.webpackChunkcontrast_docs=globalThis.webpackChunkcontrast_docs||[]).push([[768],{22680:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"howto/workload-deployment/generate-annotations","title":"Generate initdata annotations and manifest","description":"This step updates your deployment files with initdata annotations and automatically generates the deployment manifest.","source":"@site/versioned_docs/version-1.14/howto/workload-deployment/generate-annotations.md","sourceDirName":"howto/workload-deployment","slug":"/howto/workload-deployment/generate-annotations","permalink":"/contrast/pr-preview/pr-1869/howto/workload-deployment/generate-annotations","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/contrast/edit/main/docs/versioned_docs/version-1.14/howto/workload-deployment/generate-annotations.md","tags":[],"version":"1.14","frontMatter":{},"sidebar":"docs","previous":{"title":"Enable GPU support","permalink":"/contrast/pr-preview/pr-1869/howto/workload-deployment/GPU-configuration"},"next":{"title":"Deploy application","permalink":"/contrast/pr-preview/pr-1869/howto/workload-deployment/deploy-application"}}');var r=t(74848),a=t(28453);const s={},o="Generate initdata annotations and manifest",l={},c=[{value:"Applicability",id:"applicability",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"How-to",id:"how-to",level:2},{value:"Fine-tuning initializer injection",id:"fine-tuning-initializer-injection",level:3},{value:"<code>--skip-initializer</code> flag",id:"--skip-initializer-flag",level:4},{value:"<code>skip-initializer</code> annotation",id:"skip-initializer-annotation",level:4},{value:"Manual Initializer injection",id:"manual-initializer-injection",level:4},{value:"Fine-tuning service mesh injection",id:"fine-tuning-service-mesh-injection",level:3},{value:"<code>--skip-service-mesh</code> flag",id:"--skip-service-mesh-flag",level:4}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components},{TabItem:t,Tabs:i}=n;return t||p("TabItem",!0),i||p("Tabs",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"generate-initdata-annotations-and-manifest",children:"Generate initdata annotations and manifest"})}),"\n",(0,r.jsx)(n.p,{children:"This step updates your deployment files with initdata annotations and automatically generates the deployment manifest."}),"\n",(0,r.jsx)(n.h2,{id:"applicability",children:"Applicability"}),"\n",(0,r.jsx)(n.p,{children:"This step is required for all Contrast deployments."}),"\n",(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/contrast/pr-preview/pr-1869/howto/cluster-setup/bare-metal",children:"Set up cluster"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/contrast/pr-preview/pr-1869/howto/install-cli",children:"Install CLI"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/contrast/pr-preview/pr-1869/howto/workload-deployment/runtime-deployment",children:"Deploy the Contrast runtime"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/contrast/pr-preview/pr-1869/howto/workload-deployment/add-coordinator",children:"Add Coordinator to resources"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/contrast/pr-preview/pr-1869/howto/workload-deployment/deployment-file-preparation",children:"Prepare deployment files"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/contrast/pr-preview/pr-1869/howto/workload-deployment/TLS-configuration",children:"Configure TLS (optional)"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/contrast/pr-preview/pr-1869/howto/workload-deployment/GPU-configuration",children:"Enable GPU support (optional)"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"how-to",children:"How-to"}),"\n",(0,r.jsxs)(n.p,{children:["Run the ",(0,r.jsx)(n.code,{children:"generate"})," command to add the necessary components to your deployment files.\nThis will add the Contrast Initializer to every workload with the specified ",(0,r.jsx)(n.code,{children:"contrast-cc"})," runtime class\nand the Contrast Service Mesh to all workloads that have a specified configuration.\nAfter that, it will generate the ",(0,r.jsx)(n.a,{href:"/contrast/pr-preview/pr-1869/architecture/components/policies",children:"execution policies"}),", wrap them in initdata documents and add them as annotations to your deployment files.\nA ",(0,r.jsx)(n.code,{children:"manifest.json"})," with the reference values of your deployment will be created."]}),"\n",(0,r.jsxs)(i,{queryString:"platform",children:[(0,r.jsxs)(t,{value:"metal-qemu-snp",label:"Bare metal (SEV-SNP)",children:[(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-snp resources/\n"})}),(0,r.jsxs)(n.p,{children:["On bare-metal SEV-SNP, ",(0,r.jsx)(n.code,{children:"contrast generate"})," is unable to fill in the ",(0,r.jsx)(n.code,{children:"MinimumTCB"})," values as they can vary between platforms and CPU models.\nThey will have to be filled in manually."]}),(0,r.jsxs)(n.p,{children:["If you don't know the values from the firmware you installed, you can use the ",(0,r.jsx)(n.a,{href:"https://github.com/virtee/snphost",children:(0,r.jsx)(n.code,{children:"snphost"})})," tool to retrieve the current TCB."]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"snphost show tcb\n"})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"Reported TCB: TCB Version:\n  Microcode:   72\n  SNP:         23\n  TEE:         0\n  Boot Loader: 9\n  FMC:         None\nPlatform TCB: TCB Version:\n  Microcode:   72\n  SNP:         23\n  TEE:         0\n  Boot Loader: 9\n  FMC:         None\n"})}),(0,r.jsxs)(n.p,{children:["Use the values from ",(0,r.jsx)(n.code,{children:"Platform TCB"})," to fill in the ",(0,r.jsx)(n.code,{children:"MinimumTCB"})," values in the generated ",(0,r.jsx)(n.code,{children:"manifest.json"})," file."]}),(0,r.jsx)(n.admonition,{title:"Attention!",type:"note",children:(0,r.jsx)(n.p,{children:"This must be done on a trusted machine, with a secure and trusted connection to it."})})]}),(0,r.jsxs)(t,{value:"metal-qemu-snp-gpu",label:"Bare metal (SEV-SNP, with GPU support)",children:[(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-snp-gpu resources/\n"})}),(0,r.jsxs)(n.p,{children:["On bare-metal SEV-SNP, ",(0,r.jsx)(n.code,{children:"contrast generate"})," is unable to fill in the ",(0,r.jsx)(n.code,{children:"MinimumTCB"})," values as they can vary between platforms and CPU models.\nThey will have to be filled in manually."]}),(0,r.jsxs)(n.p,{children:["If you don't know the values from the firmware you installed, you can use the ",(0,r.jsx)(n.a,{href:"https://github.com/virtee/snphost",children:(0,r.jsx)(n.code,{children:"snphost"})})," tool to retrieve the current TCB."]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"snphost show tcb\n"})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"Reported TCB: TCB Version:\n  Microcode:   72\n  SNP:         23\n  TEE:         0\n  Boot Loader: 9\n  FMC:         None\nPlatform TCB: TCB Version:\n  Microcode:   72\n  SNP:         23\n  TEE:         0\n  Boot Loader: 9\n  FMC:         None\n"})}),(0,r.jsxs)(n.p,{children:["Use the values from ",(0,r.jsx)(n.code,{children:"Platform TCB"})," to fill in the ",(0,r.jsx)(n.code,{children:"MinimumTCB"})," values in the generated ",(0,r.jsx)(n.code,{children:"manifest.json"})," file."]}),(0,r.jsx)(n.admonition,{title:"Attention!",type:"note",children:(0,r.jsx)(n.p,{children:"This must be done on a trusted machine, with a secure and trusted connection to it."})})]}),(0,r.jsxs)(t,{value:"metal-qemu-tdx",label:"Bare metal (TDX)",children:[(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-tdx resources/\n"})}),(0,r.jsxs)(n.p,{children:["On bare-metal TDX, ",(0,r.jsx)(n.code,{children:"contrast generate"})," is unable to fill in the ",(0,r.jsx)(n.code,{children:"MrSeam"})," value as it depends on your platform configuration.\nIt will have to be filled in manually."]}),(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"MrSeam"})," is the SHA384 hash of the TDX module. You can retrieve it by executing"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"sha384sum /boot/efi/EFI/TDX/TDX-SEAM.so | cut -d' ' -f1\n"})}),(0,r.jsx)(n.admonition,{title:"Attention!",type:"note",children:(0,r.jsx)(n.p,{children:"This must be done on a trusted machine, with a secure and trusted connection to it."})})]})]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"generate"})," command needs to pull the container images to derive policies.\nRunning ",(0,r.jsx)(n.code,{children:"generate"})," for the first time can take a while, especially if the images are large.\nIf your container registry requires authentication, you can create the necessary credentials with ",(0,r.jsx)(n.code,{children:"docker login"})," or ",(0,r.jsx)(n.code,{children:"podman login"}),".\nBe aware of the ",(0,r.jsx)(n.a,{href:"/contrast/pr-preview/pr-1869/architecture/features-limitations#kubernetes-features",children:"registry authentication limitation"})," on bare metal."]}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsxs)(n.p,{children:["Please be aware that runtime policies currently have some blind spots.\nFor example, they can't guarantee the starting order of containers.\nSee the ",(0,r.jsx)(n.a,{href:"/contrast/pr-preview/pr-1869/architecture/features-limitations#runtime-policies",children:"current limitations"})," for more details."]})}),"\n",(0,r.jsxs)(n.p,{children:["Running ",(0,r.jsx)(n.code,{children:"contrast generate"})," for the first time creates some additional files in the working directory:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"seedshare-owner.pem"})," is required for handling the secret seed and recovering the Coordinator (see ",(0,r.jsx)(n.a,{href:"/contrast/pr-preview/pr-1869/architecture/secrets",children:"Secrets & recovery"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"workload-owner.pem"})," is required for manifest updates after the initial ",(0,r.jsx)(n.code,{children:"contrast set"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"rules.rego"})," and ",(0,r.jsx)(n.code,{children:"settings.json"})," are the basis for ",(0,r.jsx)(n.a,{href:"/contrast/pr-preview/pr-1869/architecture/components/policies",children:"runtime policies"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"layers-cache.json"})," caches container image layer information for your deployments to speed up subsequent runs of ",(0,r.jsx)(n.code,{children:"contrast generate"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"fine-tuning-initializer-injection",children:"Fine-tuning initializer injection"}),"\n",(0,r.jsx)(n.p,{children:"If you don't want the Contrast Initializer to automatically be added to your\nworkloads, there are two ways you can skip the Initializer injection step,\ndepending on how you want to customize your deployment."}),"\n",(0,r.jsxs)(n.h4,{id:"--skip-initializer-flag",children:[(0,r.jsx)(n.code,{children:"--skip-initializer"})," flag"]}),"\n",(0,r.jsxs)(n.p,{children:["You can disable the Initializer injection completely by specifying the\n",(0,r.jsx)(n.code,{children:"--skip-initializer"})," flag in the ",(0,r.jsx)(n.code,{children:"generate"})," command."]}),"\n",(0,r.jsxs)(i,{queryString:"platform",children:[(0,r.jsx)(t,{value:"metal-qemu-snp",label:"Bare metal (SEV-SNP)",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-snp --skip-initializer resources/\n"})})}),(0,r.jsx)(t,{value:"metal-qemu-snp-gpu",label:"Bare metal (SEV-SNP, with GPU support)",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-snp-gpu --skip-initializer resources/\n"})})}),(0,r.jsx)(t,{value:"metal-qemu-tdx",label:"Bare metal (TDX)",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-tdx --skip-initializer resources/\n"})})})]}),"\n",(0,r.jsxs)(n.h4,{id:"skip-initializer-annotation",children:[(0,r.jsx)(n.code,{children:"skip-initializer"})," annotation"]}),"\n",(0,r.jsxs)(n.p,{children:["If you want to disable the Initializer injection for a specific workload with\nthe ",(0,r.jsx)(n.code,{children:"contrast-cc"})," runtime class, you can do so by adding an annotation to the workload."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'metadata: # v1.Pod, v1.PodTemplateSpec\n  annotations:\n    contrast.edgeless.systems/skip-initializer: "true"\n'})}),"\n",(0,r.jsx)(n.h4,{id:"manual-initializer-injection",children:"Manual Initializer injection"}),"\n",(0,r.jsxs)(n.p,{children:["When disabling the automatic Initializer injection, you can manually add the\nInitializer as a sidecar container to your workload before generating the\npolicies. Configure the workload to use the certificates written to the\n",(0,r.jsx)(n.code,{children:"contrast-secrets"})," ",(0,r.jsx)(n.code,{children:"volumeMount"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'# v1.PodSpec\nspec:\n  initContainers:\n    - env:\n        - name: COORDINATOR_HOST\n          value: coordinator-ready\n      image: "ghcr.io/edgelesssys/contrast/initializer:v1.14.0@sha256:8e0936f61e6e19121ff85bf25df2b9fc9b42c6555ff95e952144aefa659f3dbc"\n      name: contrast-initializer\n      volumeMounts:\n        - mountPath: /contrast\n          name: contrast-secrets\n  volumes:\n    - emptyDir: {}\n      name: contrast-secrets\n'})}),"\n",(0,r.jsx)(n.h3,{id:"fine-tuning-service-mesh-injection",children:"Fine-tuning service mesh injection"}),"\n",(0,r.jsxs)(n.p,{children:["The service mesh is only injected for workload that have a ",(0,r.jsx)(n.a,{href:"/contrast/pr-preview/pr-1869/architecture/components/service-mesh#configuring-the-proxy",children:"service mesh annotation"}),"."]}),"\n",(0,r.jsxs)(n.h4,{id:"--skip-service-mesh-flag",children:[(0,r.jsx)(n.code,{children:"--skip-service-mesh"})," flag"]}),"\n",(0,r.jsxs)(n.p,{children:["You can disable the service mesh injection completely by specifying the\n",(0,r.jsx)(n.code,{children:"--skip-service-mesh"})," flag in the ",(0,r.jsx)(n.code,{children:"generate"})," command."]}),"\n",(0,r.jsxs)(i,{queryString:"platform",children:[(0,r.jsx)(t,{value:"metal-qemu-snp",label:"Bare metal (SEV-SNP)",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-snp --skip-service-mesh resources/\n"})})}),(0,r.jsx)(t,{value:"metal-qemu-snp-gpu",label:"Bare metal (SEV-SNP, with GPU support)",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-snp-gpu --skip-service-mesh resources/\n"})})}),(0,r.jsx)(t,{value:"metal-qemu-tdx",label:"Bare metal (TDX)",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-tdx --skip-service-mesh resources/\n"})})})]}),"\n",(0,r.jsxs)(n.p,{children:["In this case, you can manually add the service mesh sidecar container to your workload before generating the policies, or ",(0,r.jsx)(n.a,{href:"/contrast/pr-preview/pr-1869/howto/workload-deployment/TLS-configuration#go-integration",children:"authenticate peers on the application level"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}function p(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>o});var i=t(96540);const r={},a=i.createContext(r);function s(e){const n=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);