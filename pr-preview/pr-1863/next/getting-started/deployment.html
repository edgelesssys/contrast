<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-getting-started/deployment" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Workload deployment | Contrast</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.edgeless.systems/contrast/pr-preview/pr-1863/next/getting-started/deployment"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Workload deployment | Contrast"><meta data-rh="true" name="description" content="Follow these steps to make your deployment confidential."><meta data-rh="true" property="og:description" content="Follow these steps to make your deployment confidential."><link data-rh="true" rel="icon" href="/contrast/pr-preview/pr-1863/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.edgeless.systems/contrast/pr-preview/pr-1863/next/getting-started/deployment"><link data-rh="true" rel="alternate" href="https://docs.edgeless.systems/contrast/pr-preview/pr-1863/next/getting-started/deployment" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.edgeless.systems/contrast/pr-preview/pr-1863/next/getting-started/deployment" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Workload deployment","item":"https://docs.edgeless.systems/contrast/pr-preview/pr-1863/next/getting-started/deployment"}]}</script><script src="/contrast/gtagman.js" async data-cookieconsent="ignore"></script><link rel="stylesheet" href="/contrast/pr-preview/pr-1863/assets/css/styles.ac832e15.css">
<script src="/contrast/pr-preview/pr-1863/assets/js/runtime~main.5cb8bb12.js" defer="defer"></script>
<script src="/contrast/pr-preview/pr-1863/assets/js/main.d5ccab54.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard" data-theme="light">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>document.documentElement.setAttribute("data-theme","light"),document.documentElement.setAttribute("data-theme-choice","light"),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/contrast/pr-preview/pr-1863/img/logos/contrast_icon.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/contrast/pr-preview/pr-1863/"><div class="navbar__logo"><img src="/contrast/pr-preview/pr-1863/img/logos/contrast_icon.svg" alt="Contrast Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/contrast/pr-preview/pr-1863/img/logos/contrast_icon.svg" alt="Contrast Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/contrast/pr-preview/pr-1863/next/getting-started/deployment">Next</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/contrast/pr-preview/pr-1863/next/getting-started/deployment">Next</a></li><li><a class="dropdown__link" href="/contrast/pr-preview/pr-1863/getting-started/deployment">1.13</a></li><li><a class="dropdown__link" href="/contrast/pr-preview/pr-1863/1.12/getting-started/deployment">1.12</a></li><li><a class="dropdown__link" href="/contrast/pr-preview/pr-1863/1.11/getting-started/deployment">1.11</a></li><li><a class="dropdown__link" href="/contrast/pr-preview/pr-1863/1.10">1.10</a></li><li><a class="dropdown__link" href="/contrast/pr-preview/pr-1863/1.9">1.9</a></li><li><a class="dropdown__link" href="/contrast/pr-preview/pr-1863/1.8">1.8</a></li><li><a class="dropdown__link" href="/contrast/pr-preview/pr-1863/1.7">1.7</a></li><li><a class="dropdown__link" href="/contrast/pr-preview/pr-1863/1.6">1.6</a></li><li><a class="dropdown__link" href="/contrast/pr-preview/pr-1863/1.5">1.5</a></li><li><a class="dropdown__link" href="/contrast/pr-preview/pr-1863/1.4">1.4</a></li><li><a class="dropdown__link" href="/contrast/pr-preview/pr-1863/1.3">1.3</a></li></ul></div><a href="https://github.com/edgelesssys/contrast" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="navbarSearchContainer_Bca1"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/contrast/pr-preview/pr-1863/next"><span title="Introduction" class="linkLabel_WmDU">Introduction</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/contrast/pr-preview/pr-1863/next/getting-started/overview"><span title="Getting started" class="categoryLinkLabel_W154">Getting started</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/pr-preview/pr-1863/next/getting-started/overview"><span title="Overview" class="linkLabel_WmDU">Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/contrast/pr-preview/pr-1863/next/getting-started/deployment"><span title="Workload deployment" class="linkLabel_WmDU">Workload deployment</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/contrast/pr-preview/pr-1863/next/howto/cluster-setup/bare-metal"><span title="How-to" class="categoryLinkLabel_W154">How-to</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/contrast/pr-preview/pr-1863/next/howto/cluster-setup/bare-metal"><span title="Cluster setup" class="categoryLinkLabel_W154">Cluster setup</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/pr-preview/pr-1863/next/howto/install-cli"><span title="Install CLI" class="linkLabel_WmDU">Install CLI</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/contrast/pr-preview/pr-1863/next/howto/workload-deployment/runtime-deployment"><span title="Workload deployment" class="categoryLinkLabel_W154">Workload deployment</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/pr-preview/pr-1863/next/howto/encrypted-storage"><span title="Set up encrypted volumes" class="linkLabel_WmDU">Set up encrypted volumes</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/pr-preview/pr-1863/next/howto/hardening"><span title="Hardening" class="linkLabel_WmDU">Hardening</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/pr-preview/pr-1863/next/howto/logging"><span title="Logging" class="linkLabel_WmDU">Logging</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/pr-preview/pr-1863/next/howto/registry-authentication"><span title="Registry authentication" class="linkLabel_WmDU">Registry authentication</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/pr-preview/pr-1863/next/howto/observability"><span title="Observability" class="linkLabel_WmDU">Observability</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/pr-preview/pr-1863/next/howto/manifest-update"><span title="Manifest update" class="linkLabel_WmDU">Manifest update</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/pr-preview/pr-1863/next/howto/coordinator-ha"><span title="Coordinator high-availability" class="linkLabel_WmDU">Coordinator high-availability</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/pr-preview/pr-1863/next/howto/vault"><span title="Vault" class="linkLabel_WmDU">Vault</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/pr-preview/pr-1863/next/howto/secure-image-store"><span title="Secure image store" class="linkLabel_WmDU">Secure image store</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/pr-preview/pr-1863/next/howto/troubleshooting"><span title="Troubleshooting" class="linkLabel_WmDU">Troubleshooting</span></a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/contrast/pr-preview/pr-1863/next/security"><span title="Security" class="linkLabel_WmDU">Security</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/contrast/pr-preview/pr-1863/next/architecture/overview"><span title="Architecture" class="categoryLinkLabel_W154">Architecture</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for <!-- -->Contrast<!-- --> <b>Next</b> version.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/contrast/pr-preview/pr-1863/getting-started/deployment">latest version</a></b> (<!-- -->1.13<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/contrast/pr-preview/pr-1863/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Getting started</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Workload deployment</span></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: Next</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Workload deployment</h1></header>
<p>Follow these steps to make your deployment confidential.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-adjust-deployment-files">1. Adjust deployment files<a href="#1-adjust-deployment-files" class="hash-link" aria-label="Direct link to 1. Adjust deployment files" title="Direct link to 1. Adjust deployment files" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="download-the-demo-deployment-configuration">Download the demo deployment configuration<a href="#download-the-demo-deployment-configuration" class="hash-link" aria-label="Direct link to Download the demo deployment configuration" title="Direct link to Download the demo deployment configuration" translate="no">​</a></h3>
<p>Download the Kubernetes resources for the emojivoto deployment with the following command:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-fLO</span><span class="token plain"> https://github.com/edgelesssys/contrast/releases/latest/download/emojivoto-demo.yml --create-dirs --output-dir resources</span><br></span></code></pre></div></div>
<p>This deployment has already been prepared for Contrast.
In the following sub-sections, we will explain the changes made to the original deployment file.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="set-the-runtimeclass">Set the RuntimeClass<a href="#set-the-runtimeclass" class="hash-link" aria-label="Direct link to Set the RuntimeClass" title="Direct link to Set the RuntimeClass" translate="no">​</a></h3>
<p>In each pod configuration, set the <code>runtimeClassName</code> field under <code>spec</code> to <code>contrast-cc</code>.
This tells Kubernetes to run the pod inside a Confidential Virtual Machine (CVM) using the Contrast runtime.</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">resources/emojivoto-demo.yaml</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token coord">@@ -36,6 +36,7 @@</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">            periodSeconds: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">            tcpSocket:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">              port: 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">      runtimeClassName: contrast-cc</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      serviceAccountName: emoji</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token coord">@@ -86,6 +87,7 @@</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">              value: web-svc:443</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">          image: ghcr.io/edgelesssys/contrast/emojivoto-web:coco-1@sha256:0fd9bf6f7dcb99bdb076144546b663ba6c3eb457cbb48c1d3fceb591d207289c</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">          name: vote-bot</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">      runtimeClassName: contrast-cc</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token coord">@@ -125,6 +127,7 @@</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">            periodSeconds: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">            tcpSocket:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">              port: 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">      runtimeClassName: contrast-cc</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      serviceAccountName: voting</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token coord">@@ -188,6 +191,7 @@</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">              scheme: HTTPS</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">            initialDelaySeconds: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">            periodSeconds: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">      runtimeClassName: contrast-cc</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      serviceAccountName: web</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">apiVersion: v1</span><br></span></code></pre></div></div>
<p>For more details, see <a class="" href="/contrast/pr-preview/pr-1863/next/howto/workload-deployment/deployment-file-preparation#runtimeclass">RuntimeClass Section in the &quot;Prepare deployment files&quot; how-to</a>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="define-pod-resources">Define pod resources<a href="#define-pod-resources" class="hash-link" aria-label="Direct link to Define pod resources" title="Direct link to Define pod resources" translate="no">​</a></h3>
<p>Each Contrast workload runs inside its own CVM.
To ensure accurate memory allocation, Contrast requires strict resource definitions:</p>
<ul>
<li class="">Always specify both memory <code>requests</code> and <code>limits</code>.</li>
<li class="">The values for <code>requests</code> and <code>limits</code> must be identical.</li>
</ul>
<p>On bare-metal platforms, the container images are pulled from within each pod-VM.
By default, images are stored on an encrypted ephemeral disk through the <a class="" href="/contrast/pr-preview/pr-1863/next/howto/secure-image-store">Contrast secure image store</a> feature.
If this feature is disabled, the images are stored in encrypted memory instead.
In this case, the uncompressed image size needs to be added to the memory limits of containers.</p>
<p>Kubernetes schedules pods on nodes based on the memory <code>requests</code>.
To prevent Kubernetes from over-commiting nodes, set both <code>request</code> and <code>limit</code> to the same value.</p>
<p>Set both to 400Mi for each pod in this example:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">resources/emojivoto-demo.yaml</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token coord">@@ -36,6 +36,11 @@</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">            periodSeconds: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">            tcpSocket:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">              port: 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">          resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">            limits:</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">              memory: 400Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">            requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">              memory: 400Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      runtimeClassName: contrast-cc</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      serviceAccountName: emoji</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token coord">@@ -87,6 +92,11 @@</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">              value: web-svc:443</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">          image: ghcr.io/edgelesssys/contrast/emojivoto-web:coco-1@sha256:0fd9bf6f7dcb99bdb076144546b663ba6c3eb457cbb48c1d3fceb591d207289c</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">          name: vote-bot</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">          resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">            limits:</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">              memory: 400Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">            requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">              memory: 400Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      runtimeClassName: contrast-cc</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token coord">@@ -127,6 +137,11 @@</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">            periodSeconds: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">            tcpSocket:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">              port: 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">          resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">            limits:</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">              memory: 400Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">            requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">              memory: 400Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      runtimeClassName: contrast-cc</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      serviceAccountName: voting</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token coord">@@ -191,6 +206,11 @@</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">              scheme: HTTPS</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">            initialDelaySeconds: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">            periodSeconds: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">          resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">            limits:</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">              memory: 400Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">            requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">              memory: 400Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      runtimeClassName: contrast-cc</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      serviceAccountName: web</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">---</span><br></span></code></pre></div></div>
<p>For details, see the <a class="" href="/contrast/pr-preview/pr-1863/next/howto/workload-deployment/deployment-file-preparation#pod-resources">pod resources how-to</a>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="add-service-mesh-annotations">Add service mesh annotations<a href="#add-service-mesh-annotations" class="hash-link" aria-label="Direct link to Add service mesh annotations" title="Direct link to Add service mesh annotations" translate="no">​</a></h3>
<p>Contrast provides its own PKI based on attestation.
The <strong>Contrast Coordinator</strong>, a service deployed alongside your workloads, acts as both:</p>
<ul>
<li class="">The central remote attestation service.</li>
<li class="">A certificate authority (CA) that issues certificates to verified pods.</li>
</ul>
<p>By adding specific annotations to your pod definitions, you enable an automatic service mesh for encrypted and authenticated pod-to-pod communication.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="traffic-flow-in-this-setup">Traffic flow in this setup:<a href="#traffic-flow-in-this-setup" class="hash-link" aria-label="Direct link to Traffic flow in this setup:" title="Direct link to Traffic flow in this setup:" translate="no">​</a></h4>
<ol>
<li class="">
<p><strong>From <code>web</code> to <code>emoji</code> and <code>voting</code>:</strong>
gRPC calls are tunneled via mTLS using mesh certificates.</p>
</li>
<li class="">
<p><strong>From external clients to <code>web</code>:</strong>
HTTPS is used. Clients don&#x27;t need to present a mesh certificate but can verify <code>web</code>’s certificate.</p>
</li>
<li class="">
<p><strong><code>vote-bot</code> as a simulated client:</strong>
Simulates external clients with HTTPS requests.</p>
</li>
</ol>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="enable-egress-mtls-from-web-to-emoji-and-voting">Enable egress mTLS from <code>web</code> to <code>emoji</code> and <code>voting</code><a href="#enable-egress-mtls-from-web-to-emoji-and-voting" class="hash-link" aria-label="Direct link to enable-egress-mtls-from-web-to-emoji-and-voting" title="Direct link to enable-egress-mtls-from-web-to-emoji-and-voting" translate="no">​</a></h4>
<p>Add the following annotation to the <code>web</code> pod to define egress rules:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">contrast.edgeless.systems/servicemesh-egress</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> emoji</span><span class="token comment" style="color:#999988;font-style:italic">#127.137.0.1:8081#emoji-svc:8080##voting#127.137.0.2:8081#voting-svc:8080</span><br></span></code></pre></div></div>
<p>The format of this annotation is:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;name&gt;#&lt;chosen IP&gt;:&lt;chosen port&gt;#&lt;original-hostname-or-ip&gt;:&lt;original-port&gt;</span><br></span></code></pre></div></div>
<p>Where:</p>
<ul>
<li class=""><code>&lt;name&gt;</code> is an internal label for the target service.</li>
<li class=""><code>&lt;chosen IP&gt;:&lt;chosen port&gt;</code> is a local address that your application uses.</li>
<li class=""><code>&lt;original-hostname-or-ip&gt;:&lt;original-port&gt;</code> is the actual destination the traffic should reach.</li>
</ul>
<p>Multiple entries are separated by <code>##</code>.</p>
<p>Contrast’s service mesh deploys a local Envoy proxy at <code>&lt;chosen IP&gt;:&lt;chosen port&gt;</code> within each pod. To direct outbound traffic through the mesh, you must configure your application to connect to that proxy address instead of <code>&lt;original-hostname-or-ip&gt;:&lt;original-port&gt;</code>.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="enable-ingress-mtls-at-emoji-and-voting">Enable ingress mTLS at <code>emoji</code> and <code>voting</code><a href="#enable-ingress-mtls-at-emoji-and-voting" class="hash-link" aria-label="Direct link to enable-ingress-mtls-at-emoji-and-voting" title="Direct link to enable-ingress-mtls-at-emoji-and-voting" translate="no">​</a></h4>
<p>Add the following annotation to both pods:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">contrast.edgeless.systems/servicemesh-ingress</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><br></span></code></pre></div></div>
<p>Setting this annotation to an empty string enables automatic verification of incoming mTLS connections.
If the annotation is omitted entirely, no ingress verification will take place.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="enable-ingress-for-external-https-traffic">Enable ingress for external HTTPS traffic<a href="#enable-ingress-for-external-https-traffic" class="hash-link" aria-label="Direct link to Enable ingress for external HTTPS traffic" title="Direct link to Enable ingress for external HTTPS traffic" translate="no">​</a></h4>
<p>Add this annotation to allow HTTPS ingress without requiring client certificates:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">contrast.edgeless.systems/servicemesh-ingress</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> web</span><span class="token comment" style="color:#999988;font-style:italic">#8080#false</span><br></span></code></pre></div></div>
<p>This configuration exempts port 8080 from mTLS verification: clients can connect to 8080 without presenting a client certificate, while all other ports still require full mTLS</p>
<p>Altogether, we can configure the service mesh by adding the following annotations:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">resources/emojivoto-demo.yaml</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@@ -14,6 +14,8 @@ spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      version: v11</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">      annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">        contrast.edgeless.systems/servicemesh-ingress: &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">        app.kubernetes.io/name: emoji-svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">        version: v11</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token plain">@@ -115,6 +117,8 @@ spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      version: v11</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">      annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">        contrast.edgeless.systems/servicemesh-ingress: &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">        app.kubernetes.io/name: voting-svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">        version: v11</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token plain">@@ -181,6 +185,9 @@ spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      version: v11</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">      annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">        contrast.edgeless.systems/servicemesh-egress: emoji#127.137.0.1:8081#emoji-svc:8080##voting#127.137.0.2:8081#voting-svc:8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">        contrast.edgeless.systems/servicemesh-ingress: web#8080#false</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">        app.kubernetes.io/name: web-svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">        version: v11</span><br></span></code></pre></div></div>
<p>These are all the changes you need to make to your deployment files.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-install-the-contrast-runtime">2. Install the Contrast runtime<a href="#2-install-the-contrast-runtime" class="hash-link" aria-label="Direct link to 2. Install the Contrast runtime" title="Direct link to 2. Install the Contrast runtime" translate="no">​</a></h2>
<p>Next, install the Contrast runtime in your cluster which will be used when setting up CVMs on nodes.</p>
<div class="theme-tabs-container tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Bare metal (SEV-SNP)</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Bare metal (TDX)</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> https://github.com/edgelesssys/contrast/releases/latest/download/runtime-metal-qemu-snp.yml</span><br></span></code></pre></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> https://github.com/edgelesssys/contrast/releases/latest/download/runtime-metal-qemu-tdx.yml</span><br></span></code></pre></div></div></div></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-add-the-contrast-coordinator-to-the-deployment">3. Add the Contrast Coordinator to the deployment<a href="#3-add-the-contrast-coordinator-to-the-deployment" class="hash-link" aria-label="Direct link to 3. Add the Contrast Coordinator to the deployment" title="Direct link to 3. Add the Contrast Coordinator to the deployment" translate="no">​</a></h2>
<p>The Contrast Coordinator is an additional service that runs alongside your application and ensures the deployment remains in a secure and trusted state by attesting all workload pods.</p>
<p>Download the Kubernetes resource of the Contrast Coordinator, comprising a single replica deployment and a LoadBalancer service.
Put it next to your resources:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-fLO</span><span class="token plain"> https://github.com/edgelesssys/contrast/releases/latest/download/coordinator.yml --output-dir resources</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-generate-initdata-annotations-and-manifest">4. Generate initdata annotations and manifest<a href="#4-generate-initdata-annotations-and-manifest" class="hash-link" aria-label="Direct link to 4. Generate initdata annotations and manifest" title="Direct link to 4. Generate initdata annotations and manifest" translate="no">​</a></h2>
<p>Run the <code>generate</code> command to create execution policies that strictly control communication between the host and CVMs on each worker node and define which workloads are allowed to run. These policies are wrapped in initdata documents and added as annotations to your deployment files.</p>
<p>The command also generates a <code>manifest.json</code> file, which contains the trusted reference values of your deployment.</p>
<div class="theme-tabs-container tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Bare metal (SEV-SNP)</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Bare metal (SEV-SNP, with GPU support)</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Bare metal (TDX)</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">contrast generate --reference-values metal-qemu-snp resources/</span><br></span></code></pre></div></div><p>On bare-metal SEV-SNP, <code>contrast generate</code> is unable to fill in the <code>MinimumTCB</code> values as they can vary between platforms and CPU models.
They will have to be filled in manually.</p><p>If you don&#x27;t know the values from the firmware you installed, you can use the <a href="https://github.com/virtee/snphost" target="_blank" rel="noopener noreferrer" class=""><code>snphost</code></a> tool to retrieve the current TCB.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">snphost show tcb</span><br></span></code></pre></div></div><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Reported TCB: TCB Version:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Microcode:   72</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SNP:         23</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TEE:         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Boot Loader: 9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  FMC:         None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Platform TCB: TCB Version:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Microcode:   72</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SNP:         23</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TEE:         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Boot Loader: 9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  FMC:         None</span><br></span></code></pre></div></div><p>Use the values from <code>Platform TCB</code> to fill in the <code>MinimumTCB</code> values in the generated <code>manifest.json</code> file.</p><div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Attention!</div><div class="admonitionContent_BuS1"><p>This must be done on a trusted machine, with a secure and trusted connection to it.</p></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">contrast generate --reference-values metal-qemu-snp-gpu resources/</span><br></span></code></pre></div></div><p>On bare-metal SEV-SNP, <code>contrast generate</code> is unable to fill in the <code>MinimumTCB</code> values as they can vary between platforms and CPU models.
They will have to be filled in manually.</p><p>If you don&#x27;t know the values from the firmware you installed, you can use the <a href="https://github.com/virtee/snphost" target="_blank" rel="noopener noreferrer" class=""><code>snphost</code></a> tool to retrieve the current TCB.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">snphost show tcb</span><br></span></code></pre></div></div><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Reported TCB: TCB Version:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Microcode:   72</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SNP:         23</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TEE:         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Boot Loader: 9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  FMC:         None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Platform TCB: TCB Version:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Microcode:   72</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SNP:         23</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TEE:         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Boot Loader: 9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  FMC:         None</span><br></span></code></pre></div></div><p>Use the values from <code>Platform TCB</code> to fill in the <code>MinimumTCB</code> values in the generated <code>manifest.json</code> file.</p><div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Attention!</div><div class="admonitionContent_BuS1"><p>This must be done on a trusted machine, with a secure and trusted connection to it.</p></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">contrast generate --reference-values metal-qemu-tdx resources/</span><br></span></code></pre></div></div><p>On bare-metal TDX, <code>contrast generate</code> is unable to fill in the <code>MrSeam</code> value as it depends on your platform configuration.
It will have to be filled in manually.</p><p><code>MrSeam</code> is the SHA384 hash of the TDX module. You can retrieve it by executing</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sha384sum /boot/efi/EFI/TDX/TDX-SEAM.so </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cut</span><span class="token plain"> -d</span><span class="token string" style="color:#e3116c">&#x27; &#x27;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-f1</span><br></span></code></pre></div></div><div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Attention!</div><div class="admonitionContent_BuS1"><p>This must be done on a trusted machine, with a secure and trusted connection to it.</p></div></div></div></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-deploy-application">5. Deploy application<a href="#5-deploy-application" class="hash-link" aria-label="Direct link to 5. Deploy application" title="Direct link to 5. Deploy application" translate="no">​</a></h2>
<p>Now deploy your application along with the Contrast coordinator:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> resources/</span><br></span></code></pre></div></div>
<p>The Coordinator should show a status <code>Running</code> and will only transition to <code>Ready</code> after a manifest has been set.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="6-connect-to-coordinator-and-set-manifest">6. Connect to Coordinator and set manifest<a href="#6-connect-to-coordinator-and-set-manifest" class="hash-link" aria-label="Direct link to 6. Connect to Coordinator and set manifest" title="Direct link to 6. Connect to Coordinator and set manifest" translate="no">​</a></h2>
<p>Configure the Coordinator with the created manifest. It might take up to a few minutes
for the load balancer to be created and the Coordinator being available.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">coordinator</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get svc coordinator </span><span class="token variable parameter variable" style="color:#36acaa">-o</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">jsonpath</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">&#x27;{.status.loadBalancer.ingress[0].ip}&#x27;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;The user API of your Contrast Coordinator is available at </span><span class="token string variable" style="color:#36acaa">$coordinator</span><span class="token string" style="color:#e3116c">:1313&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contrast </span><span class="token builtin class-name">set</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${coordinator}</span><span class="token string" style="color:#e3116c">:1313&quot;</span><span class="token plain"> resources/</span><br></span></code></pre></div></div>
<p>The CLI will use the reference values from the manifest to attest the Coordinator deployment
during the TLS handshake. If the connection succeeds, it&#x27;s ensured that the Coordinator
deployment hasn&#x27;t been tampered with.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="7-verify-deployment">7. Verify deployment<a href="#7-verify-deployment" class="hash-link" aria-label="Direct link to 7. Verify deployment" title="Direct link to 7. Verify deployment" translate="no">​</a></h2>
<p>In many scenarios, users may require assurance of an application&#x27;s security and integrity before interacting with it—for example, prior to submitting sensitive data or casting a vote.</p>
<p>Contrast enables this through a single remote attestation step, regardless of the size or complexity of the deployment.
By attesting the Coordinator, the user transitively attests all workloads that the Coordinator has verified or will verify according to the defined manifest.</p>
<p>A successful attestation of the Coordinator provides a strong guarantee that the deployment adheres to the reference values specified in the <code>manifest.json</code>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="verifying-the-coordinator">Verifying the Coordinator<a href="#verifying-the-coordinator" class="hash-link" aria-label="Direct link to Verifying the Coordinator" title="Direct link to Verifying the Coordinator" translate="no">​</a></h3>
<p>A user can verify the Contrast deployment using the verify
command:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">contrast verify </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${coordinator}</span><span class="token string" style="color:#e3116c">:1313&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-m</span><span class="token plain"> manifest.json</span><br></span></code></pre></div></div>
<p>The CLI verifies the Coordinator via remote attestation using reference values from the provided manifest.
This manifest must be distributed out-of-band to all parties performing verification, as the <code>verify</code> command checks whether the manifest currently active at the Coordinator matches the one supplied to the CLI.</p>
<p>If verification succeeds, it confirms that the Coordinator is running in the expected Confidential Computing environment with the correct code version.
The Coordinator then returns its configuration over a secure TLS channel.
The CLI stores this information—including the mesh root certificate (<code>mesh-ca.pem</code>), the manifest history, and the associated initdata documents—in the <code>verify/</code> directory.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="auditing-the-manifest">Auditing the manifest<a href="#auditing-the-manifest" class="hash-link" aria-label="Direct link to Auditing the manifest" title="Direct link to Auditing the manifest" translate="no">​</a></h3>
<p>Next, the stored Coordinator configuration should be audited.
A user—or a trusted third party—can review the manifest and the referenced initdata documents to ensure they meet expectations.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="8-connect-securely-to-the-frontend">8. Connect securely to the frontend<a href="#8-connect-securely-to-the-frontend" class="hash-link" aria-label="Direct link to 8. Connect securely to the frontend" title="Direct link to 8. Connect securely to the frontend" translate="no">​</a></h2>
<p>Once the Coordinator’s configuration has been verified, users can securely connect to the application via HTTPS. The application uses the <code>mesh-ca.pem</code> certificate as the root of trust. We can use this certificate to validate the frontend&#x27;s certificate.</p>
<p>To access the web frontend, expose the service on a public IP address via a LoadBalancer service:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">frontendIP</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get svc web-svc </span><span class="token variable parameter variable" style="color:#36acaa">-o</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">jsonpath</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">&#x27;{.status.loadBalancer.ingress[0].ip}&#x27;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Frontend is available at  https://</span><span class="token string variable" style="color:#36acaa">$frontendIP</span><span class="token string" style="color:#e3116c">, you can visit it in your browser.&quot;</span><br></span></code></pre></div></div>
<p>Using <code>openssl</code>, the certificate of the service can be validated with the <code>mesh-ca.pem</code>:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">openssl s_client </span><span class="token parameter variable" style="color:#36acaa">-CAfile</span><span class="token plain"> verify/mesh-ca.pem </span><span class="token parameter variable" style="color:#36acaa">-verify_return_error</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-connect</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${frontendIP}</span><span class="token plain">:443 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> /dev/null</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="optional-updating-the-certificate-san-and-the-manifest">Optional: Updating the certificate SAN and the manifest<a href="#optional-updating-the-certificate-san-and-the-manifest" class="hash-link" aria-label="Direct link to Optional: Updating the certificate SAN and the manifest" title="Direct link to Optional: Updating the certificate SAN and the manifest" translate="no">​</a></h2>
<p>By default, mesh certificates are issued with a wildcard DNS Subject Alternative Name (SAN).
In this demo, the web frontend is accessed via a LoadBalancer IP.
Tools like <code>curl</code> validate certificates against SANs and will fail if the certificate doesn’t include the IP address.</p>
<p>For example, running <code>curl</code> with the mesh CA certificate results in:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--cacert</span><span class="token plain"> ./verify/mesh-ca.pem </span><span class="token string" style="color:#e3116c">&quot;https://</span><span class="token string variable" style="color:#36acaa">${frontendIP}</span><span class="token string" style="color:#e3116c">:443&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl: </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">60</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> SSL: no alternative certificate subject name matches target </span><span class="token function" style="color:#d73a49">host</span><span class="token plain"> name </span><span class="token string" style="color:#e3116c">&#x27;203.0.113.34&#x27;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="adding-an-ip-san-to-the-manifest">Adding an IP SAN to the manifest<a href="#adding-an-ip-san-to-the-manifest" class="hash-link" aria-label="Direct link to Adding an IP SAN to the manifest" title="Direct link to Adding an IP SAN to the manifest" translate="no">​</a></h3>
<p>To enable IP-based certificate verification, update the relevant entry in the manifest.
Add the <code>frontendIP</code> to the list of SANs:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">  &quot;Policies&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">    &quot;99dd77cbd7fe2c4e1f29511014c14054a21a376f7d58a48d50e9e036f4522f6b&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      &quot;SANs&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">        &quot;web&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:#d73a49">-</span><span class="token deleted-sign deleted line" style="color:#d73a49">        &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token deleted-sign deleted line" style="color:#d73a49"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">        &quot;*&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">        &quot;203.0.113.34&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      &quot;WorkloadSecretID&quot;: &quot;web&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">    },</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="updating-the-manifest-on-the-coordinator">Updating the manifest on the coordinator<a href="#updating-the-manifest-on-the-coordinator" class="hash-link" aria-label="Direct link to Updating the manifest on the coordinator" title="Direct link to Updating the manifest on the coordinator" translate="no">​</a></h3>
<p>Apply the updated manifest with:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">contrast </span><span class="token builtin class-name">set</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${coordinator}</span><span class="token string" style="color:#e3116c">:1313&quot;</span><span class="token plain"> deployment/</span><br></span></code></pre></div></div>
<p>This triggers a rotation of the mesh CA certificate.
New certificates will be issued by the updated CA.
Previously issued certificates will no longer be trusted.
This ensures that updated workloads don’t trust older, potentially vulnerable versions.</p>
<p>The updated <code>mesh-ca.pem</code> will be written to reflect the new CA.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="restarting-workloads">Restarting workloads<a href="#restarting-workloads" class="hash-link" aria-label="Direct link to Restarting workloads" title="Direct link to Restarting workloads" translate="no">​</a></h3>
<p>The Contrast Initializer doesn&#x27;t automatically fetch new certificates after a manifest update.
You must manually restart the deployments to trigger certificate re-issuance:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deployment/emoji</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deployment/vote-bot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deployment/voting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deployment/web</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="verifying-the-connection">Verifying the connection<a href="#verifying-the-connection" class="hash-link" aria-label="Direct link to Verifying the connection" title="Direct link to Verifying the connection" translate="no">​</a></h3>
<p>After restarting the deployments, connect securely using:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--cacert</span><span class="token plain"> ./mesh-ca.pem </span><span class="token string" style="color:#e3116c">&quot;https://</span><span class="token string variable" style="color:#36acaa">${frontendIP}</span><span class="token string" style="color:#e3116c">:443&quot;</span><br></span></code></pre></div></div>
<p>This should return the HTML content of the web frontend.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/edgelesssys/contrast/edit/main/docs/docs/getting-started/deployment.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/contrast/pr-preview/pr-1863/next/getting-started/overview"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Overview</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/contrast/pr-preview/pr-1863/next/howto/cluster-setup/bare-metal"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Bare metal</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-adjust-deployment-files" class="table-of-contents__link toc-highlight">1. Adjust deployment files</a><ul><li><a href="#download-the-demo-deployment-configuration" class="table-of-contents__link toc-highlight">Download the demo deployment configuration</a></li><li><a href="#set-the-runtimeclass" class="table-of-contents__link toc-highlight">Set the RuntimeClass</a></li><li><a href="#define-pod-resources" class="table-of-contents__link toc-highlight">Define pod resources</a></li><li><a href="#add-service-mesh-annotations" class="table-of-contents__link toc-highlight">Add service mesh annotations</a></li></ul></li><li><a href="#2-install-the-contrast-runtime" class="table-of-contents__link toc-highlight">2. Install the Contrast runtime</a></li><li><a href="#3-add-the-contrast-coordinator-to-the-deployment" class="table-of-contents__link toc-highlight">3. Add the Contrast Coordinator to the deployment</a></li><li><a href="#4-generate-initdata-annotations-and-manifest" class="table-of-contents__link toc-highlight">4. Generate initdata annotations and manifest</a></li><li><a href="#5-deploy-application" class="table-of-contents__link toc-highlight">5. Deploy application</a></li><li><a href="#6-connect-to-coordinator-and-set-manifest" class="table-of-contents__link toc-highlight">6. Connect to Coordinator and set manifest</a></li><li><a href="#7-verify-deployment" class="table-of-contents__link toc-highlight">7. Verify deployment</a><ul><li><a href="#verifying-the-coordinator" class="table-of-contents__link toc-highlight">Verifying the Coordinator</a></li><li><a href="#auditing-the-manifest" class="table-of-contents__link toc-highlight">Auditing the manifest</a></li></ul></li><li><a href="#8-connect-securely-to-the-frontend" class="table-of-contents__link toc-highlight">8. Connect securely to the frontend</a></li><li><a href="#optional-updating-the-certificate-san-and-the-manifest" class="table-of-contents__link toc-highlight">Optional: Updating the certificate SAN and the manifest</a><ul><li><a href="#adding-an-ip-san-to-the-manifest" class="table-of-contents__link toc-highlight">Adding an IP SAN to the manifest</a></li><li><a href="#updating-the-manifest-on-the-coordinator" class="table-of-contents__link toc-highlight">Updating the manifest on the coordinator</a></li><li><a href="#restarting-workloads" class="table-of-contents__link toc-highlight">Restarting workloads</a></li><li><a href="#verifying-the-connection" class="table-of-contents__link toc-highlight">Verifying the connection</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.edgeless.systems/#footer-id" target="_blank" rel="noopener noreferrer" class="footer__link-item">Newsletter<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.edgeless.systems/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://twitter.com/EdgelessSystems" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/company/edgeless-systems/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCOOInN0sCv6icUesisYIDeA" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Company</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.edgeless.systems/imprint/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Imprint<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.edgeless.systems/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="javascript: Cookiebot.renew()" class="footer__link-item">Cookie Settings</a></li><li class="footer__item"><a href="https://www.edgeless.systems/contact-us/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contact Us<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Edgeless Systems</div></div></div></footer></div>
</body>
</html>