"use strict";(globalThis.webpackChunkcontrast_docs=globalThis.webpackChunkcontrast_docs||[]).push([[24241],{322(e,t,n){n.r(t),n.d(t,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"howto/multi-runtime-class","title":"Multi-runtime class deployments","description":"This guide shows how to use more than one runtime class with a Contrast deployment.","source":"@site/docs/howto/multi-runtime-class.md","sourceDirName":"howto","slug":"/howto/multi-runtime-class","permalink":"/contrast/pr-preview/pr-2180/next/howto/multi-runtime-class","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/contrast/edit/main/docs/docs/howto/multi-runtime-class.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Secure image store","permalink":"/contrast/pr-preview/pr-2180/next/howto/secure-image-store"},"next":{"title":"Immutable deployments","permalink":"/contrast/pr-preview/pr-2180/next/howto/immutable-deployments"}}');var r=n(74848),o=n(28453);const i={},l="Multi-runtime class deployments",a={},d=[{value:"Applicability",id:"applicability",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"How-to",id:"how-to",level:2},{value:"Deploy the required Contrast runtimes",id:"deploy-the-required-contrast-runtimes",level:3},{value:"Add the Coordinator",id:"add-the-coordinator",level:3},{value:"Prepare deployment files",id:"prepare-deployment-files",level:3},{value:"Generating the manifest",id:"generating-the-manifest",level:3}];function c(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"multi-runtime-class-deployments",children:"Multi-runtime class deployments"})}),"\n",(0,r.jsx)(t.p,{children:"This guide shows how to use more than one runtime class with a Contrast deployment."}),"\n",(0,r.jsx)(t.h2,{id:"applicability",children:"Applicability"}),"\n",(0,r.jsx)(t.p,{children:"For mixed SEV-SNP and TDX clusters, or on GPU-enabled clusters where not all workloads require access to a GPU."}),"\n",(0,r.jsx)(t.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-2180/next/howto/cluster-setup/bare-metal",children:"Set up cluster"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-2180/next/howto/install-cli",children:"Install CLI"})}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"how-to",children:"How-to"}),"\n",(0,r.jsx)(t.p,{children:"Depending on the configuration of your cluster and the workloads to deploy, it can be desirable to use different runtime classes for pods in the same deployment.\nFor example, in a cluster consisting of both SEV-SNP and TDX machines, you might want to distribute the workload over all nodes.\nThis guide walks you through the process of configuring your Contrast deployment accordingly."}),"\n",(0,r.jsx)(t.h3,{id:"deploy-the-required-contrast-runtimes",children:"Deploy the required Contrast runtimes"}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-2180/next/howto/workload-deployment/runtime-deployment",children:"runtime deployment guide"})," discussed how to deploy a single Contrast runtime, depending on the target platform and whether GPU support was required.\nIn preparation of a multi-runtime class deployment, we first need to apply all required runtime classes.\nFor example, if you are working with a cluster consisting of both SEV-SNP and TDX machines, obtain each of the two corresponding runtimes:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"mkdir -p resources/runtime\ncurl -fLO https://github.com/edgelesssys/contrast/releases/latest/download/runtime-metal-qemu-snp.yml --output-dir resources/runtime\ncurl -fLO https://github.com/edgelesssys/contrast/releases/latest/download/runtime-metal-qemu-tdx.yml --output-dir resources/runtime\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Since Kubernetes by itself has no knowledge of which runtime class belongs to which nodes, you need to manually restrict them.\nKubernetes provides ",(0,r.jsx)(t.a,{href:"https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/",children:"multiple mechanisms for this purpose"}),"; a natural contender is to use node selectors to restrict the runtime classes to their intended platforms.\nFirst, label your nodes, for example:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"kubectl label nodes <snp_node_name> hardware=sev-snp\nkubectl label nodes <tdx_node_name> hardware=tdx\n"})}),"\n",(0,r.jsx)(t.p,{children:"Now restrict the runtime classes to those nodes:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"kind: RuntimeClass # node.k8s.io/v1\nmetadata:\n  name: contrast-cc-metal-qemu-snp-<hash>\nscheduling:\n  nodeSelector:\n    hardware: sev-snp\n"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"kind: RuntimeClass # node.k8s.io/v1\nmetadata:\n  name: contrast-cc-metal-qemu-tdx-<hash>\nscheduling:\n  nodeSelector:\n    hardware: tdx\n"})}),"\n",(0,r.jsx)(t.p,{children:"Finally, apply the runtimes:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"kubectl apply -f resources/runtime/\n"})}),"\n",(0,r.jsx)(t.p,{children:"This restricts the runtime classes to the nodes they support.\nAs a result, Kubernetes will schedule workloads using these runtime classes only on the correct nodes."}),"\n",(0,r.jsx)(t.h3,{id:"add-the-coordinator",children:"Add the Coordinator"}),"\n",(0,r.jsxs)(t.p,{children:["Following the same steps as for a single-runtime class deployment, ",(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-2180/next/howto/workload-deployment/add-coordinator",children:"add the Coordinator to your resources"}),"."]}),"\n",(0,r.jsx)(t.h3,{id:"prepare-deployment-files",children:"Prepare deployment files"}),"\n",(0,r.jsxs)(t.p,{children:["The steps given in the ",(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-2180/next/howto/workload-deployment/deployment-file-preparation",children:"deployment files preparation section"})," apply to the multi-runtime class scenario as well,\napart from ",(0,r.jsxs)(t.a,{href:"/contrast/pr-preview/pr-2180/next/howto/workload-deployment/deployment-file-preparation#runtimeclass",children:["adding the ",(0,r.jsx)(t.code,{children:"RuntimeClass"})]}),", which deviates from the single-runtime case as follows."]}),"\n",(0,r.jsxs)(t.p,{children:["In the single-runtime class case, the ",(0,r.jsx)(t.code,{children:"contrast-cc"})," placeholder was added as the ",(0,r.jsx)(t.code,{children:"runtimeClassName"})," to each pod:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"spec: # v1.PodSpec\n  runtimeClassName: contrast-cc\n"})}),"\n",(0,r.jsxs)(t.p,{children:["In the multi-runtime class case, a placeholder of higher specificity is used to indicate to Contrast which runtime should be used for each pod.\nFor each supported platform, the corresponding ",(0,r.jsx)(t.code,{children:"RuntimeClass"})," can be indicated as follows:"]}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"Platform"}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"runtimeClassName"})})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"bare metal SEV-SNP"}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"contrast-cc-metal-qemu-snp"})})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"bare metal SEV-SNP, with GPU support"}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"contrast-cc-metal-qemu-snp-gpu"})})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"bare metal TDX"}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"contrast-cc-metal-qemu-tdx"})})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"bare metal TDX, with GPU support"}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"contrast-cc-metal-qemu-tdx-gpu"})})]})]})]}),"\n",(0,r.jsx)(t.p,{children:"In the mixed cluster example given above, you would set the runtime class of each of your pods to one of the following:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"spec: # v1.PodSpec\n  runtimeClassName: contrast-cc-metal-qemu-snp\n"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"spec: # v1.PodSpec\n  runtimeClassName: contrast-cc-metal-qemu-tdx\n"})}),"\n",(0,r.jsx)(t.admonition,{type:"tip",children:(0,r.jsxs)(t.p,{children:["You can still use just ",(0,r.jsx)(t.code,{children:"contrast-cc"})," as the ",(0,r.jsx)(t.code,{children:"runtimeClassName"}),". Just as in the single-runtime case, the ",(0,r.jsx)(t.code,{children:"RuntimeClass"})," will then be set depending on the ",(0,r.jsx)(t.code,{children:"--reference-values"})," argument passed to ",(0,r.jsx)(t.code,{children:"contrast generate"}),"."]})}),"\n",(0,r.jsxs)(t.admonition,{type:"info",children:[(0,r.jsx)(t.p,{children:"From the above description, one of the limitations of multi-runtime class support becomes evident:\nthe runtime a pod should be used needs to be known at deployment time."}),(0,r.jsx)(t.p,{children:"It's not possible to, for example, have a pod running on a TDX node fail over to a SEV-SNP host, even in a multi-runtime class enabled Contrast deployment."})]}),"\n",(0,r.jsxs)(t.p,{children:["Since we restricted the runtime classes to supported nodes (",(0,r.jsx)(t.a,{href:"#deploy-the-required-contrast-runtimes",children:"see above"}),"), Kubernetes will automatically schedule the workloads to run only on compatible nodes."]}),"\n",(0,r.jsxs)(t.p,{children:["Continue with the remaining steps outlined in ",(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-2180/next/howto/workload-deployment/deployment-file-preparation",children:"deployment files preparation section"}),"."]}),"\n",(0,r.jsx)(t.h3,{id:"generating-the-manifest",children:"Generating the manifest"}),"\n",(0,r.jsxs)(t.p,{children:["In the ",(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-2180/next/howto/workload-deployment/generate-annotations",children:"single-runtime case"}),", the platform is passed to ",(0,r.jsx)(t.code,{children:"contrast generate"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"contrast generate --reference-values <platform> resources/\n"})}),"\n",(0,r.jsxs)(t.p,{children:["This argument has no effect on multi-runtime class deployments ",(0,r.jsx)(t.em,{children:"if"})," each resource has a ",(0,r.jsx)(t.code,{children:"runtimeClassName"})," listed in ",(0,r.jsx)(t.a,{href:"#prepare-deployment-files",children:"the table above"})," set.\nIf your deployment files contain resources with the lower-specificity ",(0,r.jsx)(t.code,{children:"contrast-cc"})," placeholder, pass ",(0,r.jsx)(t.code,{children:"--reference-values"})," to ",(0,r.jsx)(t.code,{children:"contrast generate"}),".\nThe specified platform will be used to determine the runtime class only for these cases.\nThe argument doesn't overwrite the higher-specificity ",(0,r.jsx)(t.code,{children:"runtimeClassNames"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["After successfully running ",(0,r.jsx)(t.code,{children:"contrast generate"})," for the first time, you might be prompted to fill in the reference values for one or more of the used platforms.\nThis works analogously to the ",(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-2180/next/howto/workload-deployment/generate-annotations",children:"single-runtime case"}),"."]})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},28453(e,t,n){n.d(t,{R:()=>i,x:()=>l});var s=n(96540);const r={},o=s.createContext(r);function i(e){const t=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(o.Provider,{value:t},e.children)}}}]);