"use strict";(globalThis.webpackChunkcontrast_docs=globalThis.webpackChunkcontrast_docs||[]).push([[3],{28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>a});var i=n(96540);const r={},s=i.createContext(r);function o(e){const t=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(s.Provider,{value:t},e.children)}},36040:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"howto/registry-authentication","title":"Registry authentication","description":"This guide shows how to set up registry credentials for Contrast.","source":"@site/docs/howto/registry-authentication.md","sourceDirName":"howto","slug":"/howto/registry-authentication","permalink":"/contrast/pr-preview/pr-1900/next/howto/registry-authentication","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/contrast/edit/main/docs/docs/howto/registry-authentication.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Logging","permalink":"/contrast/pr-preview/pr-1900/next/howto/logging"},"next":{"title":"Observability","permalink":"/contrast/pr-preview/pr-1900/next/howto/observability"}}');var r=n(74848),s=n(28453);const o={},a="Registry authentication",c={},l=[{value:"Applicability",id:"applicability",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"How-to",id:"how-to",level:2},{value:"Contrast CLI",id:"contrast-cli",level:3},{value:"Confidential guest VMs",id:"confidential-guest-vms",level:3},{value:"Creating an image puller configuration",id:"creating-an-image-puller-configuration",level:4},{value:"Example 1",id:"example-1",level:5},{value:"Example 2",id:"example-2",level:5},{value:"Example 3",id:"example-3",level:5},{value:"Example 4",id:"example-4",level:5},{value:"Registry matching and subdomains",id:"registry-matching-and-subdomains",level:4},{value:"Multiple matches and global configuration",id:"multiple-matches-and-global-configuration",level:4},{value:"IP addresses and ports",id:"ip-addresses-and-ports",level:4}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"registry-authentication",children:"Registry authentication"})}),"\n",(0,r.jsx)(t.p,{children:"This guide shows how to set up registry credentials for Contrast."}),"\n",(0,r.jsx)(t.h2,{id:"applicability",children:"Applicability"}),"\n",(0,r.jsx)(t.p,{children:"This guide is relevant if you need to authenticate with a container registry for pulling images."}),"\n",(0,r.jsx)(t.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-1900/next/howto/cluster-setup/bare-metal",children:"Set up cluster"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-1900/next/howto/install-cli",children:"Install CLI"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-1900/next/howto/workload-deployment/runtime-deployment",children:"Deploy the Contrast runtime"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-1900/next/howto/workload-deployment/deployment-file-preparation",children:"Prepare deployment files"})}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"how-to",children:"How-to"}),"\n",(0,r.jsx)(t.h3,{id:"contrast-cli",children:"Contrast CLI"}),"\n",(0,r.jsxs)(t.p,{children:["The Contrast CLI, specifically the ",(0,r.jsx)(t.code,{children:"contrast generate"})," subcommand, needs access to the registry to derive policies for the referenced container images.\nThe CLI authenticates to the registry using the ",(0,r.jsx)(t.a,{href:"https://crates.io/crates/docker_credential",children:(0,r.jsx)(t.code,{children:"docker_credential"})})," crate.\nThis crate searches some default locations for a registry authentication file, so it should find credentials created by ",(0,r.jsx)(t.code,{children:"docker login"})," or ",(0,r.jsx)(t.code,{children:"podman login"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["The only authentication method that's currently supported is ",(0,r.jsx)(t.code,{children:"Basic"})," HTTP authentication with user name and password (or personal access token).\nIdentity token flows, such as the default mechanism of plain ",(0,r.jsx)(t.code,{children:"docker login"}),", don't work.\nBasic authentication can be forced with ",(0,r.jsx)(t.code,{children:"docker login -u $REGISTRYUSER"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["You can override the credentials file used by Contrast by setting the environment variable ",(0,r.jsx)(t.code,{children:"DOCKER_CONFIG"}),". This is useful for creating a credential file from scratch, as shown in the following script:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:'#!/bin/sh\n\nregistry="<put registry here>"\nuser="<put user id here>"\npassword="<put client secret here>"\n\nexport DOCKER_CONFIG=$(mktemp)\n\ncat >"${DOCKER_CONFIG}" <<EOF\n{\n        "auths": {\n                "$registry": {\n                        "auth": "$(printf "%s:%s" "$user" "$password" | base64 -w0)"\n                }\n        }\n}\nEOF\n\ncontrast generate "$@"\n'})}),"\n",(0,r.jsx)(t.h3,{id:"confidential-guest-vms",children:"Confidential guest VMs"}),"\n",(0,r.jsxs)(t.p,{children:["For the ",(0,r.jsx)(t.a,{href:"/contrast/pr-preview/pr-1900/next/architecture/components/runtime#contrast-image-puller",children:"Contrast image puller"})," to be able to pull images from a private registry, it must be configured with the required authentication details.\nContrast uses its own ",(0,r.jsx)(t.code,{children:"TOML"}),"-based configuration format for this purpose.\nThis configuration must be provided as a secret to the ",(0,r.jsxs)(t.a,{href:"/contrast/pr-preview/pr-1900/next/architecture/components/runtime#node-installer-daemonset",children:["node installer ",(0,r.jsx)(t.code,{children:"DaemonSet"})]}),".\nThe node installer then handles installing the secret in the runtime directory on the host, from where the runtime then forwards it to the confidential pod VM, allowing the image puller to read it."]}),"\n",(0,r.jsxs)(t.admonition,{title:"Confidentiality and integrity of the configuration",type:"warning",children:[(0,r.jsxs)(t.p,{children:["Kubernetes secrets are accessible to anyone with API access to the node, as well as anyone with access to ",(0,r.jsx)(t.code,{children:"etcd"})," (",(0,r.jsx)(t.a,{href:"https://kubernetes.io/docs/concepts/configuration/secret/",children:"source"}),").\nAnyone with these permissions is additionally able to change the configuration's content, with no way for Contrast to verify the integrity of the configuration eventually received by the image puller."]}),(0,r.jsx)(t.p,{children:"This allows an attacker to redirect image pull requests and configure an attacker-controlled registry to appear as legitimate.\nThe attacker could then, for example, log which images are being pulled."}),(0,r.jsxs)(t.p,{children:["This does ",(0,r.jsx)(t.strong,{children:"not"})," allow an attacker to serve malicious images or alter the contents of valid images, since contrary to the image puller's configuration,\npulled images are integrity-protected through their mandatory pinned digest."]})]}),"\n",(0,r.jsx)(t.h4,{id:"creating-an-image-puller-configuration",children:"Creating an image puller configuration"}),"\n",(0,r.jsx)(t.p,{children:"Various configuration options are available, both globally and per-registry.\nThe following table shows the available global configuration options."}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"Option"}),(0,r.jsx)(t.th,{children:"Description"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"extra-env.HTTP_PROXY"})}),(0,r.jsx)(t.td,{children:"proxy to use for plain HTTP requests"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"extra-env.HTTPS_PROXY"})}),(0,r.jsx)(t.td,{children:"proxy to use for HTTPS requests"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"extra-env.NO_PROXY"})}),(0,r.jsx)(t.td,{children:"registry domains for which the proxy should be bypassed"})]})]})]}),"\n",(0,r.jsxs)(t.p,{children:["Additionally, for each individual registry, for example ",(0,r.jsx)(t.code,{children:"example.com"}),", the following options are available under ",(0,r.jsx)(t.code,{children:'registries.".example.com."'}),":"]}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"Option"}),(0,r.jsx)(t.th,{children:"Description"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"ca-certs"})}),(0,r.jsx)(t.td,{children:"a newline-concatenated list of PEM-encoded certificates"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"insecure-skip-verify"})}),(0,r.jsx)(t.td,{children:"disable transport security"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"username"})}),(0,r.jsxs)(t.td,{children:["username, used together with ",(0,r.jsx)(t.code,{children:"password"})," to authenticate with the registry"]})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"password"})}),(0,r.jsxs)(t.td,{children:["password, used together with ",(0,r.jsx)(t.code,{children:"username"})," to authenticate with the registry"]})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"auth"})}),(0,r.jsx)(t.td,{children:"an auth token authenticating the user with the registry"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"identitytoken"})}),(0,r.jsx)(t.td,{children:"used to authenticate the user and get an access token for the registry"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"registrytoken"})}),(0,r.jsx)(t.td,{children:"a bearer token to be sent to the registry"})]})]})]}),"\n",(0,r.jsxs)(t.p,{children:["Which of the authentication-related options (",(0,r.jsx)(t.code,{children:"username"})," and ",(0,r.jsx)(t.code,{children:"password"}),", ",(0,r.jsx)(t.code,{children:"auth"}),", ",(0,r.jsx)(t.code,{children:"identitytoken"})," and ",(0,r.jsx)(t.code,{children:"registrytoken"}),") are required depends on the configuration of your registry.\nThe ability to specify CA certificates mainly serves two purposes, namely allowing connections to registries that aren't publicly trusted in the web PKI,\nand to restrict who can ostensibly intercept and log traffic for metadata analysis."]}),"\n",(0,r.jsx)(t.p,{children:"A number of example configurations for various use-case scenarios are shown below."}),"\n",(0,r.jsx)(t.h5,{id:"example-1",children:"Example 1"}),"\n",(0,r.jsxs)(t.p,{children:["In this scenario, there's an internal registry at ",(0,r.jsx)(t.code,{children:"registry.corp"})," for workload images, but ",(0,r.jsx)(t.code,{children:"ghcr.io"})," is used for Contrast images.\nThe internal registry is served from within the corporate firewall, while access to external registries is mediated by a proxy.\nOther registries are allowed, as long as they don't require authentication."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml",children:'[extra-env]\nHTTP_PROXY = "https://proxy.corp"\nHTTPS_PROXY = "https://proxy.corp"\nNO_PROXY = ".corp"\n\n[registries."registry.corp."]\nca-certs = \'\'\'\n-----BEGIN CERTIFICATE-----\nMIIBezCCASGgAwIBAgIUUugBbePTzyVApU4DLSMmHnXXjcwwCgYIKoZIzj0EAwIw\nEzERMA8GA1UEAwwIWW91ck5hbWUwHhcNMjUxMDIxMTUwNDI0WhcNMjYxMDIxMTUw\nNDI0WjATMREwDwYDVQQDDAhZb3VyTmFtZTBZMBMGByqGSM49AgEGCCqGSM49AwEH\nA0IABIgsA5IEeiBq6jDpH2ttxrI96beeOqa+EpGqmznQmzpFkPEpLWMUt21Ien71\nrxdeFC7ySuuu95VPjSvO7EUM9qyjUzBRMB0GA1UdDgQWBBTVnuI2o36Mrja3RvwE\n82lWg2m19zAfBgNVHSMEGDAWgBTVnuI2o36Mrja3RvwE82lWg2m19zAPBgNVHRMB\nAf8EBTADAQH/MAoGCCqGSM49BAMCA0gAMEUCIGmEkl8jxjxqyAxs3QoAXeIx++Bz\nZm9dwbeTbrKysrGXAiEA8ce6iyJUCZCZVVJs/HDLcPbOKc2EPZvdcGGjIlGXulo=\n-----END CERTIFICATE-----\n\'\'\'\n\n[registries."ghcr.io."]\nauth = "YnVyZ2VyZGV2OnRoaXNpc25vdG15cGFzc3dvcmQ="\n'})}),"\n",(0,r.jsx)(t.h5,{id:"example-2",children:"Example 2"}),"\n",(0,r.jsx)(t.p,{children:"In this scenario, all container images are served from a public registry.\nHowever, the image owner wants to make sure that the traffic can't be intercepted by rogue CAs.\nOther registries are strictly forbidden."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml",children:'[registries."very-secure.registri.es."]\nauth = "bmljZTp0cnk="\nca-certs = \'\'\'\nRoot CA 1\n-----BEGIN CERTIFICATE-----\nMIIBfDCCASGgAwIBAgIUU5G42y9bIh8+AU38qVOmKocc0CwwCgYIKoZIzj0EAwIw\nEzERMA8GA1UEAwwIWW91ck5hbWUwHhcNMjUxMDIxMTUyNzEwWhcNMjYxMDIxMTUy\nNzEwWjATMREwDwYDVQQDDAhZb3VyTmFtZTBZMBMGByqGSM49AgEGCCqGSM49AwEH\nA0IABOJlyBb/sHBmHRncTqk4lm6hBkBYlZGcScXfl/IuAVVIo4zCGBzCmvc7jYc2\n+gyVp+wxuvm7NRza4e1QOfJfrxOjUzBRMB0GA1UdDgQWBBTRE8qju+GIWzr5xCik\nMdBJFOd1lzAfBgNVHSMEGDAWgBTRE8qju+GIWzr5xCikMdBJFOd1lzAPBgNVHRMB\nAf8EBTADAQH/MAoGCCqGSM49BAMCA0kAMEYCIQCn+fVmAzB8HOakKGLx6oXF0WP0\nGJibphhjfHPdNWEDdQIhAN3KFNWIYtE35+/rZb5I+oVKnqKS8igdIU9lXmpOps1j\n-----END CERTIFICATE-----\nRoot CA 2\n-----BEGIN CERTIFICATE-----\nMIIBezCCASGgAwIBAgIUUugBbePTzyVApU4DLSMmHnXXjcwwCgYIKoZIzj0EAwIw\nEzERMA8GA1UEAwwIWW91ck5hbWUwHhcNMjUxMDIxMTUwNDI0WhcNMjYxMDIxMTUw\nNDI0WjATMREwDwYDVQQDDAhZb3VyTmFtZTBZMBMGByqGSM49AgEGCCqGSM49AwEH\nA0IABIgsA5IEeiBq6jDpH2ttxrI96beeOqa+EpGqmznQmzpFkPEpLWMUt21Ien71\nrxdeFC7ySuuu95VPjSvO7EUM9qyjUzBRMB0GA1UdDgQWBBTVnuI2o36Mrja3RvwE\n82lWg2m19zAfBgNVHSMEGDAWgBTVnuI2o36Mrja3RvwE82lWg2m19zAPBgNVHRMB\nAf8EBTADAQH/MAoGCCqGSM49BAMCA0gAMEUCIGmEkl8jxjxqyAxs3QoAXeIx++Bz\nZm9dwbeTbrKysrGXAiEA8ce6iyJUCZCZVVJs/HDLcPbOKc2EPZvdcGGjIlGXulo=\n-----END CERTIFICATE-----\n\'\'\'\n\n[registries."."]\nca-certs = "no PEM here means no CA certificates"\n'})}),"\n",(0,r.jsx)(t.h5,{id:"example-3",children:"Example 3"}),"\n",(0,r.jsx)(t.p,{children:"In this scenario, there's an HTTP-only registry deployed into the cluster for ease of use.\nTransport security for this internal registry isn't important to the operators.\nOther registries should be used anonymously, but with TLS."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml",children:'[registries."registry.default.svc.cluster.local."]\ninsecure-skip-verify = true\n'})}),"\n",(0,r.jsx)(t.h5,{id:"example-4",children:"Example 4"}),"\n",(0,r.jsx)(t.p,{children:"This scenario is equivalent to the prior behavior: web PKI and no authentication."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml"})}),"\n",(0,r.jsx)(t.h4,{id:"registry-matching-and-subdomains",children:"Registry matching and subdomains"}),"\n",(0,r.jsxs)(t.p,{children:["Registry domains are specified as fully qualified domain names.\nNote the trailing dot in the examples above.\nFor a registry-specific configuration to be applied to a pull request, the image's registry must end exactly in the configuration's name.\nA configuration above for ",(0,r.jsx)(t.code,{children:'registries.".registry.corp."'})," will be applied to any and all registries available on subdomains of ",(0,r.jsx)(t.code,{children:"registry.corp"}),", but not to ",(0,r.jsx)(t.code,{children:"registry.corp"})," itself.\nPulling the image ",(0,r.jsx)(t.code,{children:"example.registry.corp/example/image@sha256:..."})," will use the configuration given under ",(0,r.jsx)(t.code,{children:'registries.".registry.corp."'}),", but ",(0,r.jsx)(t.code,{children:"registry.corp/example/image@sha256:..."})," won't."]}),"\n",(0,r.jsxs)(t.p,{children:["Additionally, ",(0,r.jsx)(t.code,{children:"example.registry.corp"})," must be able to prove its identity by successfully completing a TLS handshake using one of the explicitly configured certificates.\nIf no certificates are configured, the hosts default web PKI certificates are used."]}),"\n",(0,r.jsx)(t.h4,{id:"multiple-matches-and-global-configuration",children:"Multiple matches and global configuration"}),"\n",(0,r.jsxs)(t.p,{children:["If multiple matching registry configurations exist, for example if both ",(0,r.jsx)(t.code,{children:'registries.".registry.corp."'})," and ",(0,r.jsx)(t.code,{children:'registries.".corp."'})," have configuration values set, then the most specific match will be chosen.\nIn the example, this would be ",(0,r.jsx)(t.code,{children:'registries.".registry.corp."'}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["To specify a catch-all configuration, use the key ",(0,r.jsx)(t.code,{children:'registries."."'}),".\nThe option ",(0,r.jsx)(t.code,{children:'registries.".".ca-certs'})," can be used to disable authentication with all unknown registries:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml",children:"[registries.\".\"]\nca-certs = '''\nThis option set, but no certificates provided, means no TLS handshake will succeed.\n'''\n"})}),"\n",(0,r.jsx)(t.h4,{id:"ip-addresses-and-ports",children:"IP addresses and ports"}),"\n",(0,r.jsx)(t.p,{children:"Currently, IP- and port-based configuration isn't supported.\nPlease use Kubernetes' built-in tools to assign unique domain names to IP addresses, and use these for image references instead."})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);