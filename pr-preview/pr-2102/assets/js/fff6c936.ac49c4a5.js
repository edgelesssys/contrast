"use strict";(globalThis.webpackChunkcontrast_docs=globalThis.webpackChunkcontrast_docs||[]).push([[40768],{22680(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"howto/workload-deployment/generate-annotations","title":"Generate initdata annotations and manifest","description":"This step updates your deployment files with initdata annotations and automatically generates the deployment manifest.","source":"@site/versioned_docs/version-1.14/howto/workload-deployment/generate-annotations.md","sourceDirName":"howto/workload-deployment","slug":"/howto/workload-deployment/generate-annotations","permalink":"/contrast/pr-preview/pr-2102/1.14/howto/workload-deployment/generate-annotations","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/contrast/edit/main/docs/versioned_docs/version-1.14/howto/workload-deployment/generate-annotations.md","tags":[],"version":"1.14","frontMatter":{},"sidebar":"docs","previous":{"title":"Enable GPU support","permalink":"/contrast/pr-preview/pr-2102/1.14/howto/workload-deployment/GPU-configuration"},"next":{"title":"Deploy application","permalink":"/contrast/pr-preview/pr-2102/1.14/howto/workload-deployment/deploy-application"}}');var i=t(74848),a=t(28453);const o={},s="Generate initdata annotations and manifest",l={},c=[{value:"Applicability",id:"applicability",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"How-to",id:"how-to",level:2},{value:"Fine-tuning initializer injection",id:"fine-tuning-initializer-injection",level:3},{value:"<code>--skip-initializer</code> flag",id:"--skip-initializer-flag",level:4},{value:"<code>skip-initializer</code> annotation",id:"skip-initializer-annotation",level:4},{value:"Manual Initializer injection",id:"manual-initializer-injection",level:4},{value:"Fine-tuning service mesh injection",id:"fine-tuning-service-mesh-injection",level:3},{value:"<code>--skip-service-mesh</code> flag",id:"--skip-service-mesh-flag",level:4}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components},{TabItem:t,Tabs:r}=n;return t||p("TabItem",!0),r||p("Tabs",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"generate-initdata-annotations-and-manifest",children:"Generate initdata annotations and manifest"})}),"\n",(0,i.jsx)(n.p,{children:"This step updates your deployment files with initdata annotations and automatically generates the deployment manifest."}),"\n",(0,i.jsx)(n.h2,{id:"applicability",children:"Applicability"}),"\n",(0,i.jsx)(n.p,{children:"This step is required for all Contrast deployments."}),"\n",(0,i.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/contrast/pr-preview/pr-2102/1.14/howto/cluster-setup/bare-metal",children:"Set up cluster"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/contrast/pr-preview/pr-2102/1.14/howto/install-cli",children:"Install CLI"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/contrast/pr-preview/pr-2102/1.14/howto/workload-deployment/runtime-deployment",children:"Deploy the Contrast runtime"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/contrast/pr-preview/pr-2102/1.14/howto/workload-deployment/add-coordinator",children:"Add Coordinator to resources"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/contrast/pr-preview/pr-2102/1.14/howto/workload-deployment/deployment-file-preparation",children:"Prepare deployment files"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/contrast/pr-preview/pr-2102/1.14/howto/workload-deployment/TLS-configuration",children:"Configure TLS (optional)"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/contrast/pr-preview/pr-2102/1.14/howto/workload-deployment/GPU-configuration",children:"Enable GPU support (optional)"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"how-to",children:"How-to"}),"\n",(0,i.jsxs)(n.p,{children:["Run the ",(0,i.jsx)(n.code,{children:"generate"})," command to add the necessary components to your deployment files.\nThis will add the Contrast Initializer to every workload with the specified ",(0,i.jsx)(n.code,{children:"contrast-cc"})," runtime class\nand the Contrast Service Mesh to all workloads that have a specified configuration.\nAfter that, it will generate the ",(0,i.jsx)(n.a,{href:"/contrast/pr-preview/pr-2102/1.14/architecture/components/policies",children:"execution policies"}),", wrap them in initdata documents and add them as annotations to your deployment files.\nA ",(0,i.jsx)(n.code,{children:"manifest.json"})," with the reference values of your deployment will be created."]}),"\n",(0,i.jsxs)(r,{queryString:"platform",children:[(0,i.jsxs)(t,{value:"metal-qemu-snp",label:"Bare metal (SEV-SNP)",children:[(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-snp resources/\n"})}),(0,i.jsxs)(n.p,{children:["On bare-metal SEV-SNP, ",(0,i.jsx)(n.code,{children:"contrast generate"})," is unable to fill in the ",(0,i.jsx)(n.code,{children:"MinimumTCB"})," values as they can vary between platforms and CPU models.\nThey will have to be filled in manually."]}),(0,i.jsxs)(n.p,{children:["AMD doesn't provide an accessible way to acquire the latest TCB values for your platform.\nVisit the ",(0,i.jsx)(n.a,{href:"https://www.amd.com/en/developer/sev.html",children:"AMD SEV developer portal"})," and download the latest firmware package for your processor family.\nUnpack and inspect the contained release notes, which state the SNP firmware SVN (called ",(0,i.jsx)(n.code,{children:"SPL"})," (security patch level) in that document).\nContact your hardware vendor or BIOS firmware provider for information about the other TCB components"]}),(0,i.jsxs)(n.p,{children:["To check the current TCB level of your platform, use the ",(0,i.jsx)(n.a,{href:"https://github.com/virtee/snphost",children:(0,i.jsx)(n.code,{children:"snphost"})}),":"]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"snphost show tcb\n"})}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-console",children:"Reported TCB: TCB Version:\n  Microcode:   72\n  SNP:         23\n  TEE:         0\n  Boot Loader: 9\n  FMC:         None\nPlatform TCB: TCB Version:\n  Microcode:   72\n  SNP:         23\n  TEE:         0\n  Boot Loader: 9\n  FMC:         None\n"})}),(0,i.jsxs)(n.p,{children:["The values listed as ",(0,i.jsx)(n.code,{children:"Reported TCB"})," to should be greater or equal to the ",(0,i.jsx)(n.code,{children:"MinimumTCB"})," values in ",(0,i.jsx)(n.code,{children:"manifest.json"}),".\nThe ",(0,i.jsx)(n.code,{children:"Platform TCB"})," can be higher than the ",(0,i.jsx)(n.code,{children:"Reported TCB"}),", in this case, the platform has provisional firmware enrolled.\nContrast relies on the committed TCB values, as provisional firmware can be rolled back anytime by the platform operator."]}),(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsxs)(n.p,{children:["The TCB values observed on the target platform using ",(0,i.jsx)(n.code,{children:"snphost"})," might not be trustworthy.\nYour channel to the system or the system itself might be compromised.\nThe deployed firmware could be outdated and vulnerable."]})})]}),(0,i.jsxs)(t,{value:"metal-qemu-snp-gpu",label:"Bare metal (SEV-SNP, with GPU support)",children:[(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-snp-gpu resources/\n"})}),(0,i.jsxs)(n.p,{children:["On bare-metal SEV-SNP, ",(0,i.jsx)(n.code,{children:"contrast generate"})," is unable to fill in the ",(0,i.jsx)(n.code,{children:"MinimumTCB"})," values as they can vary between platforms and CPU models.\nThey will have to be filled in manually."]}),(0,i.jsxs)(n.p,{children:["AMD doesn't provide an accessible way to acquire the latest TCB values for your platform.\nVisit the ",(0,i.jsx)(n.a,{href:"https://www.amd.com/en/developer/sev.html",children:"AMD SEV developer portal"})," and download the latest firmware package for your processor family.\nUnpack and inspect the contained release notes, which state the SNP firmware SVN (called ",(0,i.jsx)(n.code,{children:"SPL"})," (security patch level) in that document).\nContact your hardware vendor or BIOS firmware provider for information about the other TCB components"]}),(0,i.jsxs)(n.p,{children:["To check the current TCB level of your platform, use the ",(0,i.jsx)(n.a,{href:"https://github.com/virtee/snphost",children:(0,i.jsx)(n.code,{children:"snphost"})}),":"]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"snphost show tcb\n"})}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-console",children:"Reported TCB: TCB Version:\n  Microcode:   72\n  SNP:         23\n  TEE:         0\n  Boot Loader: 9\n  FMC:         None\nPlatform TCB: TCB Version:\n  Microcode:   72\n  SNP:         23\n  TEE:         0\n  Boot Loader: 9\n  FMC:         None\n"})}),(0,i.jsxs)(n.p,{children:["The values listed as ",(0,i.jsx)(n.code,{children:"Reported TCB"})," to should be greater or equal to the ",(0,i.jsx)(n.code,{children:"MinimumTCB"})," values in ",(0,i.jsx)(n.code,{children:"manifest.json"}),".\nThe ",(0,i.jsx)(n.code,{children:"Platform TCB"})," can be higher than the ",(0,i.jsx)(n.code,{children:"Reported TCB"}),", in this case, the platform has provisional firmware enrolled.\nContrast relies on the committed TCB values, as provisional firmware can be rolled back anytime by the platform operator."]}),(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsxs)(n.p,{children:["The TCB values observed on the target platform using ",(0,i.jsx)(n.code,{children:"snphost"})," might not be trustworthy.\nYour channel to the system or the system itself might be compromised.\nThe deployed firmware could be outdated and vulnerable."]})})]}),(0,i.jsxs)(t,{value:"metal-qemu-tdx",label:"Bare metal (TDX)",children:[(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-tdx resources/\n"})}),(0,i.jsxs)(n.p,{children:["On bare-metal TDX, ",(0,i.jsx)(n.code,{children:"contrast generate"})," is unable to fill in the ",(0,i.jsx)(n.code,{children:"MrSeam"})," value as it depends on your platform configuration.\nIt will have to be filled in manually."]}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"MrSeam"})," is the SHA384 hash of the TDX module.\nYou should retrieve the TDX module via a trustworthy channel from Intel, for example by downloading the TDX module ",(0,i.jsx)(n.a,{href:"https://github.com/intel/confidential-computing.tdx.tdx-module/releases",children:"from Intel's GitHub repository"})," and hashing the module on a trusted machine.\nYou can also reproduce the release artifact by following the build instructions linked in the release notes."]}),(0,i.jsx)(n.p,{children:"You can check the hash of the in-use TDX module by executing"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"sha384sum /boot/efi/EFI/TDX/TDX-SEAM.so | cut -d' ' -f1\n"})}),(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsxs)(n.p,{children:["The TDX module hash (",(0,i.jsx)(n.code,{children:"MrSeam"}),") observed on the target platform might not be trustworthy.\nYour channel to the system or the system itself might be compromised.\nMake sure to retrieve or reproduce the value on a trusted machine."]})})]})]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"generate"})," command needs to pull the container images to derive policies.\nRunning ",(0,i.jsx)(n.code,{children:"generate"})," for the first time can take a while, especially if the images are large.\nIf your container registry requires authentication, you can create the necessary credentials with ",(0,i.jsx)(n.code,{children:"docker login"})," or ",(0,i.jsx)(n.code,{children:"podman login"}),".\nBe aware of the ",(0,i.jsx)(n.a,{href:"/contrast/pr-preview/pr-2102/1.14/architecture/features-limitations#kubernetes-features",children:"registry authentication limitation"})," on bare metal."]}),"\n",(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsxs)(n.p,{children:["Please be aware that runtime policies currently have some blind spots.\nFor example, they can't guarantee the starting order of containers.\nSee the ",(0,i.jsx)(n.a,{href:"/contrast/pr-preview/pr-2102/1.14/architecture/features-limitations#runtime-policies",children:"current limitations"})," for more details."]})}),"\n",(0,i.jsxs)(n.p,{children:["Running ",(0,i.jsx)(n.code,{children:"contrast generate"})," for the first time creates some additional files in the working directory:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"seedshare-owner.pem"})," is required for handling the secret seed and recovering the Coordinator (see ",(0,i.jsx)(n.a,{href:"/contrast/pr-preview/pr-2102/1.14/architecture/secrets",children:"Secrets & recovery"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"workload-owner.pem"})," is required for manifest updates after the initial ",(0,i.jsx)(n.code,{children:"contrast set"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"rules.rego"})," and ",(0,i.jsx)(n.code,{children:"settings.json"})," are the basis for ",(0,i.jsx)(n.a,{href:"/contrast/pr-preview/pr-2102/1.14/architecture/components/policies",children:"runtime policies"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"layers-cache.json"})," caches container image layer information for your deployments to speed up subsequent runs of ",(0,i.jsx)(n.code,{children:"contrast generate"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"fine-tuning-initializer-injection",children:"Fine-tuning initializer injection"}),"\n",(0,i.jsx)(n.p,{children:"If you don't want the Contrast Initializer to automatically be added to your\nworkloads, there are two ways you can skip the Initializer injection step,\ndepending on how you want to customize your deployment."}),"\n",(0,i.jsxs)(n.h4,{id:"--skip-initializer-flag",children:[(0,i.jsx)(n.code,{children:"--skip-initializer"})," flag"]}),"\n",(0,i.jsxs)(n.p,{children:["You can disable the Initializer injection completely by specifying the\n",(0,i.jsx)(n.code,{children:"--skip-initializer"})," flag in the ",(0,i.jsx)(n.code,{children:"generate"})," command."]}),"\n",(0,i.jsxs)(r,{queryString:"platform",children:[(0,i.jsx)(t,{value:"metal-qemu-snp",label:"Bare metal (SEV-SNP)",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-snp --skip-initializer resources/\n"})})}),(0,i.jsx)(t,{value:"metal-qemu-snp-gpu",label:"Bare metal (SEV-SNP, with GPU support)",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-snp-gpu --skip-initializer resources/\n"})})}),(0,i.jsx)(t,{value:"metal-qemu-tdx",label:"Bare metal (TDX)",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-tdx --skip-initializer resources/\n"})})})]}),"\n",(0,i.jsxs)(n.h4,{id:"skip-initializer-annotation",children:[(0,i.jsx)(n.code,{children:"skip-initializer"})," annotation"]}),"\n",(0,i.jsxs)(n.p,{children:["If you want to disable the Initializer injection for a specific workload with\nthe ",(0,i.jsx)(n.code,{children:"contrast-cc"})," runtime class, you can do so by adding an annotation to the workload."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'metadata: # v1.Pod, v1.PodTemplateSpec\n  annotations:\n    contrast.edgeless.systems/skip-initializer: "true"\n'})}),"\n",(0,i.jsx)(n.h4,{id:"manual-initializer-injection",children:"Manual Initializer injection"}),"\n",(0,i.jsxs)(n.p,{children:["When disabling the automatic Initializer injection, you can manually add the\nInitializer as a sidecar container to your workload before generating the\npolicies. Configure the workload to use the certificates written to the\n",(0,i.jsx)(n.code,{children:"contrast-secrets"})," ",(0,i.jsx)(n.code,{children:"volumeMount"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'# v1.PodSpec\nspec:\n  initContainers:\n    - env:\n        - name: COORDINATOR_HOST\n          value: coordinator-ready\n      image: "ghcr.io/edgelesssys/contrast/initializer:v1.14.0@sha256:5c822446ce7c908c8debac6a2fe8327ec89178e6cab983b9393d063acb8eccb2"\n      name: contrast-initializer\n      volumeMounts:\n        - mountPath: /contrast\n          name: contrast-secrets\n  volumes:\n    - emptyDir: {}\n      name: contrast-secrets\n'})}),"\n",(0,i.jsx)(n.h3,{id:"fine-tuning-service-mesh-injection",children:"Fine-tuning service mesh injection"}),"\n",(0,i.jsxs)(n.p,{children:["The service mesh is only injected for workload that have a ",(0,i.jsx)(n.a,{href:"/contrast/pr-preview/pr-2102/1.14/architecture/components/service-mesh#configuring-the-proxy",children:"service mesh annotation"}),"."]}),"\n",(0,i.jsxs)(n.h4,{id:"--skip-service-mesh-flag",children:[(0,i.jsx)(n.code,{children:"--skip-service-mesh"})," flag"]}),"\n",(0,i.jsxs)(n.p,{children:["You can disable the service mesh injection completely by specifying the\n",(0,i.jsx)(n.code,{children:"--skip-service-mesh"})," flag in the ",(0,i.jsx)(n.code,{children:"generate"})," command."]}),"\n",(0,i.jsxs)(r,{queryString:"platform",children:[(0,i.jsx)(t,{value:"metal-qemu-snp",label:"Bare metal (SEV-SNP)",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-snp --skip-service-mesh resources/\n"})})}),(0,i.jsx)(t,{value:"metal-qemu-snp-gpu",label:"Bare metal (SEV-SNP, with GPU support)",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-snp-gpu --skip-service-mesh resources/\n"})})}),(0,i.jsx)(t,{value:"metal-qemu-tdx",label:"Bare metal (TDX)",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"contrast generate --reference-values metal-qemu-tdx --skip-service-mesh resources/\n"})})})]}),"\n",(0,i.jsxs)(n.p,{children:["In this case, you can manually add the service mesh sidecar container to your workload before generating the policies, or ",(0,i.jsx)(n.a,{href:"/contrast/pr-preview/pr-2102/1.14/howto/workload-deployment/TLS-configuration#go-integration",children:"authenticate peers on the application level"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}function p(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},28453(e,n,t){t.d(n,{R:()=>o,x:()=>s});var r=t(96540);const i={},a=r.createContext(i);function o(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);