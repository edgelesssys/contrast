"use strict";(globalThis.webpackChunkcontrast_docs=globalThis.webpackChunkcontrast_docs||[]).push([[18986],{56246(e,n,s){s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"howto/secure-image-store","title":"Configuring the secure image store","description":"This section provides guidance on how to configure Contrast\'s secure image store feature, allowing you to adapt it to fit with your memory constraints and security requirements.","source":"@site/docs/howto/secure-image-store.md","sourceDirName":"howto","slug":"/howto/secure-image-store","permalink":"/contrast/next/howto/secure-image-store","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/contrast/edit/main/docs/docs/howto/secure-image-store.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Vault","permalink":"/contrast/next/howto/vault"},"next":{"title":"Multi-runtime class","permalink":"/contrast/next/howto/multi-runtime-class"}}');var t=s(74848),r=s(28453);const o={},a="Configuring the secure image store",c={},d=[{value:"Applicability",id:"applicability",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"How-To",id:"how-to",level:2},{value:"Adjusting the size of the image store",id:"adjusting-the-size-of-the-image-store",level:3},{value:"Disabling the image store for a single pod",id:"disabling-the-image-store-for-a-single-pod",level:3},{value:"Manual image store setup",id:"manual-image-store-setup",level:3},{value:"Memory considerations when disabling the secure image store",id:"memory-considerations-when-disabling-the-secure-image-store",level:2},{value:"CSI driver considerations",id:"csi-driver-considerations",level:2}];function l(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"configuring-the-secure-image-store",children:"Configuring the secure image store"})}),"\n",(0,t.jsx)(n.p,{children:"This section provides guidance on how to configure Contrast's secure image store feature, allowing you to adapt it to fit with your memory constraints and security requirements."}),"\n",(0,t.jsx)(n.h2,{id:"applicability",children:"Applicability"}),"\n",(0,t.jsx)(n.p,{children:"Storing container images on an encrypted ephemeral disk instead of in-memory reduces the amount of memory required.\nThis is especially beneficial in deployments with tight memory constraints, or if your container images are very large in size."}),"\n",(0,t.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsx)(n.p,{children:"A running Contrast deployment."}),"\n",(0,t.jsx)(n.h2,{id:"how-to",children:"How-To"}),"\n",(0,t.jsxs)(n.p,{children:["The secure image store is disabled by default, and images are therefore pulled into memory.\nTo enable the image store, specify the ",(0,t.jsx)(n.code,{children:"--inject-image-store"})," flag in the ",(0,t.jsx)(n.code,{children:"contrast generate"})," command, then apply your deployment:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"contrast generate --inject-image-store resources/\nkubectl apply -f resources/\n"})}),"\n",(0,t.jsxs)(n.p,{children:["By default, this provides each pod with ",(0,t.jsx)(n.code,{children:"10Gi"})," of storage.\nThis amount can be adjusted on a per-pod basis, and the feature can be disabled for individual pods."]}),"\n",(0,t.jsxs)(n.p,{children:["Possible use-cases include the accommodation of very large images, or working in environments where memory restrictions are tight, and the ",(0,t.jsx)(n.a,{href:"./hardening#limitations-inherent-to-policy-checking",children:"slight weakening of the security posture"})," is acceptable."]}),"\n",(0,t.jsx)(n.h3,{id:"adjusting-the-size-of-the-image-store",children:"Adjusting the size of the image store"}),"\n",(0,t.jsx)(n.p,{children:"Add the following annotation to one of your pod definitions:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"metadata: # v1.Pod, v1.PodTemplateSpec\n  annotations:\n    contrast.edgeless.systems/image-store-size: 250Gi\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Rerun ",(0,t.jsx)(n.code,{children:"contrast generate"})," and reapply your deployment for the change to take effect:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"contrast generate resources/\nkubectl apply -f resources/\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.a,{href:"/contrast/next/howto/encrypted-storage#configuration",children:"sizing recommendations for secure persistent storage"})," apply to the image store, too."]}),"\n",(0,t.jsx)(n.h3,{id:"disabling-the-image-store-for-a-single-pod",children:"Disabling the image store for a single pod"}),"\n",(0,t.jsxs)(n.p,{children:["To disable the secure image store for a specific pod, set the value of the shown annotation to ",(0,t.jsx)(n.code,{children:'"0"'}),", without a unit:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'metadata: # v1.Pod, v1.PodTemplateSpec\n  annotations:\n    contrast.edgeless.systems/image-store-size: "0"\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.em,{children:["(The quotation marks around ",(0,t.jsx)(n.code,{children:'"0"'})," are required for the value to be treated as a string.)"]})}),"\n",(0,t.jsxs)(n.p,{children:["Rerun ",(0,t.jsx)(n.code,{children:"contrast generate"})," and reapply your deployment for the change to take effect:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"contrast generate resources/\nkubectl apply -f resources/\n"})}),"\n",(0,t.jsx)(n.h3,{id:"manual-image-store-setup",children:"Manual image store setup"}),"\n",(0,t.jsxs)(n.p,{children:["If you need further customization, for example because you require the use of a custom ",(0,t.jsx)(n.a,{href:"https://kubernetes-csi.github.io/docs/drivers.html",children:"CSI driver"}),",\nyou can disable the image store injection (either ",(0,t.jsx)(n.a,{href:"#disabling-the-image-store-for-a-single-pod",children:"for a single pod"})," or globally by omitting the ",(0,t.jsx)(n.code,{children:"--inject-image-store"})," flag, and instead provide your own image store."]}),"\n",(0,t.jsxs)(n.p,{children:["Internally, whether or not the image store is used depends exclusively on the presence of the magic device ",(0,t.jsx)(n.code,{children:"/dev/image_store"}),".\nIf a device with this name is present in the pod-VM, it will be prepared, mounted and used as the secure image store.\nThis requires that the device is bound to a ",(0,t.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/workloads/pods/sidecar-containers/",children:"sidecar container"}),".\nTo the definition of the pod for which you wish to handle the secure image store manually, add a sidecar ",(0,t.jsx)(n.code,{children:"initContainer"})," and an ephemeral volume:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'spec: # v1.Pod, v1.PodTemplateSpec\n  initContainers:\n    - image: "my-image@sha256:..."\n      command:\n        - /usr/local/bin/bash\n        - "-c"\n        - sleep infinity\n      name: my-image-store\n      resources:\n        limits:\n          memory: 50Mi\n        requests:\n          memory: 50Mi\n      restartPolicy: Always\n      securityContext:\n        privileged: true\n      volumeDevices:\n        - devicePath: /dev/image_store\n          name: image-store\n  volumes:\n    - ephemeral:\n        volumeClaimTemplate:\n          spec:\n            accessModes:\n              - ReadWriteOnce\n            resources:\n              requests:\n                storage: 10Gi\n            volumeMode: Block\n      name: image-store\n'})}),"\n",(0,t.jsx)(n.p,{children:"The configuration shown above creates a volume and a sidecar container to which it's bound.\nAll subsequent image pulls will target this volume.\nAdjust the configuration to your liking, within the bounds of the following requirements:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["The volume ",(0,t.jsx)(n.strong,{children:"must"})," be bound to an ",(0,t.jsx)(n.code,{children:"initContainer"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["This ",(0,t.jsx)(n.code,{children:"initContainer"})," ",(0,t.jsx)(n.strong,{children:"must"})," run for the entire lifetime of the deployment."]}),"\n",(0,t.jsxs)(n.li,{children:["Its ",(0,t.jsx)(n.code,{children:"restartPolicy"})," ",(0,t.jsx)(n.strong,{children:"must"})," be ",(0,t.jsx)(n.code,{children:"Always"}),", as this is what turns the ",(0,t.jsx)(n.code,{children:"initContainer"})," into a sidecar container."]}),"\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.code,{children:"devicePath"})," under which the volume is mounted ",(0,t.jsx)(n.strong,{children:"must"})," be ",(0,t.jsx)(n.code,{children:"/dev/image_store"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"memory-considerations-when-disabling-the-secure-image-store",children:"Memory considerations when disabling the secure image store"}),"\n",(0,t.jsxs)(n.p,{children:["If the Contrast secure image store feature is disabled, container images are pulled and uncompressed into encrypted memory.\nMemory limits must be adjusted accordingly.\nSee ",(0,t.jsx)(n.a,{href:"./workload-deployment/deployment-file-preparation#pod-resources",children:"Pod resources"})," for details."]}),"\n",(0,t.jsx)(n.h2,{id:"csi-driver-considerations",children:"CSI driver considerations"}),"\n",(0,t.jsx)(n.p,{children:"Since the image store is ephemeral by nature, most features and safeties provided by typical CSI implementations (for example, replication or snapshotting features) aren't required in this context.\nIndeed, due to the complexity and overhead associated with these drivers, they may be detrimental.\nFor best results, choose a CSI provider focused on efficient handling of short-lived volumes."}),"\n",(0,t.jsxs)(n.p,{children:["To use a specific CSI driver only for the image stores, manually configure the appropriate ",(0,t.jsx)(n.code,{children:"storageClassName"})," in the ",(0,t.jsx)(n.code,{children:"volumeClaimTemplate"})," as shown above."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},28453(e,n,s){s.d(n,{R:()=>o,x:()=>a});var i=s(96540);const t={},r=i.createContext(t);function o(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);