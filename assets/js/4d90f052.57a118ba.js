"use strict";(globalThis.webpackChunkcontrast_docs=globalThis.webpackChunkcontrast_docs||[]).push([[63847],{87458(e,n,s){s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"howto/debugshell","title":"Advanced debugging","description":"Enabling debug shell access","source":"@site/docs/howto/debugshell.md","sourceDirName":"howto","slug":"/howto/debugshell","permalink":"/contrast/next/howto/debugshell","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/contrast/edit/main/docs/docs/howto/debugshell.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Troubleshooting","permalink":"/contrast/next/howto/troubleshooting"},"next":{"title":"Security","permalink":"/contrast/next/security"}}');var o=s(74848),l=s(28453);const a={},i="Advanced debugging",d={},c=[{value:"Enabling debug shell access",id:"enabling-debug-shell-access",level:2},{value:"Collecting pod VM logs",id:"collecting-pod-vm-logs",level:2},{value:"Accessing the pod VM via debug shell",id:"accessing-the-pod-vm-via-debug-shell",level:2}];function r(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",p:"p",pre:"pre",...(0,l.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"advanced-debugging",children:"Advanced debugging"})}),"\n",(0,o.jsx)(n.h2,{id:"enabling-debug-shell-access",children:"Enabling debug shell access"}),"\n",(0,o.jsx)(n.p,{children:"In some cases, additional information from within a pod VM is necessary to diagnose issues.\nTo facilitate this, the Contrast pod VM can be configured for debugging via initdata that's passed to the guest.\nServices in the guest will then enable an SSH based debug service that can be accessed from within the pod sandbox."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Debug shell architecture",src:s(9812).A+""})}),"\n",(0,o.jsxs)(n.p,{children:["To enable debug shell access, add the ",(0,o.jsx)(n.code,{children:"insecure-enable-debug-shell-access"})," flag when generating annotations:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"contrast generate --insecure-enable-debug-shell-access\n"})}),"\n",(0,o.jsx)(n.admonition,{type:"danger",children:(0,o.jsx)(n.p,{children:"Enabling debug access is inherently insecure.\nNever use this option on production workloads or with sensitive data involved."})}),"\n",(0,o.jsx)(n.p,{children:"This will add an additional field to the initdata passed to the guest, instructing the guest components to enable debug shell access:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-toml",children:"[data]\n'contrast.insecure-debug' = 'true'\n"})}),"\n",(0,o.jsxs)(n.p,{children:["It will also inject an additional ",(0,o.jsx)(n.code,{children:"debug-shell"})," container into pods with a ",(0,o.jsx)(n.code,{children:"contrast-cc"})," runtime class, which can be used as access point into the pod VM and can help to collect debug information."]}),"\n",(0,o.jsx)(n.p,{children:"Notice that enabling debug features via initdata is covered by the measurements of a pod VM and thus detectable via remote attestation."}),"\n",(0,o.jsx)(n.h2,{id:"collecting-pod-vm-logs",children:"Collecting pod VM logs"}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"debug-shell"})," container exposes the journal logs of the pod VM into Kubernetes pod logs by default.\nThese logs can then be collected via standard Kubernetes tooling:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"kubectl logs <pod-name> -c debug-shell\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Ensure the ",(0,o.jsx)(n.code,{children:"settings.json"})," used for generate includes the following settings so that access to the pod logs are allowed (which is the case in the default settings generated by Contrast):"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n    ...\n    "request_defaults": {\n        ...\n        "ReadStreamRequest": true,\n'})}),"\n",(0,o.jsx)(n.h2,{id:"accessing-the-pod-vm-via-debug-shell",children:"Accessing the pod VM via debug shell"}),"\n",(0,o.jsxs)(n.p,{children:["Ensure the ",(0,o.jsx)(n.code,{children:"settings.json"})," used for generate includes the following settings to allow interactive exec in Contrast pods:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n    ...\n    "request_defaults": {\n        ...\n        "ExecProcessRequest": {\n            "allowed_commands": [],\n            "regex": [ ".*" ]\n        },\n        ...\n        "ReadStreamRequest": true,\n        ...\n        "WriteStreamRequest": true\n'})}),"\n",(0,o.jsxs)(n.p,{children:["Run ",(0,o.jsx)(n.code,{children:"contrast generate"})," again to include eventually updated settings in the initdata."]}),"\n",(0,o.jsx)(n.p,{children:"Deploy the changed resources, then execute the following the get a shell within the pod VM:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"kubectl exec -it <pod-name> -c debug-shell -- debugshell\n"})}),"\n",(0,o.jsx)(n.p,{children:"You should see something like the following output:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"Warning: Permanently added '[localhost]:2222' (RSA) to the list of known hosts.\n\n[root@nixos:/]#\n"})})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(r,{...e})}):r(e)}},9812(e,n,s){s.d(n,{A:()=>t});const t=s.p+"assets/images/debugshell.drawio-24907f8e4183aa288b93042fceae45a2.svg"},28453(e,n,s){s.d(n,{R:()=>a,x:()=>i});var t=s(96540);const o={},l=t.createContext(o);function a(e){const n=t.useContext(l);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(l.Provider,{value:n},e.children)}}}]);