From 55176b158d2fe2b58c82d6ece687b77d816f0cdf Mon Sep 17 00:00:00 2001
From: Markus Rudy <mr@edgeless.systems>
Date: Fri, 13 Sep 2024 10:33:30 +0200
Subject: [PATCH 15/15] agent: bump image-rs version

The oci-distribution crate was recently renamed to oci-client, and new
releases are only published for oci-client. image-rs needed to migrate
to oci-client to include a security fix. This commit updates image-rs to
a ref after the oci-client migration.

Signed-off-by: Markus Rudy <mr@edgeless.systems>
---
 src/agent/Cargo.lock | 186 ++++++++++++++++++++-----------------------
 src/agent/Cargo.toml |   4 +-
 2 files changed, 89 insertions(+), 101 deletions(-)

diff --git a/src/agent/Cargo.lock b/src/agent/Cargo.lock
index f7a96e0b7..d5aaf3e7a 100644
--- a/src/agent/Cargo.lock
+++ b/src/agent/Cargo.lock
@@ -175,9 +175,9 @@ dependencies = [
 
 [[package]]
 name = "async-compression"
-version = "0.4.11"
+version = "0.4.12"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "cd066d0b4ef8ecb03a55319dc13aa6910616d0f44008a045bb1835af830abff5"
+checksum = "fec134f64e2bc57411226dfc4e52dec859ddfc7e711fc5e07b612584f000e4aa"
 dependencies = [
  "flate2",
  "futures-core",
@@ -185,8 +185,8 @@ dependencies = [
  "memchr",
  "pin-project-lite",
  "tokio",
- "zstd 0.13.2",
- "zstd-safe 7.2.0",
+ "zstd",
+ "zstd-safe",
 ]
 
 [[package]]
@@ -380,9 +380,9 @@ checksum = "8b75356056920673b02621b35afd0f7dda9306d03c79a30f5c56c44cf256e3de"
 
 [[package]]
 name = "async-trait"
-version = "0.1.81"
+version = "0.1.82"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "6e0c28dcc82d7c8ead5cb13beb15405b57b8546e93215673ff8ca0349a028107"
+checksum = "a27b8a3a6e1a44fa4c8baf1f653e4172e81486d4941f2237e20dc2d0cf4ddff1"
 dependencies = [
  "proc-macro2",
  "quote",
@@ -398,11 +398,11 @@ checksum = "1505bd5d3d116872e7271a6d4e16d81d0c8570876c8de68093a09ac269d8aac0"
 [[package]]
 name = "attester"
 version = "0.1.0"
-source = "git+https://github.com/confidential-containers/guest-components?rev=51e967045296570abb4ad8bef215e92323306ed4#51e967045296570abb4ad8bef215e92323306ed4"
+source = "git+https://github.com/confidential-containers/guest-components?rev=e3c3fefd4caabd2c614cb5f5bca574863aae400e#e3c3fefd4caabd2c614cb5f5bca574863aae400e"
 dependencies = [
  "anyhow",
  "async-trait",
- "base64 0.21.7",
+ "base64 0.22.1",
  "hex",
  "kbs-types",
  "log",
@@ -410,7 +410,7 @@ dependencies = [
  "serde_json",
  "serde_with",
  "sha2",
- "strum 0.25.0",
+ "strum",
  "thiserror",
 ]
 
@@ -1169,11 +1169,11 @@ checksum = "7a81dae078cea95a014a339291cec439d2f232ebe854a9d672b796c6afafa9b7"
 [[package]]
 name = "crypto"
 version = "0.1.0"
-source = "git+https://github.com/confidential-containers/guest-components?rev=51e967045296570abb4ad8bef215e92323306ed4#51e967045296570abb4ad8bef215e92323306ed4"
+source = "git+https://github.com/confidential-containers/guest-components?rev=e3c3fefd4caabd2c614cb5f5bca574863aae400e#e3c3fefd4caabd2c614cb5f5bca574863aae400e"
 dependencies = [
  "aes-gcm",
  "anyhow",
- "base64 0.21.7",
+ "base64 0.22.1",
  "ctr",
  "kbs-types",
  "rand",
@@ -1181,7 +1181,7 @@ dependencies = [
  "serde",
  "serde_json",
  "sha2",
- "strum 0.25.0",
+ "strum",
  "zeroize",
 ]
 
@@ -2496,12 +2496,12 @@ dependencies = [
 [[package]]
 name = "image-rs"
 version = "0.1.0"
-source = "git+https://github.com/confidential-containers/guest-components?rev=51e967045296570abb4ad8bef215e92323306ed4#51e967045296570abb4ad8bef215e92323306ed4"
+source = "git+https://github.com/confidential-containers/guest-components?rev=e3c3fefd4caabd2c614cb5f5bca574863aae400e#e3c3fefd4caabd2c614cb5f5bca574863aae400e"
 dependencies = [
  "anyhow",
  "async-compression",
  "async-trait",
- "base64 0.21.7",
+ "base64 0.22.1",
  "cfg-if 1.0.0",
  "filetime",
  "flate2",
@@ -2514,10 +2514,10 @@ dependencies = [
  "log",
  "loopdev",
  "nix 0.28.0",
- "oci-distribution",
+ "oci-client",
  "oci-spec",
  "ocicrypt-rs",
- "protobuf 3.5.0",
+ "protobuf 3.5.1",
  "reqwest",
  "sequoia-openpgp",
  "serde",
@@ -2525,15 +2525,16 @@ dependencies = [
  "serde_yaml",
  "sha2",
  "sigstore",
- "strum 0.25.0",
- "strum_macros 0.26.4",
+ "strum",
+ "strum_macros",
  "tokio",
  "tokio-util 0.7.11",
  "ttrpc",
  "ttrpc-codegen",
  "url",
  "walkdir",
- "zstd 0.12.4",
+ "xattr 1.3.1",
+ "zstd",
 ]
 
 [[package]]
@@ -2838,7 +2839,7 @@ dependencies = [
  "opentelemetry",
  "procfs 0.12.0",
  "prometheus",
- "protobuf 3.5.0",
+ "protobuf 3.5.1",
  "protocols",
  "regex",
  "regorus",
@@ -2858,8 +2859,8 @@ dependencies = [
  "slog-scope",
  "slog-stdlog",
  "slog-term",
- "strum 0.26.3",
- "strum_macros 0.26.4",
+ "strum",
+ "strum_macros",
  "tempfile",
  "test-utils",
  "thiserror",
@@ -2931,27 +2932,27 @@ dependencies = [
 [[package]]
 name = "kbc"
 version = "0.1.0"
-source = "git+https://github.com/confidential-containers/guest-components?rev=51e967045296570abb4ad8bef215e92323306ed4#51e967045296570abb4ad8bef215e92323306ed4"
+source = "git+https://github.com/confidential-containers/guest-components?rev=e3c3fefd4caabd2c614cb5f5bca574863aae400e#e3c3fefd4caabd2c614cb5f5bca574863aae400e"
 dependencies = [
  "anyhow",
  "async-trait",
- "base64 0.21.7",
+ "base64 0.22.1",
  "crypto",
  "kbs_protocol",
  "log",
  "resource_uri",
  "serde",
  "serde_json",
- "strum 0.25.0",
+ "strum",
  "url",
  "zeroize",
 ]
 
 [[package]]
 name = "kbs-types"
-version = "0.6.0"
+version = "0.7.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "febd73b2b1df274ea454d81ddf76f596af9754410b7ed6f988f2e1782a175da3"
+checksum = "9b6441ed73b0faa50707d4de41c6b45c76654b661b96aaf7b26a41331eedc0a5"
 dependencies = [
  "serde",
  "serde_json",
@@ -2960,12 +2961,12 @@ dependencies = [
 [[package]]
 name = "kbs_protocol"
 version = "0.1.0"
-source = "git+https://github.com/confidential-containers/guest-components?rev=51e967045296570abb4ad8bef215e92323306ed4#51e967045296570abb4ad8bef215e92323306ed4"
+source = "git+https://github.com/confidential-containers/guest-components?rev=e3c3fefd4caabd2c614cb5f5bca574863aae400e#e3c3fefd4caabd2c614cb5f5bca574863aae400e"
 dependencies = [
  "anyhow",
  "async-trait",
  "attester",
- "base64 0.21.7",
+ "base64 0.22.1",
  "crypto",
  "jwt-simple",
  "kbs-types",
@@ -3333,13 +3334,14 @@ dependencies = [
 
 [[package]]
 name = "mio"
-version = "0.8.11"
+version = "1.0.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "a4a650543ca06a924e8b371db273b2756685faae30f8487da1b56505a8f78b0c"
+checksum = "80e04d1dcff3aae0704555fe5fee3bcfaf3d1fdf8a7e521d5b9d2b42acb52cec"
 dependencies = [
+ "hermit-abi 0.3.9",
  "libc",
  "wasi",
- "windows-sys 0.48.0",
+ "windows-sys 0.52.0",
 ]
 
 [[package]]
@@ -3669,6 +3671,31 @@ dependencies = [
  "memchr",
 ]
 
+[[package]]
+name = "oci-client"
+version = "0.12.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "0f5098b86f972ac3484f7c9011bbbbd64aaa7e21d10d2c1a91fefb4ad0ba2ad9"
+dependencies = [
+ "bytes 1.6.1",
+ "chrono",
+ "futures-util",
+ "http",
+ "http-auth",
+ "jwt",
+ "lazy_static",
+ "olpc-cjson",
+ "regex",
+ "reqwest",
+ "serde",
+ "serde_json",
+ "sha2",
+ "thiserror",
+ "tokio",
+ "tracing",
+ "unicase",
+]
+
 [[package]]
 name = "oci-distribution"
 version = "0.11.0"
@@ -3706,20 +3733,20 @@ dependencies = [
  "regex",
  "serde",
  "serde_json",
- "strum 0.26.3",
- "strum_macros 0.26.4",
+ "strum",
+ "strum_macros",
  "thiserror",
 ]
 
 [[package]]
 name = "ocicrypt-rs"
 version = "0.1.0"
-source = "git+https://github.com/confidential-containers/guest-components?rev=51e967045296570abb4ad8bef215e92323306ed4#51e967045296570abb4ad8bef215e92323306ed4"
+source = "git+https://github.com/confidential-containers/guest-components?rev=e3c3fefd4caabd2c614cb5f5bca574863aae400e#e3c3fefd4caabd2c614cb5f5bca574863aae400e"
 dependencies = [
  "aes",
  "anyhow",
  "async-trait",
- "base64 0.21.7",
+ "base64 0.22.1",
  "base64-serde",
  "cfg-if 1.0.0",
  "ctr",
@@ -3727,7 +3754,7 @@ dependencies = [
  "kbc",
  "lazy_static",
  "pin-project-lite",
- "protobuf 3.5.0",
+ "protobuf 3.5.1",
  "ring",
  "serde",
  "serde_json",
@@ -4333,9 +4360,9 @@ checksum = "106dd99e98437432fed6519dedecfade6a06a73bb7b2a1e019fdd2bee5778d94"
 
 [[package]]
 name = "protobuf"
-version = "3.5.0"
+version = "3.5.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "df67496db1a89596beaced1579212e9b7c53c22dca1d9745de00ead76573d514"
+checksum = "0bcc343da15609eaecd65f8aa76df8dc4209d325131d8219358c0aaaebab0bf6"
 dependencies = [
  "once_cell",
  "protobuf-support",
@@ -4353,13 +4380,13 @@ dependencies = [
 
 [[package]]
 name = "protobuf-codegen"
-version = "3.5.0"
+version = "3.5.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "eab09155fad2d39333d3796f67845d43e29b266eea74f7bc93f153f707f126dc"
+checksum = "c4d0cde5642ea4df842b13eb9f59ea6fafa26dcb43e3e1ee49120e9757556189"
 dependencies = [
  "anyhow",
  "once_cell",
- "protobuf 3.5.0",
+ "protobuf 3.5.1",
  "protobuf-parse",
  "regex",
  "tempfile",
@@ -4368,14 +4395,14 @@ dependencies = [
 
 [[package]]
 name = "protobuf-parse"
-version = "3.5.0"
+version = "3.5.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "1a16027030d4ec33e423385f73bb559821827e9ec18c50e7874e4d6de5a4e96f"
+checksum = "1b0e9b447d099ae2c4993c0cbb03c7a9d6c937b17f2d56cfc0b1550e6fcfdb76"
 dependencies = [
  "anyhow",
  "indexmap 2.2.6",
  "log",
- "protobuf 3.5.0",
+ "protobuf 3.5.1",
  "protobuf-support",
  "tempfile",
  "thiserror",
@@ -4384,9 +4411,9 @@ dependencies = [
 
 [[package]]
 name = "protobuf-support"
-version = "3.5.0"
+version = "3.5.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "70e2d30ab1878b2e72d1e2fc23ff5517799c9929e2cf81a8516f9f4dcf2b9cf3"
+checksum = "f0766e3675a627c327e4b3964582594b0e8741305d628a98a5de75a1d15f99b9"
 dependencies = [
  "thiserror",
 ]
@@ -4398,7 +4425,7 @@ dependencies = [
  "async-trait",
  "kata-sys-util",
  "oci-spec",
- "protobuf 3.5.0",
+ "protobuf 3.5.1",
  "serde",
  "serde_json",
  "ttrpc",
@@ -4725,7 +4752,7 @@ dependencies = [
 [[package]]
 name = "resource_uri"
 version = "0.1.0"
-source = "git+https://github.com/confidential-containers/guest-components?rev=51e967045296570abb4ad8bef215e92323306ed4#51e967045296570abb4ad8bef215e92323306ed4"
+source = "git+https://github.com/confidential-containers/guest-components?rev=e3c3fefd4caabd2c614cb5f5bca574863aae400e#e3c3fefd4caabd2c614cb5f5bca574863aae400e"
 dependencies = [
  "anyhow",
  "serde",
@@ -4965,7 +4992,7 @@ dependencies = [
  "nix 0.24.3",
  "oci-spec",
  "path-absolutize",
- "protobuf 3.5.0",
+ "protobuf 3.5.1",
  "protocols",
  "regex",
  "rlimit",
@@ -5680,32 +5707,13 @@ version = "0.11.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "7da8b5736845d9f2fcb837ea5d9e2628564b3b043a70948a3f0b778838c5fb4f"
 
-[[package]]
-name = "strum"
-version = "0.25.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "290d54ea6f91c969195bdbcd7442c8c2a2ba87da8bf60a7ee86a235d4bc1e125"
-dependencies = [
- "strum_macros 0.25.3",
-]
-
 [[package]]
 name = "strum"
 version = "0.26.3"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "8fec0f0aef304996cf250b31b5a10dee7980c85da9d759361292b8bca5a18f06"
-
-[[package]]
-name = "strum_macros"
-version = "0.25.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "23dc1fa9ac9c169a78ba62f0b841814b7abae11bdd047b9c58f893439e309ea0"
 dependencies = [
- "heck 0.4.1",
- "proc-macro2",
- "quote",
- "rustversion",
- "syn 2.0.71",
+ "strum_macros",
 ]
 
 [[package]]
@@ -5991,28 +5999,27 @@ dependencies = [
 
 [[package]]
 name = "tokio"
-version = "1.38.0"
+version = "1.40.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ba4f4a02a7a80d6f274636f0aa95c7e383b912d41fe721a31f29e29698585a4a"
+checksum = "e2b070231665d27ad9ec9b8df639893f46727666c6767db40317fbe920a5d998"
 dependencies = [
  "backtrace",
  "bytes 1.6.1",
  "libc",
  "mio",
- "num_cpus",
  "parking_lot 0.12.3",
  "pin-project-lite",
  "signal-hook-registry",
  "socket2 0.5.7",
  "tokio-macros",
- "windows-sys 0.48.0",
+ "windows-sys 0.52.0",
 ]
 
 [[package]]
 name = "tokio-macros"
-version = "2.3.0"
+version = "2.4.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "5f5ae998a069d4b5aba8ee9dad856af7d520c3699e6159b185c2acd48155d39a"
+checksum = "693d596312e88961bc67d7f1f97af8a70227d9f90c31bba5806eec004978d752"
 dependencies = [
  "proc-macro2",
  "quote",
@@ -6266,8 +6273,8 @@ dependencies = [
  "libc",
  "log",
  "nix 0.26.4",
- "protobuf 3.5.0",
- "protobuf-codegen 3.5.0",
+ "protobuf 3.5.1",
+ "protobuf-codegen 3.5.1",
  "thiserror",
  "tokio",
  "tokio-vsock 0.4.0",
@@ -6281,7 +6288,7 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "94d7f7631d7a9ebed715a47cd4cb6072cbc7ae1d4ec01598971bbec0024340c2"
 dependencies = [
  "protobuf 2.28.0",
- "protobuf-codegen 3.5.0",
+ "protobuf-codegen 3.5.1",
  "protobuf-support",
  "ttrpc-compiler",
 ]
@@ -7174,32 +7181,13 @@ dependencies = [
  "syn 2.0.71",
 ]
 
-[[package]]
-name = "zstd"
-version = "0.12.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "1a27595e173641171fc74a1232b7b1c7a7cb6e18222c11e9dfb9888fa424c53c"
-dependencies = [
- "zstd-safe 6.0.6",
-]
-
 [[package]]
 name = "zstd"
 version = "0.13.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "fcf2b778a664581e31e389454a7072dab1647606d44f7feea22cd5abb9c9f3f9"
 dependencies = [
- "zstd-safe 7.2.0",
-]
-
-[[package]]
-name = "zstd-safe"
-version = "6.0.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ee98ffd0b48ee95e6c5168188e44a54550b1564d9d530ee21d5f0eaed1069581"
-dependencies = [
- "libc",
- "zstd-sys",
+ "zstd-safe",
 ]
 
 [[package]]
diff --git a/src/agent/Cargo.toml b/src/agent/Cargo.toml
index 4b9a0ed48..005c551cc 100644
--- a/src/agent/Cargo.toml
+++ b/src/agent/Cargo.toml
@@ -30,7 +30,7 @@ safe-path = { path = "../libs/safe-path" }
 const_format = "0.2.30"
 
 # Async helpers
-async-trait = "0.1.42"
+async-trait = "0.1.82"
 async-recursion = "0.3.2"
 futures = "0.3.30"
 
@@ -77,7 +77,7 @@ strum = "0.26.2"
 strum_macros = "0.26.2"
 
 # Image pull/decrypt
-image-rs = { git = "https://github.com/confidential-containers/guest-components", rev = "51e967045296570abb4ad8bef215e92323306ed4", default-features = false, optional = true }
+image-rs = { git = "https://github.com/confidential-containers/guest-components", rev = "e3c3fefd4caabd2c614cb5f5bca574863aae400e", default-features = false, optional = true }
 
 # Agent Policy
 regorus = { version = "0.1.4", default-features = false, features = [
-- 
2.46.1

