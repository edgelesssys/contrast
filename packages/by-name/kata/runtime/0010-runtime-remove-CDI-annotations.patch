From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Moritz Sanft <58110325+msanft@users.noreply.github.com>
Date: Fri, 7 Feb 2025 13:12:28 +0100
Subject: [PATCH] runtime: remove CDI annotations

We want to remove CDI annotations before they get to the agent, as they should only influence VM creation. Passing them to the agent is likely to create problems in policy checking, as they are often dynamically injected.

Signed-off-by: Markus Rudy <mr@edgeless.systems>
Signed-off-by: Charlotte Hartmann Paludo <git@charlotteharludo.com>
---
 src/runtime/virtcontainers/kata_agent.go | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/src/runtime/virtcontainers/kata_agent.go b/src/runtime/virtcontainers/kata_agent.go
index a81fcb347620f61646edf09aee3bfeaeee9f7965..0c23a12b39e255563dd054aa286a1c2631b87caa 100644
--- a/src/runtime/virtcontainers/kata_agent.go
+++ b/src/runtime/virtcontainers/kata_agent.go
@@ -1066,6 +1066,18 @@ func (k *kataAgent) constrainGRPCSpec(grpcSpec *grpc.Spec, passSeccomp bool, dis
 			linuxDevices = append(linuxDevices, dev)
 		}
 		grpcSpec.Linux.Devices = linuxDevices
+
+		// Same goes for CDI annotations for the host.
+		for k := range grpcSpec.Annotations {
+			if !strings.HasPrefix(k, "cdi.k8s.io/") {
+				continue
+			}
+			if strings.HasPrefix(k, "cdi.k8s.io/vfio") {
+				// TODO(burgerdev): this hard-coded exception comes from siblingAnnotation in src/runtime/virtcontainers/container.go
+				continue
+			}
+			delete(grpcSpec.Annotations, k)
+		}
 	}
 
 	return nil
