From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Markus Rudy <mr@edgeless.systems>
Date: Mon, 30 Jun 2025 11:18:47 +0200
Subject: [PATCH] genpolicy: don't allow mount/storage for declared VOLUMEs

Signed-off-by: Markus Rudy <mr@edgeless.systems>
---
 src/tools/genpolicy/genpolicy-settings.json  | 12 ------
 src/tools/genpolicy/src/mount_and_storage.rs | 43 --------------------
 src/tools/genpolicy/src/settings.rs          |  1 -
 src/tools/genpolicy/src/yaml.rs              | 14 ++++---
 4 files changed, 8 insertions(+), 62 deletions(-)

diff --git a/src/tools/genpolicy/genpolicy-settings.json b/src/tools/genpolicy/genpolicy-settings.json
index 76ad6bed30c81e131ed637ed1f4e87cf03813d12..88171e1c40f271be9468c6c8b9b87c871a55c1f9 100644
--- a/src/tools/genpolicy/genpolicy-settings.json
+++ b/src/tools/genpolicy/genpolicy-settings.json
@@ -183,18 +183,6 @@
                 "rprivate",
                 "ro"
             ]
-        },
-        "image_volume": {
-            "mount_type": "bind",
-            "mount_source": "$(sfprefix)",
-            "driver": "local",
-            "source": "local",
-            "fstype": "bind",
-            "options": [
-                "rbind",
-                "rprivate",
-                "rw"
-            ]
         }
     },
     "device_annotations": {
diff --git a/src/tools/genpolicy/src/mount_and_storage.rs b/src/tools/genpolicy/src/mount_and_storage.rs
index 5f7127351670b850113a362b601f5dfbb4462cff..3186617e07b59e498c5baec763da253fedbe00aa 100644
--- a/src/tools/genpolicy/src/mount_and_storage.rs
+++ b/src/tools/genpolicy/src/mount_and_storage.rs
@@ -387,46 +387,3 @@ fn get_downward_api_mount(yaml_mount: &pod::VolumeMount, p_mounts: &mut Vec<poli
         });
     }
 }
-
-pub fn get_image_mount_and_storage(
-    settings: &settings::Settings,
-    p_mounts: &mut Vec<policy::KataMount>,
-    destination: &str,
-) {
-    // https://github.com/kubernetes/examples/blob/master/cassandra/image/Dockerfile
-    // has a volume mount starting with two '/' characters:
-    //
-    // CASSANDRA_DATA=/cassandra_data
-    // VOLUME ["/$CASSANDRA_DATA"]
-    let mut destination_string = destination.to_string();
-    while destination_string.contains("//") {
-        destination_string = destination_string.replace("//", "/");
-    }
-    debug!("get_image_mount_and_storage: image dest = {destination}, dest = {destination_string}");
-
-    for mount in &mut *p_mounts {
-        if mount.destination == destination_string {
-            debug!(
-                "get_image_mount_and_storage: mount {destination_string} already defined by YAML"
-            );
-            return;
-        }
-    }
-
-    let settings_image = &settings.volumes.image_volume;
-    debug!(
-        "get_image_mount_and_storage: settings for container image volumes: {:?}",
-        settings_image
-    );
-
-    let file_name = Path::new(&destination_string).file_name().unwrap();
-    let name = OsString::from(file_name).into_string().unwrap();
-    let source = format!("{}{name}$", &settings_image.mount_source);
-
-    p_mounts.push(policy::KataMount {
-        destination: destination_string,
-        type_: settings_image.fstype.clone(),
-        source,
-        options: settings_image.options.clone(),
-    });
-}
diff --git a/src/tools/genpolicy/src/settings.rs b/src/tools/genpolicy/src/settings.rs
index 65e1b82857282618cfb0719ef3fe9bd87760d333..21a02a483499a68513a6b86db042631d37c4d9db 100644
--- a/src/tools/genpolicy/src/settings.rs
+++ b/src/tools/genpolicy/src/settings.rs
@@ -34,7 +34,6 @@ pub struct Volumes {
     pub emptyDir: EmptyDirVolume,
     pub emptyDir_memory: EmptyDirVolume,
     pub configMap: ConfigMapVolume,
-    pub image_volume: ImageVolume,
 }
 
 /// EmptyDir volume settings loaded from genpolicy-settings.json.
diff --git a/src/tools/genpolicy/src/yaml.rs b/src/tools/genpolicy/src/yaml.rs
index a53a4bb9abae414fb5eb47e179aca7ad9f6f7b8f..55ac5afdf809297213414394e15183d63b45c8f4 100644
--- a/src/tools/genpolicy/src/yaml.rs
+++ b/src/tools/genpolicy/src/yaml.rs
@@ -27,6 +27,7 @@ use crate::utils::Config;
 use async_trait::async_trait;
 use core::fmt::Debug;
 use kata_types::annotations::KATA_ANNO_CFG_HYPERVISOR_INIT_DATA;
+use std::collections::BTreeSet;
 use log::debug;
 use protocols::agent;
 use serde::{Deserialize, Serialize};
@@ -293,6 +294,7 @@ pub fn get_container_mounts_and_storages(
     settings: &settings::Settings,
     podSpec: &pod::PodSpec,
 ) {
+    let mut mountPaths = BTreeSet::new();
     if let Some(volumes) = &podSpec.volumes {
         if let Some(volume_mounts) = &container.volumeMounts {
             for volume in volumes {
@@ -306,19 +308,19 @@ pub fn get_container_mounts_and_storages(
                             volume_mount,
                             &podSpec.securityContext,
                         );
+                        mountPaths.insert(volume_mount.mountPath.clone());
                     }
                 }
             }
         }
     }
 
-    // Add storage and mount for each volume defined in the docker container image
-    // configuration layer.
+    // Check that all VOLUME declarations have corresponding volume mounts.
     if let Some(volumes) = &container.registry.config_layer.config.Volumes {
-        for volume in volumes {
-            debug!("get_container_mounts_and_storages: {:?}", &volume);
-
-            mount_and_storage::get_image_mount_and_storage(settings, policy_mounts, volume.0);
+        let volumePaths: BTreeSet<_> = volumes.keys().cloned().collect();
+        let uncoveredPaths: Vec<String> = volumePaths.difference(&mountPaths).cloned().collect();
+        if uncoveredPaths.len() > 0 {
+            panic!("The following volumes declared in image config don't have corresponding Kubernetes mounts: {uncoveredPaths:?}");
         }
     }
     if settings.cluster_config.guest_pull {
