From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Markus Rudy <mr@edgeless.systems>
Date: Mon, 30 Jun 2025 11:18:47 +0200
Subject: [PATCH] genpolicy: don't allow mount/storage for declared VOLUMEs

Signed-off-by: Markus Rudy <mr@edgeless.systems>
---
 src/tools/genpolicy/genpolicy-settings.json  | 12 ------
 src/tools/genpolicy/src/mount_and_storage.rs | 43 --------------------
 src/tools/genpolicy/src/settings.rs          |  1 -
 src/tools/genpolicy/src/yaml.rs              | 14 ++++---
 4 files changed, 8 insertions(+), 62 deletions(-)

diff --git a/src/tools/genpolicy/genpolicy-settings.json b/src/tools/genpolicy/genpolicy-settings.json
index 2dbc8160413d54116e581a7566020ea2fcbc62e3..5861b483e0b3c910ce82fe72b8384f965ef06c85 100644
--- a/src/tools/genpolicy/genpolicy-settings.json
+++ b/src/tools/genpolicy/genpolicy-settings.json
@@ -183,18 +183,6 @@
                 "rprivate",
                 "ro"
             ]
-        },
-        "image_volume": {
-            "mount_type": "bind",
-            "mount_source": "$(sfprefix)",
-            "driver": "local",
-            "source": "local",
-            "fstype": "bind",
-            "options": [
-                "rbind",
-                "rprivate",
-                "rw"
-            ]
         }
     },
     "mount_destinations": [
diff --git a/src/tools/genpolicy/src/mount_and_storage.rs b/src/tools/genpolicy/src/mount_and_storage.rs
index 20ebd36e247a7268d7eea36b84a2ca38f80871af..a029c8bf0ce702871d70c07a254f40b675d35268 100644
--- a/src/tools/genpolicy/src/mount_and_storage.rs
+++ b/src/tools/genpolicy/src/mount_and_storage.rs
@@ -370,46 +370,3 @@ fn get_downward_api_mount(yaml_mount: &pod::VolumeMount, p_mounts: &mut Vec<poli
         });
     }
 }
-
-pub fn get_image_mount_and_storage(
-    settings: &settings::Settings,
-    p_mounts: &mut Vec<policy::KataMount>,
-    destination: &str,
-) {
-    // https://github.com/kubernetes/examples/blob/master/cassandra/image/Dockerfile
-    // has a volume mount starting with two '/' characters:
-    //
-    // CASSANDRA_DATA=/cassandra_data
-    // VOLUME ["/$CASSANDRA_DATA"]
-    let mut destination_string = destination.to_string();
-    while destination_string.contains("//") {
-        destination_string = destination_string.replace("//", "/");
-    }
-    debug!("get_image_mount_and_storage: image dest = {destination}, dest = {destination_string}");
-
-    for mount in &mut *p_mounts {
-        if mount.destination == destination_string {
-            debug!(
-                "get_image_mount_and_storage: mount {destination_string} already defined by YAML"
-            );
-            return;
-        }
-    }
-
-    let settings_image = &settings.volumes.image_volume;
-    debug!(
-        "get_image_mount_and_storage: settings for container image volumes: {:?}",
-        settings_image
-    );
-
-    let file_name = Path::new(&destination_string).file_name().unwrap();
-    let name = OsString::from(file_name).into_string().unwrap();
-    let source = format!("{}{name}$", &settings_image.mount_source);
-
-    p_mounts.push(policy::KataMount {
-        destination: destination_string,
-        type_: settings_image.fstype.clone(),
-        source,
-        options: settings_image.options.clone(),
-    });
-}
diff --git a/src/tools/genpolicy/src/settings.rs b/src/tools/genpolicy/src/settings.rs
index e3bab1e9b6d63b036221818ab5f24fa6b5c3d81c..e78e4b593d9a3eab051539d065940204fa195d1a 100644
--- a/src/tools/genpolicy/src/settings.rs
+++ b/src/tools/genpolicy/src/settings.rs
@@ -33,7 +33,6 @@ pub struct Volumes {
     pub emptyDir: EmptyDirVolume,
     pub emptyDir_memory: EmptyDirVolume,
     pub configMap: ConfigMapVolume,
-    pub image_volume: ImageVolume,
 }
 
 /// EmptyDir volume settings loaded from genpolicy-settings.json.
diff --git a/src/tools/genpolicy/src/yaml.rs b/src/tools/genpolicy/src/yaml.rs
index c640694c22404b8501f843dfc3dcfb2ee7bd5c6d..25b67abec217316e22b337f5dfcae88f3b345034 100644
--- a/src/tools/genpolicy/src/yaml.rs
+++ b/src/tools/genpolicy/src/yaml.rs
@@ -28,6 +28,7 @@ use crate::volume;
 use async_trait::async_trait;
 use core::fmt::Debug;
 use kata_types::annotations::KATA_ANNO_CFG_HYPERVISOR_INIT_DATA;
+use std::collections::BTreeSet;
 use log::debug;
 use protocols::agent;
 use serde::{Deserialize, Serialize};
@@ -294,6 +295,7 @@ pub fn get_container_mounts_and_storages(
     settings: &settings::Settings,
     volumes_option: &Option<Vec<volume::Volume>>,
 ) {
+    let mut mountPaths = BTreeSet::new();
     if let Some(volumes) = volumes_option {
         if let Some(volume_mounts) = &container.volumeMounts {
             for volume in volumes {
@@ -306,19 +308,19 @@ pub fn get_container_mounts_and_storages(
                             volume,
                             volume_mount,
                         );
+                        mountPaths.insert(volume_mount.mountPath.clone());
                     }
                 }
             }
         }
     }
 
-    // Add storage and mount for each volume defined in the docker container image
-    // configuration layer.
+    // Check that all VOLUME declarations have corresponding volume mounts.
     if let Some(volumes) = &container.registry.config_layer.config.Volumes {
-        for volume in volumes {
-            debug!("get_container_mounts_and_storages: {:?}", &volume);
-
-            mount_and_storage::get_image_mount_and_storage(settings, policy_mounts, volume.0);
+        let volumePaths: BTreeSet<_> = volumes.keys().cloned().collect();
+        let uncoveredPaths: Vec<String> = volumePaths.difference(&mountPaths).cloned().collect();
+        if uncoveredPaths.len() > 0 {
+            panic!("The following volumes declared in image config don't have corresponding Kubernetes mounts: {uncoveredPaths:?}");
         }
     }
     if settings.cluster_config.guest_pull {
