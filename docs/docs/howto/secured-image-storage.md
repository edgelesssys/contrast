# Contrast secured image storage

In order to reduce memory requirements, Contrast supports mounting an [ephemeral volume](https://kubernetes.io/docs/concepts/storage/ephemeral-volumes/) into each pod-VM.
Before first use, the underlying block device issued by Kubernetes is LUKS-encrypted and integrity protected with keys generated inside the pod-VM.
These keys are never persisted or transferred outside of the pod-VM, meaning the volume is only usable from within the specific pod it's attached to, and only for the duration of that pod's lifetime.

## Configuration

By default, each pod receives a block device with a size of `10Gi`.
Should the sum of the uncompressed container image sizes exceed this amount, the size of the device can be increased on a per-pod level through an annotation:

```yaml
metadata:
  annotations:
    contrast.edgeless.systems/secure-image-storage-size: 250Gi
```

To disable this feature for a specific pod, set the value of this annotation to `0`:

```yaml
metadata:
  annotations:
    contrast.edgeless.systems/secure-image-storage-size: 0
```

To disable Contrast secure mount globally, specify the `--skip-secure-image-storage` flag in the `generate` command.

:::note

If the Contrast secure mount feature is disabled, container images are pulled and uncompressed into encrypted memory.
Memory limits must be adjusted accordingly.
See [Pod resources](../../howto/workload-deployment/deployment-file-preparation#pod-resources) for details.

:::

:::warning

Currently, it's not possible to detect a [specific replay attack](https://github.com/confidential-containers/confidential-containers/issues/123#issuecomment-1644397221) by the host system wherein the host replaces the contents of the encrypted block device by a previously captured snapshot of the disk.
Since the snapshot consists purely of ciphertext generated by the pod-VM, it reads as correctly integrity-protected and the pod-VM can't distinguish it from fresh data.

Importantly, this **doesn't** allow a malicious host to decrypt the ciphertext stored on the device or to inject arbitrary data.

The trade-off between reduced resource requirements and a weakened security posture must be evaluated on a per-use-case basis.

:::
