<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-1.12 docs-doc-page docs-doc-id-howto/vault" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Vault | Contrast</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.edgeless.systems/contrast/howto/vault"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="1.12"><meta data-rh="true" name="docusaurus_tag" content="docs-default-1.12"><meta data-rh="true" name="docsearch:version" content="1.12"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-1.12"><meta data-rh="true" property="og:title" content="Vault | Contrast"><meta data-rh="true" name="description" content="This how-to guides you through deploying Vault as a confidential deployment, using Contrast&#x27;s built-in Vault support."><meta data-rh="true" property="og:description" content="This how-to guides you through deploying Vault as a confidential deployment, using Contrast&#x27;s built-in Vault support."><link data-rh="true" rel="icon" href="/contrast/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.edgeless.systems/contrast/howto/vault"><link data-rh="true" rel="alternate" href="https://docs.edgeless.systems/contrast/howto/vault" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.edgeless.systems/contrast/howto/vault" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Vault","item":"https://docs.edgeless.systems/contrast/howto/vault"}]}</script><script src="/contrast/gtagman.js" async data-cookieconsent="ignore"></script><link rel="stylesheet" href="/contrast/assets/css/styles.fceb5906.css">
<script src="/contrast/assets/js/runtime~main.8a3df8a5.js" defer="defer"></script>
<script src="/contrast/assets/js/main.4e240f9b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard" data-theme="light">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="theme-announcement-bar announcementBar_mb4j" style="background-color:#E7E6E6" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">Contrast is now open source! Check it out on <a target="_blank" rel="noopener noreferrer" href="https://github.com/edgelesssys/contrast">GitHub</a> and leave us a ⭐️ if you like it!</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/contrast/"><div class="navbar__logo"><img src="/contrast/img/logos/contrast_icon.svg" alt="Contrast Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/contrast/img/logos/contrast_icon.svg" alt="Contrast Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/contrast/howto/vault">1.12</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/contrast/next/howto/vault">Next</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/contrast/howto/vault">1.12</a></li><li><a class="dropdown__link" href="/contrast/1.11/howto/vault">1.11</a></li><li><a class="dropdown__link" href="/contrast/1.10">1.10</a></li><li><a class="dropdown__link" href="/contrast/1.9">1.9</a></li><li><a class="dropdown__link" href="/contrast/1.8">1.8</a></li><li><a class="dropdown__link" href="/contrast/1.7">1.7</a></li><li><a class="dropdown__link" href="/contrast/1.6">1.6</a></li><li><a class="dropdown__link" href="/contrast/1.5">1.5</a></li><li><a class="dropdown__link" href="/contrast/1.4">1.4</a></li><li><a class="dropdown__link" href="/contrast/1.3">1.3</a></li></ul></div><a href="https://github.com/edgelesssys/contrast" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="navbarSearchContainer_Bca1"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-1.12"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/contrast/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/contrast/getting-started/overview">Getting started</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/getting-started/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/getting-started/deployment">Workload deployment</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/contrast/howto/cluster-setup/bare-metal">How-to</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/contrast/howto/cluster-setup/bare-metal">Cluster setup</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/howto/install-cli">Install CLI</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/contrast/howto/workload-deployment/runtime-deployment">Workload deployment</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/howto/encrypted-storage">Set up encrypted volumes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/howto/hardening">Hardening</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/howto/logging">Logging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/howto/observability">Observability</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/howto/manifest-update">Manifest update</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/howto/coordinator-ha">Coordinator high-availability</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/contrast/howto/vault">Vault</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/howto/troubleshooting">Troubleshooting</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/contrast/security">Security</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/contrast/architecture/overview">Architecture</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/contrast/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">How-to</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Vault</span></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 1.12</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Vault</h1></header>
<p>This how-to guides you through deploying Vault as a confidential deployment, using Contrast&#x27;s built-in Vault support.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="applicability">Applicability<a href="#applicability" class="hash-link" aria-label="Direct link to Applicability" title="Direct link to Applicability">​</a></h2>
<p>Confidential applications often need access to cryptographic keys and other secrets.
Contrast has built-in support for operating Hashicorp Vault / OpenBao, which can be used to setup a key management service for your applications.
While this how-to uses an OpenBao server, the setup for Hashicorp Vault is very similar.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h2>
<ol>
<li><a href="/contrast/howto/cluster-setup/aks">Set up cluster</a></li>
<li><a href="/contrast/howto/install-cli">Install CLI</a></li>
<li><a href="/contrast/howto/workload-deployment/runtime-deployment">Deploy the Contrast runtime</a></li>
<li>Install the <code>bao</code> CLI (see <a href="https://openbao.org/docs/install/" target="_blank" rel="noopener noreferrer">OpenBao installation instructions</a>)</li>
<li>A domain name that resolves to the Vault service IP.
For testing purposes, you can use an entry in <code>/etc/hosts</code> instead.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to">How-to<a href="#how-to" class="hash-link" aria-label="Direct link to How-to" title="Direct link to How-to">​</a></h2>
<p>The following sections explain how to add a Vault to your Contrast deployment, how to configure automatic unsealing and how to use Contrast certificates for authentication.
Refer to the <a href="/contrast/architecture/secrets#transit-secrets-engine">secrets page</a> for more information on Contrast&#x27;s transit engine API.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="download-the-deployment-files">Download the deployment files<a href="#download-the-deployment-files" class="hash-link" aria-label="Direct link to Download the deployment files" title="Direct link to Download the deployment files">​</a></h3>
<p>The Contrast release includes a demo resource definition for a Vault server.
This section dives into some details of the resources and outlines how it&#x27;s integrated with Contrast.
You can download the demo app by running:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-fLO</span><span class="token plain"> https://github.com/edgelesssys/contrast/releases/download/v1.12.0/vault-demo.yml --create-dirs --output-dir resources</span><br></span></code></pre></div></div>
<p>The Vault deployment is defined as a <code>StatefulSet</code> using an OpenBao image, with a mounted block device for persistent storage.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> StatefulSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">contrast.edgeless.systems/secure-pv</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">share</span><br></span></code></pre></div></div>
<p>The Contrast Initializer, running as an init container, uses the workload secret located at <code>/contrast/secrets/workload-secret-seed</code> to generate an encryption key and initialize the block device <code>state</code> as a LUKS-encrypted partition.
Before the Vault container starts, the Initializer opens the LUKS device using the generated key.
This unlocked device is then mounted by the Vault container and used as the backend storage volume <code>share</code>.
For the Vault application, this process is entirely transparent, and the device behaves like a standard volume mount.</p>
<p>The LUKS encryption of the block device is primarily a convenience feature, enabling persistent storage at the filesystem level on confidential virtual machines.
The primary and security-relevant encryption mechanism remains Vault’s own sealing process, which provides cryptographic protection of secrets even if the underlying storage is compromised.</p>
<p>Because the <code>workload-secret-seed</code> is derived from the associated <code>workloadSecretID</code>, any change to the <code>workloadSecretID</code> after the block device has been initialized will result in a different key, making the mounted block device undecryptable.
Therefore, it&#x27;s critical to ensure that the <code>workloadSecretID</code> is correctly aligned with the intended endpoint specified in Vault’s unsealing configuration before the first <code>contrast set</code> is executed.
In this example, the <code>workloadSecretID</code> is set to <code>vault_unsealing</code> with an annotation:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">contrast.edgeless.systems/workload-secret-id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault_unsealing</span><br></span></code></pre></div></div>
<p>Vault&#x27;s TCP listener is configured to use the certificate provisioned by the initializer.
Below is the relevant excerpt from the configuration file.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">listener &quot;tcp&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  address            = &quot;0.0.0.0:8200&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tls_cert_file      = &quot;/contrast/tls-config/certChain.pem&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tls_key_file       = &quot;/contrast/tls-config/key.pem&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The Vault configuration file would ideally just be mounted from the <code>ConfigMap</code> into the server pod.
However, this would be insecure, as the Vault configuration is sensitive but mounts aren&#x27;t integrity-checked (see <a href="/contrast/howto/hardening#limitations-inherent-to-policy-checking">Hardening</a>).
Therefore, the demo pod adds the configuration as an environment variable and extracts it to a memory-backed file before starting the server.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-vault">Deploy Vault<a href="#deploy-vault" class="hash-link" aria-label="Direct link to Deploy Vault" title="Direct link to Deploy Vault">​</a></h3>
<p>Follow the steps of the generic workload deployment instructions:</p>
<ul>
<li><a href="/contrast/howto/workload-deployment/add-coordinator">Add the Coordinator.</a></li>
<li><a href="/contrast/howto/workload-deployment/generate-annotations">Generate the policies.</a>
<ul>
<li>After running <code>contrast generate</code>, add the desired Vault domain name to the <code>SANs</code> array in <code>manifest.json</code>.</li>
</ul>
</li>
<li><a href="/contrast/howto/workload-deployment/deploy-application">Apply the resources.</a></li>
<li><a href="/contrast/howto/workload-deployment/set-manifest">Set the manifest.</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configure-dns">Configure DNS<a href="#configure-dns" class="hash-link" aria-label="Direct link to Configure DNS" title="Direct link to Configure DNS">​</a></h3>
<p>The <code>bao</code> CLI, as well as the <code>vault</code> CLI, need to be configured with an HTTPS endpoint, and that endpoint needs to match the certificate that Vault is presenting.
By default, the manifest only contains the Subject Alternative Name (SAN) <code>vault</code>.</p>
<p>First, you need to know the public IP of the Vault service, which you can print with the following command:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> vault </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">jsonpath</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;{.status.loadBalancer.ingress[0].ip}&#x27;</span><br></span></code></pre></div></div>
<p>If you added SANs in the previous step, these will also be included in the certificate.
In that case, you can configure your DNS service to resolve the additional SAN to the load balancer IP.</p>
<p>Alternatively, configure the system from which you access Vault to resolve <code>vault</code> to the load balancer IP.
On Linux, you can modify <code>/etc/hosts</code> for this.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="initialize-vault">Initialize Vault<a href="#initialize-vault" class="hash-link" aria-label="Direct link to Initialize Vault" title="Direct link to Initialize Vault">​</a></h3>
<p>A Vault instance needs to be initialized once before it can be used.
Initialization is a sensitive operation that transfers key material, and should thus be executed on a secure system, by a trusted operator and over a secure channel.
For this demo, the machine hosting your Contrast workspace is sufficient.
Initialize the Vault with the <code>bao</code> CLI from within your workspace, using the Coordinator CA as a root of trust:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">VAULT_ADDR</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://</span><span class="token variable" style="color:#36acaa">${YOUR_VAULT_DOMAIN}</span><span class="token plain">:8200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">VAULT_CACERT</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">./coordinator-root-ca.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bao operator init </span><span class="token parameter variable" style="color:#36acaa">-format</span><span class="token plain"> json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> vault_secrets.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">VAULT_TOKEN</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">jq </span><span class="token variable parameter variable" style="color:#36acaa">-r</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&#x27;.root_token&#x27;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">&lt;</span><span class="token variable" style="color:#36acaa"> vault_secrets.json</span><span class="token variable" style="color:#36acaa">)</span><br></span></code></pre></div></div>
<p>Upon successful initialization, this prints a root token and some recovery key shares and also writes them to the file <code>vault_secrets.json</code>.
These are highly sensitive secrets and need to be guarded carefully!
The last command makes the Vault root token available to the <code>bao</code> CLI, allowing you to configure Vault in the next section.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configure-vault">Configure Vault<a href="#configure-vault" class="hash-link" aria-label="Direct link to Configure Vault" title="Direct link to Configure Vault">​</a></h3>
<p>Vault can be configured to use Contrast certificates for authorization.
The following commands enable <a href="https://developer.hashicorp.com/vault/docs/auth/cert" target="_blank" rel="noopener noreferrer">certificate authentication</a> and assign a policy <code>contrast</code> to workloads with Contrast certificates.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bao auth </span><span class="token builtin class-name">enable</span><span class="token plain"> cert</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bao </span><span class="token function" style="color:#d73a49">write</span><span class="token plain"> auth/cert/certs/coordinator </span><span class="token assign-left variable" style="color:#36acaa">display_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">coordinator </span><span class="token assign-left variable" style="color:#36acaa">policies</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">contrast </span><span class="token assign-left variable" style="color:#36acaa">certificate</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">@./mesh-ca.pem</span><br></span></code></pre></div></div>
<p>For this demo, we&#x27;re going to activate the KV secrets engine, write a demo secret and add the <code>contrast</code> policy that allows Contrast workloads to access it.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bao secrets </span><span class="token builtin class-name">enable</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-version</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> kv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bao kv put kv/my-secret my-value</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">s3cr3t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bao policy </span><span class="token function" style="color:#d73a49">write</span><span class="token plain"> contrast - </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">path &quot;kv/*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre></div></div>
<p>The demo includes a simple deployment - <code>vault-client</code> - that attempts to authenticate to Vault with its Contrast certificate and then tries to read a secret.
After running the above commands, the pod should become ready and show the secret content in its log output.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="restart-vault-with-auto-unsealing">Restart Vault with auto-unsealing<a href="#restart-vault-with-auto-unsealing" class="hash-link" aria-label="Direct link to Restart Vault with auto-unsealing" title="Direct link to Restart Vault with auto-unsealing">​</a></h3>
<p>When a Vault pod is restarted, it must unseal its encrypted state. The sealing key isn&#x27;t present in the restarted pod, but can be retrieved from the Coordinator&#x27;s transit engine API after the Coordinator has attested the restarted pod.</p>
<p>To configure Vault to use the Coordinator&#x27;s transit engine API for automatic unsealing, the following configuration is used in the demo deployment, which is part of the &quot;vault-config&quot; config map.
Note that the <code>key_name</code> needs to be equal to the <code>workloadSecretID</code> of Vault.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">seal &quot;transit&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  address         = &quot;https://coordinator:8200&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  disable_renewal = &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key_name        = &quot;vault_unsealing&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mount_path      = &quot;transit/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tls_ca_cert     = &quot;/contrast/tls-config/mesh-ca.pem&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tls_client_cert = &quot;/contrast/tls-config/certChain.pem&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tls_client_key  = &quot;/contrast/tls-config/key.pem&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>This configuration instructs Vault to unseal itself with key material obtained from the Coordinator.
To see this process in action, you can trigger a restart of your Vault pod:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart statefulset/vault</span><br></span></code></pre></div></div>
<p>When a new Vault pod starts, it runs the Contrast Initializer as part of its startup sequence.
The Initializer receives the same workload secret as before, allowing it to derive the correct encryption key and unlock the existing LUKS-encrypted block device.
This process ensures that the Vault backend can reattach the previously encrypted volume and access all stored data transparently.
However, while this step enables access to the filesystem-level storage, it doesn&#x27;t unlock access to the actual secrets.
When the main Vault container starts, it finds the sealed data on the volume and begins the unsealing process.</p>
<p>You can verify that the auto-unsealing process completed successful by inspecting the logs of the Vault pod, or by running</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bao status</span><br></span></code></pre></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/edgelesssys/contrast/edit/main/docs/versioned_docs/version-1.12/howto/vault.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/contrast/howto/coordinator-ha"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Coordinator high-availability</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/contrast/howto/troubleshooting"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Troubleshooting</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#applicability" class="table-of-contents__link toc-highlight">Applicability</a></li><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#how-to" class="table-of-contents__link toc-highlight">How-to</a><ul><li><a href="#download-the-deployment-files" class="table-of-contents__link toc-highlight">Download the deployment files</a></li><li><a href="#deploy-vault" class="table-of-contents__link toc-highlight">Deploy Vault</a></li><li><a href="#configure-dns" class="table-of-contents__link toc-highlight">Configure DNS</a></li><li><a href="#initialize-vault" class="table-of-contents__link toc-highlight">Initialize Vault</a></li><li><a href="#configure-vault" class="table-of-contents__link toc-highlight">Configure Vault</a></li><li><a href="#restart-vault-with-auto-unsealing" class="table-of-contents__link toc-highlight">Restart Vault with auto-unsealing</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.edgeless.systems/#footer-id" target="_blank" rel="noopener noreferrer" class="footer__link-item">Newsletter<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.edgeless.systems/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://twitter.com/EdgelessSystems" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/company/edgeless-systems/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCOOInN0sCv6icUesisYIDeA" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Company</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.edgeless.systems/imprint/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Imprint<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.edgeless.systems/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="javascript: Cookiebot.renew()" class="footer__link-item">Cookie Settings</a></li><li class="footer__item"><a href="https://www.edgeless.systems/contact-us/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contact Us<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Edgeless Systems</div></div></div></footer></div>
</body>
</html>