<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-howto/vault" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Vault | Contrast</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.edgeless.systems/contrast/next/howto/vault"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Vault | Contrast"><meta data-rh="true" name="description" content="This tutorial guides you through deploying a Vault as a confidential deployment by using Contrast&#x27;s built-in Vault support."><meta data-rh="true" property="og:description" content="This tutorial guides you through deploying a Vault as a confidential deployment by using Contrast&#x27;s built-in Vault support."><link data-rh="true" rel="icon" href="/contrast/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.edgeless.systems/contrast/next/howto/vault"><link data-rh="true" rel="alternate" href="https://docs.edgeless.systems/contrast/next/howto/vault" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.edgeless.systems/contrast/next/howto/vault" hreflang="x-default"><script src="/contrast/gtagman.js" async data-cookieconsent="ignore"></script><link rel="stylesheet" href="/contrast/assets/css/styles.92cb9a97.css">
<script src="/contrast/assets/js/runtime~main.dd120d66.js" defer="defer"></script>
<script src="/contrast/assets/js/main.5148d0dd.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#E7E6E6" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">Contrast is now open source! Check it out on <a target="_blank" rel="noopener noreferrer" href="https://github.com/edgelesssys/contrast">GitHub</a> and leave us a ⭐️ if you like it!</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/contrast/"><div class="navbar__logo"><img src="/contrast/img/logos/contrast_icon.svg" alt="Contrast Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/contrast/img/logos/contrast_icon.svg" alt="Contrast Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/contrast/next/howto/vault">Next</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/contrast/next/howto/vault">Next</a></li><li><a class="dropdown__link" href="/contrast/">1.10</a></li><li><a class="dropdown__link" href="/contrast/1.9">1.9</a></li><li><a class="dropdown__link" href="/contrast/1.8">1.8</a></li><li><a class="dropdown__link" href="/contrast/1.7">1.7</a></li><li><a class="dropdown__link" href="/contrast/1.6">1.6</a></li><li><a class="dropdown__link" href="/contrast/1.5">1.5</a></li><li><a class="dropdown__link" href="/contrast/1.4">1.4</a></li><li><a class="dropdown__link" href="/contrast/1.3">1.3</a></li></ul></div><a href="https://github.com/edgelesssys/contrast" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="navbarSearchContainer_Bca1"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/contrast/next">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/contrast/next/getting-started/overview">Getting started</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/next/getting-started/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/next/getting-started/deployment">Workload deployment</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/contrast/next/howto/cluster-setup/bare-metal">How-to</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/contrast/next/howto/cluster-setup/bare-metal">Cluster setup</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/next/howto/install-cli">Install CLI</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/contrast/next/howto/workload-deployment/runtime-deployment">Workload deployment</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/next/howto/encrypted-storage">Set up encrypted volumes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/next/howto/hardening">Hardening</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/next/howto/logging">Logging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/next/howto/observability">Observability</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/next/howto/manifest-update">Manifest update</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/next/howto/coordinator-ha">Coordinator high-availability</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/contrast/next/howto/vault">Vault</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contrast/next/howto/troubleshooting">Troubleshooting</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/contrast/next/security">Security</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/contrast/next/architecture/overview">Architecture</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for <!-- -->Contrast<!-- --> <b>Next</b> version.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/contrast/">latest version</a></b> (<!-- -->1.10<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/contrast/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">How-to</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Vault</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: Next</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Vault</h1></header>
<p><strong>This tutorial guides you through deploying a Vault as a confidential deployment by using Contrast&#x27;s built-in Vault support.</strong></p>
<p>Vaults are an identity-based secrets and encryption management systems, which provide encryption services that are gated by authentication and authorization methods to ensure secure, auditable and restricted access to secrets, such as API keys, passwords, encryption keys or certificates.</p>
<p>There are several implementations of Vault systems, the most prominent being <a href="https://www.hashicorp.com/en/products/vault" target="_blank" rel="noopener noreferrer">HashiCorp Vault</a> and its open-source derivative, <a href="https://openbao.org/" target="_blank" rel="noopener noreferrer">OpenBao</a>. This example utilizes the Vault image provided by OpenBao.
The associated APIs exposed by the Contrast coordinator are fully compatible with both HashiCorp Vault and OpenBao, ensuring interoperability across implementations.</p>
<p>Contrast can lift a Vault deployment into a confidential computing environment, further shielding the secrets from the workload operator.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sealing-and-unsealing-of-vaults">Sealing and Unsealing of Vaults<a href="#sealing-and-unsealing-of-vaults" class="hash-link" aria-label="Direct link to Sealing and Unsealing of Vaults" title="Direct link to Sealing and Unsealing of Vaults">​</a></h2>
<p><a href="https://openbao.org/docs/concepts/seal/" target="_blank" rel="noopener noreferrer">Sealing</a> ensures that all sensitive data within the Vault remains inaccessible and protected when the system isn&#x27;t in active use.
It provides a security boundary that prevents unauthorized access during restarts or shutdowns.</p>
<p>Unsealing is a manual process required to transition Vault into an operational state, allowing authorized access to stored secrets.
Vault implementations by default use a set of unseal keys derived from a master key, building up on <code>Shamir&#x27;s Secret Sharing</code> scheme.
Further to auto-unseal Vaults, the process can be delegated to another already initialized Vault by using an exposed <a href="https://openbao.org/api-docs/secret/transit/" target="_blank" rel="noopener noreferrer">transit secrets engine API</a> as the unsealing mechanism.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="transit-secrets-engine-api-of-contrast-coordinator">Transit secrets engine API of Contrast Coordinator<a href="#transit-secrets-engine-api-of-contrast-coordinator" class="hash-link" aria-label="Direct link to Transit secrets engine API of Contrast Coordinator" title="Direct link to Transit secrets engine API of Contrast Coordinator">​</a></h2>
<p>To automate the unsealing process in confidential deployments of Vault instances, the coordinator exposes a compatible transit secrets engine API on port 8200.
Vault deployments can be configured to integrate this transit engine to enable auto-unsealing, ensuring immediate operational readiness and seamless integration within the secure Contrast environment.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="secure-endpoints-with-mutual-tls">Secure endpoints with mutual TLS<a href="#secure-endpoints-with-mutual-tls" class="hash-link" aria-label="Direct link to Secure endpoints with mutual TLS" title="Direct link to Secure endpoints with mutual TLS">​</a></h3>
<p>All communication between the transit secrets engine API and Vault is secured through mutual TLS (mTLS).
Only entities presenting a <a href="/contrast/next/architecture/components/service-mesh#public-key-infrastructure">mesh certificate</a> signed by the current mesh CA key are trusted.
The Coordinator issues itself a valid certificate at the time of the transit secrets engine API call, while the Vault deployment obtains its certificate in the initialization phase, after attesting to the Coordinator.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="role-of-workloadsecretid">Role of <code>workloadSecretID</code><a href="#role-of-workloadsecretid" class="hash-link" aria-label="Direct link to role-of-workloadsecretid" title="Direct link to role-of-workloadsecretid">​</a></h3>
<p>To support persistence in the auto-unsealing process, the <code>workloadSecretID</code> is used to derive the encryption key utilized by the transit secrets engine.
Beyond key derivation, the <code>workloadSecretID</code> also plays a critical role in authorization.</p>
<p>Access to a specific encryption key via the transit secrets engine API is permitted only if the requested key name matches the <code>workloadSecretID</code> embedded in the corresponding certificate extension of the Contrast mesh certificate.
This ensures that each entity can only access their own set of encryption keys within the transit secrets engine.</p>
<p>For more details on how the workload secret is used, see <a href="/contrast/next/architecture/secrets#workload-secrets">Workload Secrets</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h2>
<ul>
<li>Installed Contrast CLI</li>
<li>A running Kubernetes cluster with support for confidential containers, either on <a href="/contrast/next/howto/cluster-setup/aks">AKS</a> or on <a href="/contrast/next/howto/cluster-setup/bare-metal">bare metal</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="steps-to-deploy-vault-with-contrast">Steps to deploy Vault with Contrast<a href="#steps-to-deploy-vault-with-contrast" class="hash-link" aria-label="Direct link to Steps to deploy Vault with Contrast" title="Direct link to Steps to deploy Vault with Contrast">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="download-the-deployment-files">Download the deployment files<a href="#download-the-deployment-files" class="hash-link" aria-label="Direct link to Download the deployment files" title="Direct link to Download the deployment files">​</a></h3>
<p>The Vault deployment files are part of the Contrast release. You can download them by running:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-fLO</span><span class="token plain"> https://github.com/edgelesssys/contrast/releases/latest/download/vault-demo.yml --create-dirs --output-dir deployment</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-the-contrast-runtime">Deploy the Contrast runtime<a href="#deploy-the-contrast-runtime" class="hash-link" aria-label="Direct link to Deploy the Contrast runtime" title="Direct link to Deploy the Contrast runtime">​</a></h3>
<p>Contrast depends on a <a href="/contrast/next/architecture/components/runtime">custom Kubernetes <code>RuntimeClass</code></a>, which needs to be installed to the cluster initially.
This consists of a <code>RuntimeClass</code> resource and a <code>DaemonSet</code> that performs installation on worker nodes.
This step is only required once for each version of the runtime.
It can be shared between Contrast deployments.</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">AKS</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Bare metal (SEV-SNP)</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Bare metal (TDX)</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> https://github.com/edgelesssys/contrast/releases/latest/download/runtime-aks-clh-snp.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> https://github.com/edgelesssys/contrast/releases/latest/download/runtime-k3s-qemu-snp.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> https://github.com/edgelesssys/contrast/releases/latest/download/runtime-k3s-qemu-tdx.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="download-the-contrast-coordinator-resource">Download the Contrast Coordinator resource<a href="#download-the-contrast-coordinator-resource" class="hash-link" aria-label="Direct link to Download the Contrast Coordinator resource" title="Direct link to Download the Contrast Coordinator resource">​</a></h3>
<p>Download the Kubernetes resource of the Contrast Coordinator, comprising a single replica deployment and a LoadBalancer service.
Put it next to your resources:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-fLO</span><span class="token plain"> https://github.com/edgelesssys/contrast/releases/latest/download/coordinator.yml --output-dir deployment</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="generate-policy-annotations-and-manifest">Generate policy annotations and manifest<a href="#generate-policy-annotations-and-manifest" class="hash-link" aria-label="Direct link to Generate policy annotations and manifest" title="Direct link to Generate policy annotations and manifest">​</a></h3>
<p>Run the <code>generate</code> command to generate the execution policies and add them as annotations to your deployment files.
A <code>manifest.json</code> file with the reference values of your deployment will be created:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">AKS</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Bare metal (SEV-SNP)</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Bare metal (TDX)</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">contrast generate --reference-values aks-clh-snp deployment/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">contrast generate --reference-values k3s-qemu-snp deployment/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Missing TCB values</div><div class="admonitionContent_BuS1"><p>On bare-metal SEV-SNP, <code>contrast generate</code> is unable to fill in the <code>MinimumTCB</code> values as they can vary between platforms.
They will have to be filled in manually.
If you don&#x27;t know the correct values use <code>{&quot;BootloaderVersion&quot;:255,&quot;TEEVersion&quot;:255,&quot;SNPVersion&quot;:255,&quot;MicrocodeVersion&quot;:255}</code> and observe the real values in the error messages in the following steps.
This should only be done in a secure environment.
Note that the values will differ between CPU models.</p></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">contrast generate --reference-values k3s-qemu-tdx deployment/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Missing TCB values</div><div class="admonitionContent_BuS1"><p>On bare-metal TDX, <code>contrast generate</code> is unable to fill in the <code>MinimumTeeTcbSvn</code> and <code>MrSeam</code> TCB values as they can vary between platforms.
They will have to be filled in manually.
If you don&#x27;t know the correct values use <code>ffffffffffffffffffffffffffffffff</code> and <code>000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</code> respectively and observe the real values in the error messages in the following steps.
This should only be done in a secure environment.</p></div></div></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Runtime class and Initializer</div><div class="admonitionContent_BuS1"><p>The deployment YAML shipped for this demo is already configured to be used with Contrast.
A <a href="/contrast/next/architecture/components/runtime">runtime class</a> <code>contrast-cc</code> was added to the pods to signal they should be run as Confidential Containers.
During the generation process, the Contrast <a href="/contrast/next/architecture/components/initializer">Initializer</a> will be added as an init container to these workloads.
It will attest the pod to the Coordinator and fetch the workload certificates and the workload secret.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-the-coordinator">Deploy the Coordinator<a href="#deploy-the-coordinator" class="hash-link" aria-label="Direct link to Deploy the Coordinator" title="Direct link to Deploy the Coordinator">​</a></h3>
<p>Deploy the Coordinator resource first by applying its resource definition:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> deployment/coordinator.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="set-the-manifest">Set the manifest<a href="#set-the-manifest" class="hash-link" aria-label="Direct link to Set the manifest" title="Direct link to Set the manifest">​</a></h3>
<p>Configure the Coordinator with a manifest.
It might take up to a few minutes for the load balancer to be created and the Coordinator being available.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">coordinator</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get svc coordinator </span><span class="token variable parameter variable" style="color:#36acaa">-o</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">jsonpath</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">&#x27;{.status.loadBalancer.ingress[0].ip}&#x27;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;The user API of your Contrast Coordinator is available at </span><span class="token string variable" style="color:#36acaa">$coordinator</span><span class="token string" style="color:#e3116c">:1313&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contrast </span><span class="token builtin class-name">set</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${coordinator}</span><span class="token string" style="color:#e3116c">:1313&quot;</span><span class="token plain"> deployment/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The CLI will use the reference values from the manifest to attest the Coordinator deployment during the TLS handshake.
If the connection succeeds, it&#x27;s ensured that the Coordinator deployment hasn&#x27;t been tampered with.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-vault">Deploy Vault<a href="#deploy-vault" class="hash-link" aria-label="Direct link to Deploy Vault" title="Direct link to Deploy Vault">​</a></h3>
<p>Now that the Coordinator has a manifest set, which defines the Vault deployment as an allowed workload, we can deploy the application:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> deployment/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The Vault deployment is defined as a StatefulSet using the OpenBao Vault image, with a mounted block device for persistent storage.
A Contrast Initializer, running as an init container, uses the workload secret located at <code>/contrast/secrets/workload-secret-seed</code> to generate an encryption key and initialize the block device as a LUKS-encrypted partition.
Before the Vault container starts, the Initializer opens the LUKS device using the generated key.
This unlocked device is then mounted by the Vault container and used as the backend storage volume.
For the Vault application, this process is entirely transparent, and the device behaves like a standard volume mount.
It’s important to clarify that the LUKS encryption of the block device is primarily a convenience feature, enabling persistent storage at the filesystem level on confidential virtual machines.
The primary and security-relevant encryption mechanism remains Vault’s own sealing process, which provides cryptographic protection of secrets even if the underlying storage is compromised.</p>
<p>Because the <code>workload-secret-seed</code> is derived from the associated <code>workloadSecretID</code>, any change to the <code>workloadSecretID</code> after the block device has been initialized will result in deriving an invalid encryption key, making the mounted block device undecryptable.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Inter-deployment communication</div><div class="admonitionContent_BuS1"><p>The Contrast Coordinator issues mesh certificates after successfully validating workloads.
These certificates can be used for secure inter-deployment communication.
The Initializer sends an attestation report to the Coordinator, retrieves a service mesh certificate bound to it&#x27;s provided public key, containing the certificate chain, as well as the current mesh CA cert.
The Initializer then writes them to a <code>volumeMount</code>, allowing to build up the secure mTLS connections based on the service mesh.
The received service mesh certificate also holds the certificate extension of the <code>workloadSecretID</code>, which is used to allow the authorization to a certain encryption key on the transit engine API.</p></div></div>
<p>The Vault&#x27;s TCP listener is configured to accept connections only from mesh certificates issued under the same CA state used to sign the Vault’s own certificate, effectively restricting communication to attested Contrast deployments.
Because updating the <code>workloadSecretID</code> after initializing the LUKS device will make it inaccessible, it&#x27;s critical to ensure that the <code>workloadSecretID</code> is correctly aligned with the intended endpoint specified in Vault’s sealing configuration before the first <code>contrast set</code> is executed.
This can be achieved by using the corresponding <code>workload-secret-id</code> annotation to directly overwrite the manifest with the required <code>workloadSecretID</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="connecting-to-the-application">Connecting to the application<a href="#connecting-to-the-application" class="hash-link" aria-label="Direct link to Connecting to the application" title="Direct link to Connecting to the application">​</a></h3>
<p>Other confidential containers can securely connect to the Vault server via the <a href="/contrast/next/architecture/components/service-mesh">Service Mesh</a>.
As previously noted, access to the Vault endpoint is restricted to peers that present a service mesh certificate valid under the currently set manifest.
While such a certificate enables mTLS-based communication with the Vault server, it doesn&#x27;t, on its own, grant authorization to perform Vault-related operations.
Permissions for accessing secrets within Vault must be explicitly configured using the root token obtained during Vault initialization.
The configured <code>openbao-client</code> deployment is responsible for executing Vault-related operations, including initialization, secret creation, and sealing instructions.</p>
<p>For more information on the Vault management and administration, please follow the official <a href="https://openbao.org/docs/" target="_blank" rel="noopener noreferrer">OpenBao documentation</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="restarting-the-vault-deployment-with-auto-unsealing">Restarting the Vault deployment with auto-unsealing<a href="#restarting-the-vault-deployment-with-auto-unsealing" class="hash-link" aria-label="Direct link to Restarting the Vault deployment with auto-unsealing" title="Direct link to Restarting the Vault deployment with auto-unsealing">​</a></h3>
<p>If you want to make changes to your resources, ensure that the <code>workloadSecretID</code> of the Vault remains unchanged.
You can restart the Vault using:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart statefulset/vault</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When a new Vault pod starts, it runs the Contrast Initializer as part of its startup sequence.
The Initializer receives the same workload secret as before, allowing it to derive the correct encryption key and unlock the existing LUKS-encrypted block device.
This process ensures that the Vault backend can reattach the previously encrypted volume and access all stored data transparently.
However, while this step enables access to the filesystem-level storage, it doesn&#x27;t unlock access to the actual secrets.
Once Vault has been initialized, subsequent restarts rely on the auto-unsealing process, which is triggered via the transit secrets engine API provided by the Coordinator.</p>
<p>You can verify that the auto-unsealing process completed successful by inspecting the logs of the <code>openbao-server</code> container of the Vault pod:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl logs vault-0 </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> openbao-server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The log entries will indicate that the Vault has transitioned into unsealed state.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/edgelesssys/contrast/edit/main/docs/docs/howto/vault.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/contrast/next/howto/coordinator-ha"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Coordinator high-availability</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/contrast/next/howto/troubleshooting"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Troubleshooting</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#sealing-and-unsealing-of-vaults" class="table-of-contents__link toc-highlight">Sealing and Unsealing of Vaults</a></li><li><a href="#transit-secrets-engine-api-of-contrast-coordinator" class="table-of-contents__link toc-highlight">Transit secrets engine API of Contrast Coordinator</a><ul><li><a href="#secure-endpoints-with-mutual-tls" class="table-of-contents__link toc-highlight">Secure endpoints with mutual TLS</a></li><li><a href="#role-of-workloadsecretid" class="table-of-contents__link toc-highlight">Role of <code>workloadSecretID</code></a></li></ul></li><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#steps-to-deploy-vault-with-contrast" class="table-of-contents__link toc-highlight">Steps to deploy Vault with Contrast</a><ul><li><a href="#download-the-deployment-files" class="table-of-contents__link toc-highlight">Download the deployment files</a></li><li><a href="#deploy-the-contrast-runtime" class="table-of-contents__link toc-highlight">Deploy the Contrast runtime</a></li><li><a href="#download-the-contrast-coordinator-resource" class="table-of-contents__link toc-highlight">Download the Contrast Coordinator resource</a></li><li><a href="#generate-policy-annotations-and-manifest" class="table-of-contents__link toc-highlight">Generate policy annotations and manifest</a></li><li><a href="#deploy-the-coordinator" class="table-of-contents__link toc-highlight">Deploy the Coordinator</a></li><li><a href="#set-the-manifest" class="table-of-contents__link toc-highlight">Set the manifest</a></li><li><a href="#deploy-vault" class="table-of-contents__link toc-highlight">Deploy Vault</a></li><li><a href="#connecting-to-the-application" class="table-of-contents__link toc-highlight">Connecting to the application</a></li><li><a href="#restarting-the-vault-deployment-with-auto-unsealing" class="table-of-contents__link toc-highlight">Restarting the Vault deployment with auto-unsealing</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.edgeless.systems/#footer-id" target="_blank" rel="noopener noreferrer" class="footer__link-item">Newsletter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.edgeless.systems/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/EdgelessSystems" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/company/edgeless-systems/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCOOInN0sCv6icUesisYIDeA" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Company</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.edgeless.systems/imprint/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Imprint<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.edgeless.systems/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="javascript: Cookiebot.renew()" class="footer__link-item">Cookie Settings</a></li><li class="footer__item"><a href="https://www.edgeless.systems/contact-us/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contact Us<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Edgeless Systems</div></div></div></footer></div>
</body>
</html>