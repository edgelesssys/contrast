name: e2e test aks runtime

on:
  workflow_dispatch:
  schedule:
    - cron: "16 6 * * 6" # 6:16 on Saturdays
  pull_request:
    paths:
      - e2e/aks-runtime/**

jobs:
  install-software:
    runs-on: ubuntu-22.04
    steps:
      - name: Install `az` with extensions
        run: |
          sudo apt-get update
          sudo apt-get install apt-transport-https ca-certificates curl gnupg lsb-release
          sudo mkdir -p /etc/apt/keyrings
          curl -sLS https://packages.microsoft.com/keys/microsoft.asc |
          gpg --dearmor | sudo tee /etc/apt/keyrings/microsoft.gpg > /dev/null
          sudo chmod go+r /etc/apt/keyrings/microsoft.gpg
          AZ_DIST=$(lsb_release -cs)
          echo "Types: deb
          URIs: https://packages.microsoft.com/repos/azure-cli/
          Suites: ${AZ_DIST}
          Components: main
          Architectures: $(dpkg --print-architecture)
          Signed-by: /etc/apt/keyrings/microsoft.gpg" | sudo tee /etc/apt/sources.list.d/azure-cli.sources
          sudo apt-get update
          sudo apt-get install azure-cli

          az extension add --name aks-preview
          az extension add --name confcom

  test_matrix:
    name: Test aks runtime
    needs: install-software
    secrets: inherit
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/e2e.yml
    with:
      skip-undeploy: false
      test-name: aks-runtime
      platform: AKS-CLH-SNP
      runner: ubuntu-22.04
      self-hosted: false
      run-without-nix: true
